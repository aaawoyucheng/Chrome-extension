/*! bilibili-helper-master 2016-07-17 */
!function(){function formatInt(a,b){var c="";for(i=1;i<=b-(a+"").length;i++)c+="0";return c+a}function parseSafe(a){return(""+a).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function parseTime(a){return formatInt(parseInt(a/6e4),2)+":"+formatInt(parseInt(a/1e3%60),2)}function inject_css(a,b){var c=document.createElement("style");c.setAttribute("id",a),c.setAttribute("type","text/css"),c.appendChild(document.createTextNode(b)),document.head?document.head.appendChild(c):document.documentElement.appendChild(c)}function disable(){var a=document.getElementById("bilibili_helper");a&&a.parentNode.removeChild(a)}function enable(a){disable(),a&&(inject_css("bilibili_helper",a),"space.bilibili.com"==window.location.hostname&&$('link[type="text/css"]').each(function(a,b){$(b).attr("href").indexOf("space.css")!=-1&&disable()}))}function notifyCidHack(a){parseInt(/Chrome\/([\d\.apre]+)/.exec(window.navigator.userAgent)[1]);biliHelper.cidHack?chrome.extension.sendMessage({command:"cidHack",cid:biliHelper.cid,type:biliHelper.cidHack},function(b){"function"==typeof a&&a()}):"function"==typeof a&&a()}function adMode(a){var b=document.getElementById("bilibili_helper_ad_mode");return b&&b.parentNode.removeChild(b),1==adModeOn?adModeOn=!1:(adModeOn=!0,inject_css("bilibili_helper_ad_mode",a)),adModeOn}function addTitleLink(a,b){return"off"==b?a:a.replace(/(\d+)/g,function(a,c,d,e){for(var f=d;f>=0&&"】"!=e[f];f--)if("【"==e[f])return a;var g=e.substring(0,d)+((parseInt(a)-1>=10||parseInt(a)-1<0?(parseInt(a)-1).toString():"0"+(parseInt(a)-1).toString())+e.substring(d+a.length,e.length)),h=e.substring(0,d)+((parseInt(a)+1>=10||parseInt(a)-1<0?(parseInt(a)+1).toString():"0"+(parseInt(a)+1).toString())+e.substring(d+a.length,e.length));return g=g.replace(/(#)/g," "),h=h.replace(/(#)/g," "),"without"==b&&(g=g.replace(/(\【.*?\】)/g,""),h=h.replace(/(\【.*?\】)/g,"")),'<span class="titleNumber" previous = "'+g+'" next = "'+h+'">'+a+"</span>"})}function intilize_style(a){chrome.extension.sendMessage({command:"getCSS",url:document.URL},function(b){"ok"==b.result&&enable(b.css),"function"==typeof a&&a()})}function getNiceSectionFilename(a,b,c,d,e){var f="av"+a+"_",g=c&&c>1?"p"+b+"_":"",h="",i=e&&e>1?""+d+"_":"";return g&&(h=$(".player-wrapper #plist > span").text(),h=h.substr(h.indexOf("、")+1)+"_"),f+g+h+i+$("div.v-title").text()}function getDownloadOptions(a,b){var c=null,d=a.split(/[\\/]/).pop().split("?")[0],e=d.match(/[.]/)?d.match(/[^.]+$/):"mp4";switch(e){case"letv":e="flv"}return c=filenameSanitize(b,{replacement:"_",max:255-e.length-1})+"."+e,{url:a,filename:c}}if($("html").hasClass("bilibili-helper"))return!1;var adModeOn=!1,biliHelper=new Object;if("www.bilibili.com"==location.hostname)biliHelper.site=0;else{if("bangumi.bilibili.com"!=location.hostname)return!1;biliHelper.site=1}var ff_status={},ff_status_id=0,ff_embed_stack=null,ff_embed_stack_style=null;chrome.extension.onMessage.addListener(function(a,b,c){switch(a.command){case"update":return intilize_style(),c({result:"ok"}),!0;case"checkAdMode":return c({result:"ok",mode:adModeOn}),!0;case"adMode":return c({result:"ok",mode:adMode(a.css)}),!0;case"copyright":return biliHelper.copyright=!0,!0;case"error":return 0==biliHelper.cidHack?(biliHelper.cidHack=1,biliHelper.switcher[biliHelper.switcher.current]()):1==biliHelper.cidHack&&biliHelper.copyright?(biliHelper.cidHack=2,biliHelper.switcher[biliHelper.switcher.current]()):"original"!=biliHelper.switcher.current&&biliHelper.switcher.original(),!0;default:return c({result:"unknown"}),!1}});var finishUp=function(a){chrome.extension.sendMessage({command:"getDownloadLink",cid:biliHelper.cid,cidHack:a||biliHelper.cidHack},function(b){var c=b.download,d=b.playback;if(biliHelper.downloadUrls=[],biliHelper.playbackUrls=[],notifyCidHack(),("error"==c.result||"undefined"==typeof d||"undefined"==typeof d.durl)&&"string"==typeof c.message){if("string"==typeof d.message)return c.message.indexOf("地区")>-1&&(biliHelper.copyright=!0,a||2!=biliHelper.cidHack)?(finishUp(2),!1):(biliHelper.error="错误: "+c.message,!1);c=d}if("undefined"==typeof c.durl.url?biliHelper.downloadUrls=c.durl:biliHelper.downloadUrls.push(c.durl),"undefined"==typeof d.durl||"undefined"==typeof d.durl.url?biliHelper.playbackUrls=d.durl:biliHelper.playbackUrls.push(d.durl),"object"==typeof biliHelper.downloadUrls&&biliHelper.downloadUrls.length){biliHelper.mainBlock.downloaderSection.find("p").empty();for(i in biliHelper.downloadUrls){var e=biliHelper.downloadUrls[i];if("object"==typeof e){var f=getDownloadOptions(e.url,getNiceSectionFilename(biliHelper.avid,biliHelper.page,biliHelper.totalPage,i,biliHelper.downloadUrls.length)),g=$('<a class="b-btn w" rel="noreferrer"></a>').text("分段 "+(parseInt(i)+1)).data("download",f.filename).attr("title",isNaN(parseInt(e.filesize/1048576+.5))?"长度: "+parseTime(e.length):"长度: "+parseTime(e.length)+" 大小: "+parseInt(e.filesize/1048576+.5)+" MB").attr("href",e.url);biliHelper.mainBlock.downloaderSection.find("p").append(g),g.click(function(a){a.preventDefault(),chrome.extension.sendMessage({command:"requestForDownload",url:$(a.target).attr("href"),filename:$(a.target).data("download")})})}}if(biliHelper.downloadUrls.length>1){var h=$('<a class="b-btn"></a>').text("下载全部共 "+biliHelper.downloadUrls.length+" 个分段");biliHelper.mainBlock.downloaderSection.find("p").append(h),h.click(function(a){biliHelper.mainBlock.downloaderSection.find("p .b-btn.w").click()})}}else{var j=biliHelper.error||"视频地址获取失败";biliHelper.mainBlock.downloaderSection.find("p").html("<span></span>"+parseSafe(j))}biliHelper.playbackUrls&&1==biliHelper.playbackUrls.length&&biliHelper.mainBlock.switcherSection.find('a[type="html5"]').removeClass("hidden"),$("#loading-notice").fadeOut(300),biliHelper.favorHTML5&&"force"!=localStorage.getItem("bilimac_player_type")&&biliHelper.cid&&biliHelper.playbackUrls&&1==biliHelper.playbackUrls.length&&biliHelper.playbackUrls[0].url.indexOf("m3u8")<0?$("#loading-notice").fadeOut(300,function(){biliHelper.switcher.html5()}):biliHelper.replacePlayer?$("#loading-notice").fadeOut(300,function(){biliHelper.switcher.swf()}):$("#loading-notice").fadeOut(300,function(){biliHelper.switcher.original()})})},prob=document.createElement("script");prob.id="page-prob",prob.innerHTML="$('.player-wrapper .v-plist').attr('length', window.VideoPart.nodedata.length);$('#page-prob').remove();",document.body.appendChild(prob),intilize_style(),$("html").addClass("bilibili-helper");var bili_reg,urlResult,hashPage;0==biliHelper.site?(bili_reg=/\/video\/av([0-9]+)\/(?:index_([0-9]+)\.html)?.*?$/,urlResult=bili_reg.exec(document.location.pathname),hashPage=/page=([0-9]+)/.exec(document.location.hash),hashPage&&"object"==typeof hashPage&&!isNaN(hashPage[1])&&(hashPage=parseInt(hashPage[1]))):1==biliHelper.site&&(bili_reg=/\/anime\/v\/([0-9]+)$/,urlResult=bili_reg.exec(document.location.pathname)),urlResult&&(biliHelper.avid=urlResult[1],biliHelper.bangumiid=urlResult[1],biliHelper.page=hashPage||urlResult[2],biliHelper.cidHack=0,biliHelper.genPage=!1,biliHelper.videoPic=$("img.cover_image").attr("src"),biliHelper.totalPage=$("#dedepagetitles option").length,"undefined"==typeof biliHelper.page?biliHelper.page=1:biliHelper.page=parseInt(biliHelper.page),biliHelper.pageOffset=0,chrome.extension.sendMessage({command:"init"},function(a){biliHelper.playerConfig=a.playerConfig,biliHelper.version=a.version,biliHelper.favorHTML5="on"==a.html5,biliHelper.replaceEnabled="on"==a.replace,biliHelper.originalPlayer=localStorage.getItem("bilimac_original_player")||$("#bofqi").html(),localStorage.removeItem("bilimac_original_player"),$(".b-page-body").length||(biliHelper.genPage=!0,biliHelper.redirectUrl=decodeURIComponent(__GetCookie("redirectUrl")),biliHelper.redirectUrl&&biliHelper.redirectUrl.indexOf("mimi.gg/")>-1&&(biliHelper.cidHack=2,notifyCidHack())),$(".b-page-body .z-msg").length>0&&$(".b-page-body .z-msg").text().indexOf("版权")>-1&&(biliHelper.genPage=!0,biliHelper.copyright=!0),$("#bofqi div")>0&&$("#bofqi div").text().indexOf("版权")>-1&&(biliHelper.copyright=!0),biliHelper.copyright=!1,biliHelper.switcher={current:"original",set:function(a){biliHelper.mainBlock.switcherSection.find('a.b-btn[type="'+this.current+'"]').addClass("w"),biliHelper.mainBlock.switcherSection.find('a.b-btn[type="'+a+'"]').removeClass("w"),this.current=a},original:function(){this.set("original"),notifyCidHack(function(){$("#bofqi").html(biliHelper.originalPlayer),950==$("#bofqi embed").attr("width")&&$("#bofqi embed").attr("width",980)})},swf:function(){this.set("swf"),notifyCidHack(function(){$("#bofqi").html('<object type="application/x-shockwave-flash" class="player" data="https://static-s.bilibili.com/play.swf" id="player_placeholder" style="visibility: visible;"><param name="allowfullscreeninteractive" value="true"><param name="allowfullscreen" value="true"><param name="quality" value="high"><param name="allowscriptaccess" value="always"><param name="wmode" value="opaque"><param name="flashvars" value="cid='+biliHelper.cid+"&aid="+biliHelper.avid+'"></object>')})},iframe:function(){this.set("iframe"),notifyCidHack(function(){$("#bofqi").html('<iframe height="536" width="980" class="player" src="https://secure.bilibili.com/secure,cid='+biliHelper.cid+"&aid="+biliHelper.avid+'" scrolling="no" border="0" frameborder="no" framespacing="0" onload="window.securePlayerFrameLoaded=true"></iframe>')})},html5:function(){this.set("html5"),$("#bofqi").html('<div id="bilibili_helper_html5_player" class="player"><video id="bilibili_helper_html5_player_video" poster="'+biliHelper.videoPic+'" autobuffer preload="auto" crossorigin="anonymous"><source src="'+biliHelper.playbackUrls[0].url+'" type="video/mp4"></video></div>');var a=ABP.create(document.getElementById("bilibili_helper_html5_player"),{src:{playlist:[{video:document.getElementById("bilibili_helper_html5_player_video"),comments:"http://comment.bilibili.com/"+biliHelper.cid+".xml"}]},width:"100%",height:"100%",config:biliHelper.playerConfig});a.playerUnit.addEventListener("wide",function(){$("#bofqi").addClass("wide")}),a.playerUnit.addEventListener("normal",function(){$("#bofqi").removeClass("wide")}),a.playerUnit.addEventListener("sendcomment",function(b){var c=b.detail.id,d=b.detail;delete b.detail.id,chrome.extension.sendMessage({command:"sendComment",avid:biliHelper.avid,cid:biliHelper.cid,page:biliHelper.page+biliHelper.pageOffset,comment:d},function(b){b.tmp_id=c,a.commentCallback(b)})}),a.playerUnit.addEventListener("saveconfig",function(a){chrome.extension.sendMessage({command:"savePlayerConfig",config:a.detail})});var b=0;$(window).scroll(function(){b!=$("#bofqi").width()&&(b=$("#bofqi").width(),a&&a.cmManager&&a.cmManager.setBounds())})},bilimac:function(){this.set("bilimac"),$("#bofqi").html('<div id="player_placeholder" class="player"></div><div id="loading-notice">正在加载 Bilibili Mac 客户端…</div>'),$("#bofqi").find("#player_placeholder").css({background:"url("+biliHelper.videoPic+") 50% 50% / cover no-repeat","-webkit-filter":"blur(20px)",overflow:"hidden",visibility:"visible"}),$.post("http://localhost:23330/rpc",{action:"playVideoByCID",data:biliHelper.cid+"|"+window.location.href+"|"+document.title+"|"+(2==biliHelper.cidHack?2:1)},function(){$("#bofqi").find("#loading-notice").text("已在 Bilibili Mac 客户端中加载")}).fail(function(){$("#bofqi").find("#loading-notice").text("调用 Bilibili Mac 客户端失败 :(")})}},0==biliHelper.site?(biliHelper.helperBlock=$('<div class="block helper" id="bilibili_helper"><span class="t"><div class="icon"></div><div class="t-right"><span class="t-right-top middle">助手</span><span class="t-right-bottom">扩展菜单</span></div></span><div class="info"><div class="main"></div><div class="version">哔哩哔哩助手 '+biliHelper.version+' by <a href="http://weibo.com/guguke" target="_blank">@啾咕咕www</a><a class="setting b-btn w" href="'+chrome.extension.getURL("options.html")+'" target="_blank">设置</a></div></div></div>'),biliHelper.helperBlock.find(".t").click(function(){biliHelper.helperBlock.toggleClass("active")})):1==biliHelper.site&&(biliHelper.helperBlock=$('<div class="v1-bangumi-info-btn helper" id="bilibili_helper">哔哩哔哩助手<div class="info"><div class="main"></div><div class="version">哔哩哔哩助手 '+biliHelper.version+' by <a href="http://weibo.com/guguke" target="_blank">@啾咕咕www</a><a class="setting b-btn w" href="'+chrome.extension.getURL("options.html")+'" target="_blank">设置</a></div></div></div>'),biliHelper.helperBlock.click(function(){biliHelper.helperBlock.toggleClass("active")}));var b=biliHelper.helperBlock.find(".info");biliHelper.mainBlock=b.find(".main"),biliHelper.mainBlock.infoSection=$('<div class="section video hidden"><h3>视频信息</h3><p><span></span><span>aid: '+biliHelper.avid+"</span><span>pg: "+biliHelper.page+"</span></p></div>"),biliHelper.mainBlock.append(biliHelper.mainBlock.infoSection),biliHelper.mainBlock.dblclick(function(a){a.shiftKey&&biliHelper.mainBlock.infoSection.toggleClass("hidden")}),biliHelper.redirectUrl&&"undefined"!=biliHelper.redirectUrl&&(biliHelper.mainBlock.redirectSection=$('<div class="section redirect"><h3>生成页选项</h3><p><a class="b-btn w" href="'+biliHelper.redirectUrl+'">前往原始跳转页</a></p></div>'),biliHelper.mainBlock.append(biliHelper.mainBlock.redirectSection)),biliHelper.mainBlock.switcherSection=$('<div class="section switcher"><h3>播放器切换</h3><p></p></div>'),biliHelper.mainBlock.switcherSection.find("p").append($('<a class="b-btn w" type="original">原始播放器</a><a class="b-btn w hidden" type="bilimac">Mac 客户端</a><a class="b-btn w hidden" type="swf">SWF 播放器</a><a class="b-btn w hidden" type="iframe">Iframe 播放器</a><a class="b-btn w hidden" type="html5">HTML5 播放器</a>').click(function(){biliHelper.switcher[$(this).attr("type")]()})),biliHelper.redirectUrl&&(biliHelper.mainBlock.switcherSection.find('a[type="original"]').addClass("hidden"),biliHelper.mainBlock.switcherSection.find('a[type="swf"],a[type="iframe"]').removeClass("hidden")),localStorage.getItem("bilimac_player_type")&&biliHelper.mainBlock.switcherSection.find('a[type="bilimac"]').removeClass("hidden"),biliHelper.mainBlock.append(biliHelper.mainBlock.switcherSection),biliHelper.mainBlock.downloaderSection=$('<div class="section downloder"><h3>视频下载</h3><p><span></span>视频地址获取中，请稍等…</p></div>'),biliHelper.mainBlock.append(biliHelper.mainBlock.downloaderSection),biliHelper.mainBlock.querySection=$('<div class="section query"><h3>弹幕发送者查询</h3><p><span></span>正在加载全部弹幕, 请稍等…</p></div>'),biliHelper.mainBlock.append(biliHelper.mainBlock.querySection),biliHelper.switcher.set("original"),biliHelper.genPage||(0==biliHelper.site?$(".player-wrapper .arc-toolbar").append(biliHelper.helperBlock):1==biliHelper.site&&$(".v1-bangumi-info-operate .v1-app-btn").after(biliHelper.helperBlock)),$(document).ready(biliHelperFunc)}));var biliHelperFunc=function(){if(biliHelper.totalPage=$(".player-wrapper .v-plist").attr("length"),isNaN(biliHelper.totalPage)||(biliHelper.totalPage=parseInt(biliHelper.totalPage)),"force"==localStorage.getItem("bilimac_player_type")&&biliHelper.switcher.set("bilimac"),!biliHelper.genPage&&biliHelper.replaceEnabled&&"force"!=localStorage.getItem("bilimac_player_type")&&($("#bofqi object").length>0&&"http://static.hdslb.com/play.swf"!=$("#bofqi object").attr("data")&&"https://static-s.bilibili.com/play.swf"!=$("#bofqi object").attr("data")&&"http://static.hdslb.com/letv.swf"!=$("#bofqi object").attr("data")&&"http://static.hdslb.com/play_old.swf"!=$("#bofqi object").attr("data")&&"http://static.hdslb.com/play196.swf"!=$("#bofqi object").attr("data")||$("#bofqi embed").length>0&&"http://static.hdslb.com/play.swf"!=$("#bofqi embed").attr("src")&&"https://static-s.bilibili.com/play.swf"!=$("#bofqi embed").attr("src")&&"http://static.hdslb.com/letv.swf"!=$("#bofqi embed").attr("src")&&"http://static.hdslb.com/play_old.swf"!=$("#bofqi embed").attr("src")&&"http://static.hdslb.com/play196.swf"!=$("#bofqi embed").attr("data")||$("#bofqi iframe").length>0&&($("#bofqi iframe").attr("src").indexOf("bilibili.com")<0||$("#bofqi iframe").attr("src").indexOf("iqiyi")>0)||$("#bofqi object").length+$("#bofqi embed").length+$("#bofqi iframe").length==0)?(biliHelper.replacePlayer=!0,biliHelper.mainBlock.switcherSection.find('a[type="iframe"],a[type="swf"]').removeClass("hidden")):biliHelper.replacePlayer=!1,!biliHelper.genPage&&biliHelper.favorHTML5&&($("#bofqi").html('<div id="player_placeholder" class="player"></div>'),$("#bofqi").find("#player_placeholder").css({background:"url("+biliHelper.videoPic+") 50% 50% / cover no-repeat","-webkit-filter":"blur(20px)",overflow:"hidden",visibility:"visible"})),biliHelper.replacePlayer||biliHelper.favorHTML5&&"force"!=localStorage.getItem("bilimac_player_type")&&!biliHelper.genPage){var replaceNotice=$('<div id="loading-notice">正在尝试替换播放器…<span id="cancel-replacing">取消</span></div>');replaceNotice.find("#cancel-replacing").click(function(){$("#loading-notice").fadeOut(300),biliHelper.favorHTML5&&(!biliHelper.replacePlayer||biliHelper.redirectUrl||biliHelper.genPage?biliHelper.switcher.original():biliHelper.switcher.swf(),biliHelper.favorHTML5=!1)}),$("#bofqi").append(replaceNotice)}biliHelper.work=function(){chrome.extension.sendMessage({command:"getVideoInfo",avid:biliHelper.avid,pg:biliHelper.page+biliHelper.pageOffset,isBangumi:1==biliHelper.site},function(response){var videoInfo=response.videoInfo,error=!1;if("number"==typeof videoInfo.cid&&0==$(".b-page-body .viewbox").length&&0==$(".main-inner .viewbox").length&&(biliHelper.genPage=!0,biliHelper.copyright=!0),biliHelper.videoPic=videoInfo.pic,"number"==typeof biliHelper.totalPage&&biliHelper.totalPage>videoInfo.pages&&biliHelper.pageOffset>videoInfo.pages-biliHelper.totalPage)return biliHelper.pageOffset=videoInfo.pages-biliHelper.totalPage,biliHelper.work(),!1;if("undefined"!=typeof videoInfo.code)1!=biliHelper.page?chrome.extension.sendMessage({command:"getVideoInfo",avid:biliHelper.avid,pg:1,isBangumi:1==biliHelper.site},function(a){var b=a.videoInfo;if(b.pages==biliHelper.page-1)return biliHelper.pageOffset-=1,biliHelper.work(),!1}):(biliHelper.error="错误"+videoInfo.code+": "+videoInfo.error,biliHelper.mainBlock.errorSection=$('<div class="section error"><h3>Cid 获取失败</h3><p><span></span><span>'+parseSafe(biliHelper.error)+"</span></p></div>"),biliHelper.mainBlock.append(biliHelper.mainBlock.errorSection),$("#loading-notice").fadeOut(300));else if(!isNaN(biliHelper.cid)&&biliHelper.originalPlayer&&biliHelper.originalPlayer.replace("cid="+biliHelper.cid,"cid="+videoInfo.cid),biliHelper.cid=videoInfo.cid,!biliHelper.genPage){biliHelper.mainBlock.infoSection.find("p").append($("<span>cid: "+biliHelper.cid+"</span>"));var commentDiv=$('<div class="section comment"><h3>弹幕下载</h3><p><a class="b-btn w" href="http://comment.bilibili.com/'+biliHelper.cid+'.xml">下载 XML 格式弹幕</a></p></div>'),downloadFileName=getDownloadOptions("http://comment.bilibili.com/"+biliHelper.cid+".xml",getNiceSectionFilename(biliHelper.avid,biliHelper.page,biliHelper.totalPage,1,1)).filename;commentDiv.find("a").attr("download",downloadFileName).click(function(a){a.preventDefault(),chrome.extension.sendMessage({command:"requestForDownload",url:$(a.target).attr("href"),filename:$(a.target).attr("download")})}),biliHelper.mainBlock.commentSection=commentDiv,biliHelper.mainBlock.append(biliHelper.mainBlock.commentSection),$.get("http://comment.bilibili.com/"+biliHelper.cid+".xml",function(a){var b="\ufeff"+generateASS(setPosition(parseXML("",a)),{title:getNiceSectionFilename(biliHelper.avid,biliHelper.page,biliHelper.totalPage,1,1),ori:location.href}),c=new Blob([b],{type:"application/octet-stream"}),d=window.URL.createObjectURL(c),e=$('<a class="b-btn w">下载 ASS 格式弹幕</a>').attr("download",downloadFileName.replace(".xml",".ass")).attr("href",d).click(function(a){a.preventDefault(),chrome.extension.sendMessage({command:"requestForDownload",url:$(a.target).attr("href"),filename:$(a.target).attr("download")})});biliHelper.mainBlock.commentSection.find("p").append(e),biliHelper.comments=a.getElementsByTagName("d");var f=$('<div><input type="text" class="b-input" placeholder="根据关键词筛选弹幕"><div class="b-slt"><span class="txt">请选择需要查询的弹幕…</span><div class="b-slt-arrow"></div><ul class="list"><li disabled="disabled" class="disabled" selected="selected">请选择需要查询的弹幕</li></ul></div><span></span><span class="result">选择弹幕查看发送者…</span></div>');f.find(".b-input").keyup(function(){var a=f.find("input").val(),b=new RegExp(parseSafe(a),"gi");f.find("ul.list").html('<li disabled="disabled" class="disabled" selected="selected">请选择需要查询的弹幕</li>'),"请选择需要查询的弹幕"!=f.find(".b-slt .txt").text()&&""!=a.trim()&&f.find(".b-slt .txt").html(parseSafe(f.find(".b-slt .txt").text())),""!=a.trim()&&f.find(".b-slt .txt").text(f.find(".b-slt .txt").text());for(var c=0;c<biliHelper.comments.length;c++){var d=biliHelper.comments[c],e=d.childNodes[0];if(e&&d&&b.test(e.nodeValue)){e=e.nodeValue;var g=d.getAttribute("p").split(","),h=g[6],i=parseTime(1e3*parseInt(g[0]));f.find("ul.list").append($("<li></li>").data("sender",h).html("["+i+"] "+(""==a.trim()?parseSafe(e):parseSafe(e).replace(b,function(a){return'<span class="kw">'+a+"</span>"}))))}}}),f.find(".b-input").keyup(),SelectModule.bind(f.find("div.b-slt"),{onChange:function(a){var b=$(a[0]).data("sender");if(f.find(".result").text("查询中…"),0==b.indexOf("D"))return void f.find(".result").text("游客弹幕");var c=function(a,b){f.find(".result").html('发送者: <a href="http://space.bilibili.com/'+a+'" target="_blank" card="'+parseSafe(b.name)+'">'+parseSafe(b.name)+'</a><div target="_blank" class="user-info-level l'+parseSafe(b.level_info.current_level)+'"></div>');var c=document.createElement("script");c.appendChild(document.createTextNode('UserCard.bind($("#bilibili_helper .query .result"));')),document.body.appendChild(c),c.parentNode.removeChild(c)};$.get("https://biliquery.typcn.com/api/user/hash/"+b,function(a){if(a&&0==a.error&&"object"==typeof a.data&&a.data[0].id){var b=parseSafe(a.data[0].id);f.find(".result").html('发送者 UID: <a href="http://space.bilibili.com/'+b+'" target="_blank">'+b+"</a>");var a=sessionStorage.getItem("user/"+b);if(a)return c(b,JSON.parse(a)),!1;$.getJSON("http://api.bilibili.cn/userinfo?mid="+b+"&type=json",function(a){0==a.code&&(sessionStorage.setItem("user/"+b,JSON.stringify({name:a.name,level_info:{current_level:a.level_info.current_level}})),c(b,a))})}else f.find(".result").text("查询失败, 发送用户可能已被管理员删除.")},"json").fail(function(){f.find(".result").text("查询失败, 无法连接到服务器 :(")})}}),biliHelper.mainBlock.querySection.find("p").empty().append(f)},"xml")}if(biliHelper.genPage){tagList="";var alist="";return videoInfo.list.length>1&&(alist+="<select id='dedepagetitles' onchange='location.href=this.options[this.selectedIndex].value;'>",videoInfo.list.forEach(function(a){alist+="<option value='/video/av"+biliHelper.avid+"/index_"+parseSafe(a.page)+".html'>"+parseSafe(a.page)+"、"+(a.part?a.part:"P"+parseSafe(a.page))+"</option>"}),alist+="</select>"),videoInfo.tag.split(",").forEach(function(a){tagList+='<li><a class="tag-val" href="/tag/'+encodeURIComponent(a)+'/" title="'+a+'" target="_blank">'+a+"</a></li>"}),$.get(chrome.extension.getURL("template.html"),function(a){var b=a.replace(/__bl_avid/g,biliHelper.avid).replace(/__bl_page/g,biliHelper.page).replace(/__bl_cid/g,biliHelper.cid).replace(/__bl_tid/g,videoInfo.tid).replace(/__bl_mid/g,videoInfo.mid).replace(/__bl_pic/g,videoInfo.pic).replace(/__bl_title/g,parseSafe(videoInfo.title)).replace(/__bl_sp_title_uri/g,videoInfo.sp_title?encodeURIComponent(videoInfo.sp_title):"").replace(/__bl_sp_title/g,videoInfo.sp_title?parseSafe(videoInfo.sp_title):"").replace(/__bl_spid/g,videoInfo.spid).replace(/__bl_season_id/g,videoInfo.season_id).replace(/__bl_created_at/g,videoInfo.created_at).replace(/__bl_description/g,parseSafe(videoInfo.description)).replace(/__bl_redirectUrl/g,biliHelper.redirectUrl).replace(/__bl_tags/g,JSON.stringify(videoInfo.tag.split(","))).replace(/__bl_tag_list/g,tagList).replace(/__bl_alist/g,alist).replace(/__bl_bangumi_cover/g,videoInfo.bangumi?videoInfo.bangumi.cover:"").replace(/__bl_bangumi_desc/g,videoInfo.bangumi?videoInfo.bangumi.desc:"");document.open(),document.write(b),document.close();var c=document.createElement("script");c.id="page-prob",c.innerHTML="$('.player-wrapper .v-plist').attr('length', window.VideoPart.nodedata.length);$('#page-prob').remove();",setTimeout(function(){document.body.appendChild(c),biliHelper.genPage=!1,videoInfo.bangumi||$(".bangumi-content .v_bgm_list").empty(),intilize_style(function(){$(".player-wrapper .arc-toolbar").append(biliHelper.helperBlock)}),biliHelperFunc()},500)}),!1}return window.postMessage?(c=function(a){"https://secure.bilibili.com"!=a.origin&&"https://ssl.bilibili.com"!=a.origin||"secJS:"!=a.data.substr(0,6)||eval(a.data.substr(6))},window.addEventListener?window.addEventListener("message",c,!1):window.attachEvent&&window.attachEvent("onmessage",c)):setInterval(function(){(evalCode=__GetCookie("__secureJS"))&&(__SetCookie("__secureJS",""),eval(evalCode))},1e3),biliHelper.cid&&!biliHelper.favorHTML5&&"force"!=localStorage.getItem("bilimac_player_type")&&$("#loading-notice").fadeOut(300,function(){biliHelper.switcher.swf()}),biliHelper.cid?(finishUp(),$(".viewbox .info .v-title h1").html(addTitleLink($(".viewbox .info .v-title h1").attr("title"),response.rel_search)),void $(".titleNumber").click(function(){var a=new MessageBox;a.show(this,'点击搜索相关视频：<br /><a target="_blank" href="http://www.bilibili.com/search?orderby=default&keyword='+encodeURIComponent($(this).attr("previous"))+'">'+$(this).attr("previous")+'</a><br /><a target="_blank" href="http://www.bilibili.com/search?orderby=ranklevel&keyword='+encodeURIComponent($(this).attr("next"))+'">'+$(this).attr("next")+"</a>",1e3)})):(biliHelper.error="错误"+videoInfo.code+": "+videoInfo.error,biliHelper.mainBlock.errorSection=$('<div class="section error"><h3>Cid 获取失败</h3><p><span></span><span>'+parseSafe(biliHelper.error)+"</span></p></div>"),biliHelper.mainBlock.append(biliHelper.mainBlock.errorSection),!1)})},biliHelper.work(),window.addEventListener("hashchange",function(){var a=/page=([0-9]+)/.exec(document.location.hash);a&&"object"==typeof a&&!isNaN(a[1])&&(a=parseInt(a[1])),a&&a!=biliHelper.page&&(biliHelper.page=a,biliHelper.mainBlock.infoSection.html("<h3>视频信息</h3><p><span></span><span>aid: "+biliHelper.avid+"</span><span>pg: "+biliHelper.page+"</span></p>"),biliHelper.mainBlock.downloaderSection.html("<h3>视频下载</h3><p><span></span>视频地址获取中，请稍等…</p>"),biliHelper.mainBlock.querySection.html("<h3>弹幕发送者查询</h3><p><span></span>正在加载全部弹幕, 请稍等…</p>"),biliHelper.mainBlock.commentSection&&biliHelper.mainBlock.commentSection.remove(),biliHelper.mainBlock.errorSection&&biliHelper.mainBlock.errorSection.remove(),biliHelper.work())},!1)}}(),function(){if("http://www.bilibili.com/video/bgm_calendar.html"==location.href)for(var a=$("#bangumi"),b=(new Date).getDay()-1,c=0;c<7&&a.children()[0].getAttribute("weekday")!=b;++c){var d=a.children()[0];a.children()[0].remove(),a.append(d)}}();