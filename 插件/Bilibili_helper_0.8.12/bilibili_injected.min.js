"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a};!function(){function formatInt(a,b){for(var c="",d=1;d<=b-(a+"").length;d++)c+="0";return c+a}function parseSafe(a){return(""+a).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function parseTime(a){return formatInt(parseInt(a/6e4),2)+":"+formatInt(parseInt(a/1e3%60),2)}function inject_css(a,b){var c=document.createElement("link");c.setAttribute("id",a),c.setAttribute("type","text/css"),c.setAttribute("rel","stylesheet"),c.setAttribute("href",chrome.extension.getURL(b)),document.head?document.head.appendChild(c):document.documentElement.appendChild(c)}function removeAd(){chrome.runtime.sendMessage({command:"getAd"},function(a){"on"===a.value&&inject_css("bilibiliHelperAdStyle","bilibiliHelperAd.min.css")})}function initStyle(){inject_css("bilibiliHelperVideo","bilibiliHelperVideo.min.css"),$(".arc-toolbar .helper .t .icon").css("background-image","url("+chrome.extension.getURL("imgs/helper-neko.png")+")")}function setWide(){var a=$("#bofqi"),b=function(){if(!a.hasClass("wide")){var b=$(".bilibili-player-iconfont-widescreen");if(a.addClass("wide"),0===b.length){var c=a.find("param[name=flashvars]");c.val(c.val()+"&as_wide=1"),$("#player_placeholder").attr("data",$("#player_placeholder").attr("data"))}else("/blackboard/html5player.html"===document.location.pathname||b.length>0)&&b.click()}};setTimeout(function(){b()},2e3);var c=new MutationObserver(function(){setTimeout(function(){b()},2e3)});a.length>0&&c.observe(a[0],{childList:!0})}function setOffset(){$(document).scrollTop($(".b-page-body").offset().top)}function getNiceSectionFilename(a,b,c,d,e){var f="av"+a+"_",g=c&&c>1?"p"+b+"_":"",h="",i=e&&e>1?""+d+"_":"";return g&&(h=$(".player-wrapper #plist > span").text(),h=h.substr(h.indexOf("、")+1)+"_"),f+g+h+i+$("div.v-title").text()}function getDownloadOptions(a,b){var c=null,d=a.split(/[\\/]/).pop().split("?")[0],e=d.match(/[.]/)?d.match(/[^.]+$/):"mp4";switch(e){case"letv":e="flv"}return c=filenameSanitize(b,{replacement:"_",max:255-e.length-1})+"."+e,{url:a,filename:c}}if($("html").hasClass("bilibili-helper"))return!1;var biliHelper={};if("/blackboard/html5player.html"===document.location.pathname)biliHelper.site=2;else if("bangumi.bilibili.com"===location.hostname)biliHelper.site=1,biliHelper.sameVideo=!1;else{if("www.bilibili.com"!==location.hostname)return!1;biliHelper.site=0}biliHelper.protocol=location.protocol,removeAd(),chrome.runtime.onMessage.addListener(function(a,b,c){switch(a.command){case"update":return removeAd(),c({result:"ok"}),!0;case"error":return!0;default:return c({result:"unknown"}),!1}});var finishUp=function(){chrome.runtime.sendMessage({command:"getDownloadLink",cid:biliHelper.cid},function(a){var b=a.download,c=a.playback;if(biliHelper.downloadUrls=[],biliHelper.playbackUrls=[],"undefined"==typeof b.durl.url?biliHelper.downloadUrls=b.durl:biliHelper.downloadUrls.push(b.durl),"undefined"==typeof c.durl||"undefined"==typeof c.durl.url?biliHelper.playbackUrls=c.durl:biliHelper.playbackUrls.push(c.durl),"object"===_typeof(biliHelper.downloadUrls)&&biliHelper.downloadUrls.length){biliHelper.mainBlock.downloaderSection.find("p").empty();for(var d=0;d<biliHelper.downloadUrls.length;d++){var e=biliHelper.downloadUrls[d];if("object"===("undefined"==typeof e?"undefined":_typeof(e))){var f=getDownloadOptions(e.url,getNiceSectionFilename(biliHelper.avid,biliHelper.page,biliHelper.totalPage,d,biliHelper.downloadUrls.length)),g=$('<a class="b-btn w" rel="noreferrer"></a>').text("分段 "+(parseInt(d)+1)).data("download",f.filename).attr("title",isNaN(parseInt(e.filesize/1048576+.5))?"长度: "+parseTime(e.length):"长度: "+parseTime(e.length)+" 大小: "+parseInt(e.filesize/1048576+.5)+" MB").attr("href",e.url);biliHelper.mainBlock.downloaderSection.find("p").append(g),g.click(function(a){a.preventDefault(),chrome.runtime.sendMessage({command:"requestForDownload",url:$(a.target).attr("href"),filename:$(a.target).data("download")})})}}if(biliHelper.downloadUrls.length>1){var h=$('<a class="b-btn"></a>').text("下载全部共 "+biliHelper.downloadUrls.length+" 个分段");biliHelper.mainBlock.downloaderSection.find("p").append(h),h.click(function(a){biliHelper.mainBlock.downloaderSection.find("p .b-btn.w").click()})}}else{var i=biliHelper.error||"视频地址获取失败";biliHelper.mainBlock.downloaderSection.find("p").html("<span></span>"+parseSafe(i))}})},initHelper=function(){biliHelper.videoPic=$("img.cover_image").attr("src"),biliHelper.totalPage=$("#dedepagetitles option").length,$(".v1-bangumi-info-operate .helper").remove(),"undefined"==typeof biliHelper.page?biliHelper.page=1:biliHelper.page=parseInt(biliHelper.page),biliHelper.pageOffset=0,chrome.runtime.sendMessage({command:"init"},function(a){biliHelper.version=a.version,biliHelper.autowide=a.autowide,biliHelper.autooffset=a.autooffset,biliHelper.originalPlayer=localStorage.getItem("bilimac_original_player")||$("#bofqi").html(),localStorage.removeItem("bilimac_original_player"),biliHelper.switcher={current:"original",set:function(a){biliHelper.mainBlock.switcherSection&&(biliHelper.mainBlock.switcherSection.find('a.b-btn[type="'+this.current+'"]').addClass("w"),biliHelper.mainBlock.switcherSection.find('a.b-btn[type="'+a+'"]').removeClass("w")),this.current=a},original:function(){this.set("original"),$("#bofqi").html(biliHelper.originalPlayer)},bilimac:function(){this.set("bilimac"),$("#bofqi").html('<div id="player_placeholder" class="player"></div><div id="loading-notice">正在加载 Bilibili Mac 客户端…</div>'),$("#bofqi").find("#player_placeholder").css({background:"url("+biliHelper.videoPic+") 50% 50% / cover no-repeat","-webkit-filter":"blur(20px)",overflow:"hidden",visibility:"visible"}),chrome.runtime.sendMessage({command:"callBilibiliMac",data:{action:"playVideoByCID",data:biliHelper.cid+"|"+window.location.href+"|"+document.title+"|"+(2===biliHelper.cidHack?2:1)}},function(a){a?$("#bofqi").find("#loading-notice").text("已在 Bilibili Mac 客户端中加载"):$("#bofqi").find("#loading-notice").text("调用 Bilibili Mac 客户端失败 :(")})}},0===biliHelper.site?(biliHelper.helperBlock=$('<div class="block helper" id="bilibili_helper"><span class="t"><div class="icon"></div><div class="t-right"><span class="t-right-top middle">助手</span><span class="t-right-bottom">扩展菜单</span></div></span><div class="info"><div class="main"></div><div class="version" title="'+biliHelper.version+'">哔哩哔哩助手 by <a href="http://weibo.com/guguke" target="_blank">@啾咕咕</a> <a href="http://weibo.com/ruo0037" target="_blank">@肉肉</a><a class="setting b-btn w" href="'+chrome.extension.getURL("options.html")+'" target="_blank">设置</a></div></div></div>'),biliHelper.helperBlock.find(".t").click(function(){biliHelper.helperBlock.toggleClass("active")})):1===biliHelper.site&&(biliHelper.helperBlock=$('<span class="helper"><div class="v1-bangumi-info-btn" id="bilibili_helper">哔哩哔哩助手</div><div class="info"><div class="main"></div><div class="version" title="'+biliHelper.version+'">哔哩哔哩助手 by <a href="http://weibo.com/guguke" target="_blank">@啾咕咕</a> <a href="http://weibo.com/ruo0037" target="_blank">@肉肉</a><a class="setting b-btn w" href="'+chrome.extension.getURL("options.html")+'" target="_blank">设置</a></div></div></span>'),biliHelper.helperBlock.find(".v1-bangumi-info-btn").click(function(){biliHelper.helperBlock.toggleClass("active")}));var b=biliHelper.helperBlock.find(".info");biliHelper.mainBlock=b.find(".main"),biliHelper.mainBlock.infoSection=$('<div class="section video hidden"><h3>视频信息</h3><p><span></span><span>aid: '+biliHelper.avid+"</span><span>pg: "+biliHelper.page+"</span></p></div>"),biliHelper.mainBlock.append(biliHelper.mainBlock.infoSection),biliHelper.mainBlock.dblclick(function(a){a.shiftKey&&biliHelper.mainBlock.infoSection.toggleClass("hidden")}),localStorage.getItem("bilimac_player_type")&&(biliHelper.mainBlock.switcherSection=$('<div class="section switcher"><h3>播放器切换</h3><p></p></div>'),biliHelper.mainBlock.switcherSection.find("p").append($('<a class="b-btn w" type="original">原始播放器</a><a class="b-btn w" type="bilimac">Mac 客户端</a>').click(function(){biliHelper.switcher[$(this).attr("type")]()})),biliHelper.mainBlock.append(biliHelper.mainBlock.switcherSection)),biliHelper.mainBlock.downloaderSection=$('<div class="section downloder"><h3>视频下载</h3><p><span></span>视频地址获取中，请稍等…</p></div>'),biliHelper.mainBlock.append(biliHelper.mainBlock.downloaderSection),biliHelper.mainBlock.querySection=$('<div class="section query"><h3>弹幕发送者查询</h3><p><span></span>正在加载全部弹幕, 请稍等…</p></div>'),biliHelper.mainBlock.append(biliHelper.mainBlock.querySection),biliHelper.switcher.set("original"),"on"===a.autowide&&setWide(),0===biliHelper.site?$(".player-wrapper .arc-toolbar").append(biliHelper.helperBlock):1===biliHelper.site&&$(".v1-bangumi-info-operate .v1-app-btn").after(biliHelper.helperBlock),$(document).ready(biliHelperFunc),initStyle()})};if("function"==typeof $&&$(".player-wrapper .v-plist").length){var prob=document.createElement("script");prob.id="page-prob",prob.innerHTML="$('.player-wrapper .v-plist').attr('length', window.VideoPart.nodedata.length);$('#page-prob').remove();",document.body.appendChild(prob)}$("html").addClass("bilibili-helper");var bili_reg=void 0,urlResult=void 0,hashPage=void 0;if(0===biliHelper.site)bili_reg=/\/video\/av([0-9]+)\/(?:index_([0-9]+)\.html)?.*?$/,urlResult=bili_reg.exec(document.location.pathname),hashPage=/page=([0-9]+)/.exec(document.location.hash),hashPage&&"object"===("undefined"==typeof hashPage?"undefined":_typeof(hashPage))&&!isNaN(hashPage[1])&&(hashPage=parseInt(hashPage[1])),urlResult&&(biliHelper.avid=urlResult[1],biliHelper.page=hashPage||urlResult[2]),biliHelper.avid&&initHelper();else if(1===biliHelper.site){var playerBlock=$("#bofqi")[0];if(playerBlock){var observer=new MutationObserver(function(){if(($("iframe.player").length||$('.scontent object param[name="flashvars"]').length)&&(urlResult=$('.scontent object param[name="flashvars"]').attr("value")||$("iframe.player").attr("src"))){var a=urlResult.split("&").map(function(a){return a.split("=",2)});a.forEach(function(a){var b=a[0],c=a[1];"aid"===b?biliHelper.avid=c:"cid"===b?biliHelper.cid=c:"seasonId"===b?biliHelper.seasonId=c:"episodeId"===b&&(biliHelper.episodeId===c?biliHelper.sameVideo=!0:biliHelper.sameVideo=!1,biliHelper.episodeId=c)}),biliHelper.sameVideo===!1&&initHelper()}});observer.observe(playerBlock,{childList:!0})}}else 2===biliHelper.site&&chrome.runtime.sendMessage({command:"init"},function(a){"on"===a.autowide&&setWide()});biliHelper.work=function(){chrome.runtime.sendMessage({command:"getVideoInfo",avid:biliHelper.avid,pg:biliHelper.page+biliHelper.pageOffset},function(response){function createDanmuList(){biliHelper.mainBlock.infoSection.find("p").append($("<span>cid: "+biliHelper.cid+"</span>"));var a=$('<div class="section comment"><h3>弹幕下载</h3><p><a class="b-btn w" href="'+biliHelper.protocol+"//comment.bilibili.com/"+biliHelper.cid+'.xml">下载 XML 格式弹幕</a></p></div>'),b=biliHelper.protocol+"//comment.bilibili.com/"+biliHelper.cid+".xml",c=getNiceSectionFilename(biliHelper.avid,biliHelper.page,biliHelper.totalPage,1,1),d=getDownloadOptions(b,c).filename;a.find("a").attr("download",d).click(function(a){a.preventDefault(),chrome.runtime.sendMessage({command:"requestForDownload",url:$(a.target).attr("href"),filename:$(a.target).attr("download")})}),biliHelper.mainBlock.commentSection=a,biliHelper.mainBlock.append(biliHelper.mainBlock.commentSection),fetch(biliHelper.protocol+"//comment.bilibili.com/"+biliHelper.cid+".xml").then(function(a){return a.text()}).then(function(a){var b=new DOMParser,c=b.parseFromString(a.replace(/(?:[\0-\x08\x0B\f\x0E-\x1F\uFFFE\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])/g,""),"text/xml"),e="\ufeff"+generateASS(setPosition(parseXML("",c)),{title:getNiceSectionFilename(biliHelper.avid,biliHelper.page,biliHelper.totalPage,1,1),ori:location.href}),f=new Blob([e],{type:"application/octet-stream"}),g=window.URL.createObjectURL(f),h=$('<a class="b-btn w">下载 ASS 格式弹幕</a>').attr("download",d.replace(".xml",".ass")).attr("href",g).data("data",e).click(function(a){a.preventDefault(),chrome.runtime.sendMessage({command:"requestForDownload",data:$(a.target).data("data"),url:$(a.target).attr("href"),filename:$(a.target).attr("download")})});biliHelper.mainBlock.commentSection.find("p").append(h),biliHelper.comments=c.getElementsByTagName("d");var i=$('<div><input type="text" class="b-input" placeholder="根据关键词筛选弹幕"><div class="b-slt"><span class="txt">请选择需要查询的弹幕…</span><div class="b-slt-arrow"></div><ul class="list"><li disabled="disabled" class="disabled" selected="selected">请选择需要查询的弹幕</li></ul></div><span></span><span class="result">选择弹幕查看发送者…</span></div>');i.find(".b-input").keyup(function(){var a=i.find("input").val(),b=new RegExp(parseSafe(a),"gi");i.find("ul.list").html('<li disabled="disabled" class="disabled" selected="selected">请选择需要查询的弹幕</li>'),"请选择需要查询的弹幕"!==i.find(".b-slt .txt").text()&&""!==a.trim()&&i.find(".b-slt .txt").html(parseSafe(i.find(".b-slt .txt").text())),""!==a.trim()&&i.find(".b-slt .txt").text(i.find(".b-slt .txt").text());for(var c=0;c<biliHelper.comments.length;c++){var d=biliHelper.comments[c],e=d.childNodes[0];if(e&&d&&b.test(e.nodeValue)){e=e.nodeValue;var f=d.getAttribute("p").split(","),g=f[6],h=parseTime(1e3*parseInt(f[0]));i.find("ul.list").append($("<li></li>").data("sender",g).html("["+h+"] "+(""===a.trim()?parseSafe(e):parseSafe(e).replace(b,function(a){return'<span class="kw">'+a+"</span>"}))))}}}),i.find(".b-input").keyup(),SelectModule.bind(i.find("div.b-slt"),{onChange:function(a){var b=$(a[0]).data("sender");if(i.find(".result").text("查询中…"),0===b.indexOf("D"))return void i.find(".result").text("游客弹幕");var c=function(a,b){i.find(".result").html('发送者: <a href="'+biliHelper.protocol+"//space.bilibili.com/"+a+'" target="_blank" data-usercard-mid="'+a+'">'+parseSafe(b.name)+'</a><div target="_blank" class="user-info-level l'+parseSafe(b.level_info.current_level)+'"></div>');var c=document.createElement("script");c.appendChild(document.createTextNode('UserCard.bind($("#bilibili_helper .query .result"));')),document.body.appendChild(c),c.parentNode.removeChild(c)},d=function(a){i.find(".result").html('发送者 UID: <a href="'+biliHelper.protocol+"//space.bilibili.com/"+a+'" target="_blank">'+a+"</a>");var b=sessionStorage.getItem("user/"+a);return b?(c(a,JSON.parse(b)),!1):void $.getJSON(biliHelper.protocol+"//api.bilibili.com/cardrich?mid="+a+"&type=json",function(b){if(0===b.code){var d=b.data.card;sessionStorage.setItem("user/"+a,JSON.stringify({name:d.name,level_info:{current_level:d.level_info.current_level}})),c(a,d)}})},e=/^b(\d+)$/.exec(b);e?d(e[1]):$.get("https://biliquery.typcn.com/api/user/hash/"+b,function(a){a&&0===a.error&&"object"===_typeof(a.data)&&a.data[0].id?d(a.data[0].id):i.find(".result").text("查询失败, 发送用户可能已被管理员删除.")},"json").fail(function(){i.find(".result").text("查询失败, 无法连接到服务器 :(")})}}),biliHelper.mainBlock.querySection.find("p").empty().append(i)})}var videoInfo=response.videoInfo;if("number"==typeof videoInfo.cid&&0===$(".b-page-body .viewbox").length&&0===$(".main-inner .viewbox").length&&(biliHelper.genPage=!0,biliHelper.copyright=!0),biliHelper.videoPic=videoInfo.pic,"number"==typeof biliHelper.totalPage&&biliHelper.totalPage>videoInfo.pages&&biliHelper.pageOffset>videoInfo.pages-biliHelper.totalPage)return biliHelper.pageOffset=videoInfo.pages-biliHelper.totalPage,biliHelper.work(),!1;"on"===biliHelper.autowide&&setWide(),"on"===biliHelper.autooffset&&setOffset(),"undefined"!=typeof videoInfo.code?1!==biliHelper.page?chrome.runtime.sendMessage({command:"getVideoInfo",avid:biliHelper.avid,pg:1,isBangumi:1===biliHelper.site},function(a){var b=a.videoInfo;if(b.pages===biliHelper.page-1)return biliHelper.pageOffset-=1,biliHelper.work(),!1}):(biliHelper.error="错误"+videoInfo.code+": "+videoInfo.error,biliHelper.mainBlock.errorSection=$('<div class="section error"><h3>Cid 获取失败</h3><p><span></span><span>'+parseSafe(biliHelper.error)+"</span></p></div>"),biliHelper.mainBlock.append(biliHelper.mainBlock.errorSection),$("#loading-notice").fadeOut(300)):(void 0===biliHelper.cid&&(biliHelper.cid=videoInfo.cid),1===biliHelper.site?chrome.runtime.sendMessage({command:"getBangumiInfo",episodeId:biliHelper.episodeId},function(a){biliHelper.avid=a.videoInfo.avid,biliHelper.cid=a.videoInfo.danmaku,biliHelper.index=a.videoInfo.index,createDanmuList()}):createDanmuList());var c=null;return window.postMessage?(c=function c(a){"https://secure.bilibili.com"!==a.origin&&"https://ssl.bilibili.com"!==a.origin||"secJS:"!==a.data.substr(0,6)||eval(a.data.substr(6))},window.addEventListener?window.addEventListener("message",c,!1):window.attachEvent&&window.attachEvent("onmessage",c)):setInterval(function(){var evalCode=window.__GetCookie("__secureJS");window.__SetCookie("__secureJS",""),eval(evalCode)},1e3),biliHelper.cid?void finishUp():(biliHelper.error="错误"+videoInfo.code+": "+videoInfo.error,biliHelper.mainBlock.errorSection=$('<div class="section error"><h3>Cid 获取失败</h3><p><span></span><span>'+parseSafe(biliHelper.error)+"</span></p></div>"),biliHelper.mainBlock.append(biliHelper.mainBlock.errorSection),!1)})};var biliHelperFunc=function(){biliHelper.totalPage=$(".player-wrapper .v-plist").attr("length"),isNaN(biliHelper.totalPage)||(biliHelper.totalPage=parseInt(biliHelper.totalPage)),"force"===localStorage.getItem("bilimac_player_type")&&biliHelper.switcher.set("bilimac"),localStorage.removeItem("bilimac_player_type"),biliHelper.replacePlayer=!1,biliHelper.work(),window.addEventListener("hashchange",function(){var a=/page=([0-9]+)/.exec(document.location.hash);a&&"object"===("undefined"==typeof a?"undefined":_typeof(a))&&!isNaN(a[1])&&(a=parseInt(a[1])),a&&a!==biliHelper.page&&(biliHelper.page=a,biliHelper.mainBlock.infoSection.html("<h3>视频信息</h3><p><span></span><span>aid: "+biliHelper.avid+"</span><span>pg: "+biliHelper.page+"</span></p>"),biliHelper.mainBlock.downloaderSection.html("<h3>视频下载</h3><p><span></span>视频地址获取中，请稍等…</p>"),biliHelper.mainBlock.querySection.html("<h3>弹幕发送者查询</h3><p><span></span>正在加载全部弹幕, 请稍等…</p>"),biliHelper.mainBlock.commentSection&&biliHelper.mainBlock.commentSection.remove(),biliHelper.mainBlock.errorSection&&biliHelper.mainBlock.errorSection.remove(),biliHelper.work())},!1)}}(),function(){if("/video/bgm_calendar.html"===location.pathname)for(var a=$("#bangumi"),b=(new Date).getDay()-1,c=0;c<7&&a.children()[0].getAttribute("weekday")!==b;++c){var d=a.children()[0];a.children()[0].remove(),a.append(d)}}();