"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a};!function(){if("live.bilibili.com"===location.hostname){if(!store.enabled)return;store["delete"]=function(a,b){if(void 0!==a){var c=store.get(a);void 0!==c&&(void 0!==b&&null!==b?"string"!=typeof b&&"number"!=typeof b||(c[b]&&delete c[b],store.set(a,c)):store.remove(a))}};var Live={scriptOptions:{},hasInit:!1,giftList:{},mobileVerified:0,protocol:location.protocol};Live.addScriptByFile=function(a,b){var c=document.createElement("script");c.id="bilibiliHelperScript",c.src=chrome.extension.getURL(a),"object"===("undefined"==typeof b?"undefined":_typeof(b))&&c.setAttribute("options",JSON.stringify(b)),document.body.appendChild(c)},Live.addScriptByText=function(a){var b=document.createElement("script");b.innerHTML=a,document.body.appendChild(b)},Live.getDateDiff=function(a,b){var c=new Date(Date.parse(a.replace(/-/g,"/"))).getTime(),d=new Date(Date.parse(b.replace(/-/g,"/"))).getTime(),e=Math.abs(c-d)/864e5;return e},Live.getRoomHTML=function(a){return $.get(Live.protocol+"//live.bilibili.com/"+a).promise()},Live.getRoomIdByUrl=function(a,b){var c=store.get("bilibili_helper_live_roomId")[a];void 0!=c?b(c):Live.getRoomHTML(a).done(function(c){var d=new RegExp("var ROOMID = ([\\d]+)"),e=d.exec(c)[1];if(e){var f=void 0;(f=store.get("bilibili_helper_live_roomId"))[a]=e,store.set("bilibili_helper_live_roomId",f),"function"==typeof b&&b(e)}}).fail(function(c){404!=c.status&&Live.getRoomIdByUrl(a,b)})},Live.getUser=function(){return $.getJSON(Live.protocol+"//live.bilibili.com/user/getuserinfo").promise()},Live.getMedalList=function(){return $.getJSON(Live.protocol+"//live.bilibili.com/i/ajaxGetMyMedalList").promise()},Live.each=function(a,b){if(b)if(a instanceof Array)for(var c=0,d=a.length;c<d&&b.call(a[c],c)!==!1;c++);else if("object"===("undefined"==typeof a?"undefined":_typeof(a))){var e=null;for(e in a)if(b.call(a[e],e)===!1)break}},Live.getCookie=function(a){var b=void 0,c=new RegExp("(^| )"+a+"=([^;]*)(;|$)");return(b=document.cookie.match(c))?unescape(b[2]):null},Live.setCookie=function(a,b,c){c=c||0;var d="";if(0!=c){var e=new Date;e.setTime(e.getTime()+1e3*c),d="; expires="+e.toGMTString()}document.cookie=a+"="+escape(b)+d+"; path=/"},Live.liveQuickLogin=function(){function a(){throw window.biliQuickLogin?(window.biliQuickLogin(function(){window.location.reload()}),"Bilibili Live: 您没登陆，想干撒子？~~ -_-"):"Bilibili Live: 快速登录脚本未正确载入."}if(!Live.getCookie("DedeUserID")&&!Live.getCookie("LIVE_LOGIN_DATA"))try{window.biliQuickLogin?a():$.getScript("https://static-s.bilibili.com/account/bili_quick_login.js",function(b,c){"success"===c&&a()})}catch(b){throw new Error(b)}},Live.getRoomId=function(){return store.get("bilibili_helper_live_roomId")[location.pathname.substr(1)]},Live.getRoomInfo=function(){return $.getJSON(Live.protocol+"//live.bilibili.com/live/getInfo?roomid="+Live.roomId).promise()},Live.numFormat=function(a){var b=a;return a>=1e4&&(b=(a/1e4).toFixed(1)+"万"),b},Live.rgb2hex=function(a){function b(a,b){for(var c=a.toString(16);c.length<b;)c="0"+c;return c}if("#"===a.charAt(0))return a;var c=a.split(/\D+/),d=65536*Number(c[1])+256*Number(c[2])+Number(c[3]);return"#"+b(d,6)},Live.getDomType=function(a){var b=Object.prototype.toString.call(a),c=/HTML.*.Element/;return"[object Object]"===b&&a.jquery?"jQuery Object":"[object Object]"===b?"Object":"[object Number]"===b?"Number":"[object String]"===b?"String":"[object Array]"===b?"Array":"[object Boolean]"===b?"Boolean":"[object Function]"===b?"Function":"[object Null]"===b?"null":"[object Undefined]"===b?"undefined":b.match(c)?"HTML Element":"[object HTMLCollection]"===b?"HTML Elements Collection":null},Live.randomEmoji={list:{happy:["(｀･ω･´)","=‿=✧","●ω●","(/ ▽ \\)","(=・ω・=)","(●'◡'●)ﾉ♥","<(▰˘◡˘▰)>","(⁄ ⁄•⁄ω⁄•⁄ ⁄)","(ง,,• ᴗ •,,)ง ✧"],shock:[",,Ծ‸Ծ,,","(｀･д･´)","Σ( ° △ °|||)︴","┌( ಠ_ಠ)┘","(ﾟДﾟ≡ﾟдﾟ)!?"],sad:["∑(っ °Д °;)っ","＞︿＜","＞△＜","●︿●","(´；ω；`)"],helpless:["◐▽◑","ʅ（´◔౪◔）ʃ","_(:3 」∠)_","_(┐「ε:)_","(/・ω・＼)","(°▽°)ﾉ"]},happy:function(){return Live.randomEmoji.list.happy[Math.floor(Math.random()*Live.randomEmoji.list.happy.length)]},sad:function(){return Live.randomEmoji.list.sad[Math.floor(Math.random()*Live.randomEmoji.list.sad.length)]},shock:function(){return Live.randomEmoji.list.shock[Math.floor(Math.random()*Live.randomEmoji.list.shock.length)]},helpless:function(){return Live.randomEmoji.list.helpless[Math.floor(Math.random()*Live.randomEmoji.list.helpless.length)]}},Live.countdown=function(a){if(!(this instanceof Live.countdown))return new Live.countdown(a);var b=new Date,c=a.endTime;if(!c||!(c instanceof Date)||c.getTime()<=b.getTime())return void console.error("倒计时时间设置错误");var d=setInterval(function(){var e=c.getTime()-b.getTime(),f=Math.floor(e/60/1e3),g=e-60*f*1e3,h=Math.floor(g/1e3);f=f<10?"0"+f:f,h=h<10?"0"+h:h;var i=f+":"+h;return"jQuery Object"===Live.getDomType(a.element)?a.element.html(i):a.element.innerHTML=i,"00"===f&&"00"===h?(clearInterval(d),void(a.callback&&a.callback())):void c.setSeconds(c.getSeconds()-1)},1e3);this.countDown=d},Live.countdown.prototype.clearCountdown=function(){clearInterval(this.countDown)},Live.console={option:{display:{danmu:!1,tv_end:!1,gift:!1,system:!1,tv:!1,sys_gift:!0}},watcher:function(a){console.warn("%c监控:"+a,"color:#FFFFFF;background-color:#4fc1e9;padding:5px;border-radius:7px;line-height:30px;")},info:function(a,b){if("danmu"===a&&Live.console.option.display.danmu){var c=b.info[1],d=b.info[2][0],e=b.info[2][1],f=b.info[4][0],g=b.info[4][1];console.warn("%c(UL:"+f+")"+d+"-"+e+":"+c+" 排名:"+g,"color:#FFFFFF;background-color:#646c7a;padding:5px;border-radius:7px;line-height:30px;")}else if("system"===a&&Live.console.option.display.system){var h=b.msg,i=b.url;console.warn("%c系统通告:"+h+" 地址:"+i,"color:#FFFFFF;background-color:#e74e8f;padding:5px;border-radius:7px;line-height:30px;")}else if("tv_end"===a&&Live.console.option.display.tv_end)console.warn(b);else if("gift"===a&&Live.console.option.display.gift){var j=b.data.giftName,k=b.data.num,l=b.data.uname;console.warn("%c喂食:"+j+" x"+k+" 用户名:"+l,"color:#FFFFFF;background-color:#ff8e29;padding:5px;border-radius:7px;line-height:30px;")}else"sys_gift"===a&&Live.console.option.display.sys_gift&&console.warn("%c系统通告:"+b.tips+" 地址:"+b.url,"color:#FFFFFF;background-color:#e74e8f;padding:5px;border-radius:7px;line-height:30px;")}},Live.createPanel=function(a,b,c,d,e,f){var g=void 0,h=void 0;switch(c){case"click":g=c,h=c;break;case"mouseenter":case"hover":case"mouseover":g="mouseenter",h="mouseleave"}var i=$("<div />").addClass("live-hover-panel arrow-top "+d).attr("id",e);return a.append(b,i),b.off(g).on(g,function(a){function b(a){a.stopPropagation();var c=a&&(a.target||a.srcElement);$(c).hasClass(d)||$(c).parents("."+d).length||(i.addClass("out"),setTimeout(function(){$(window).off(g,b),i.removeClass("out").removeClass("show").css("display","")},300))}return a.stopPropagation(),$(window).click(),i.hasClass("show")?void("function"==typeof $(window)[h]&&$(window)[h]()):(i.addClass("show"),setTimeout(function(){$(window).off(h).on(h,b)},1),void("function"==typeof f&&f()))}),i},Live.liveToast=function(b,c,d){function e(a){var b=a.offsetLeft;return null!==a.offsetParent?b+=e(a.offsetParent):void 0,b}function f(a){var b=a.offsetTop;return null!==a.offsetParent?b+=f(a.offsetParent):void 0,b}var g=c||"info";if("success"===g||"caution"===g||"error"===g||"info"===g){var h=document.createDocumentFragment(),i=document.createElement("div");i.innerHTML="<i class='toast-icon info'></i><span class='toast-text'>"+d+Live.randomEmoji.helpless()+"</span>",i.className="live-toast "+g;var j=null;switch(Live.getDomType(b)){case"HTML Element":j=b;break;case"jQuery Object":j=b[0];break;default:throw new Error(a.consoleText.error+"在使用 Live Toast 时请传入正确的原生 Dom 对象或节点的 jQuery 对象.")}var k={width:$(j).width(),height:$(j).height()},l=e(j),m=f(j);$(i).css({left:l+k.width});var n=0;n=document.body.scrollTop,$(i).css({top:m+k.height}),setTimeout(function(){$(i).addClass("out"),setTimeout(function(){$(i).remove(),h=i=j=k=l=m=n=null},400)},2e3),h.appendChild(i),document.body.appendChild(h);var o=$(window).width(),p=i.offsetWidth,q=i.offsetLeft;0>o-p-q&&$(i).css({left:o-p-10}),o=p=q=null}},Live.doSign={getSignInfo:function(){return $.getJSON(Live.protocol+"//live.bilibili.com/sign/GetSignInfo").promise()},init:function(){chrome.runtime.sendMessage({command:"getOption",key:"doSign"},function(a){if("on"===a.value){var b=store.get("bilibili_helper_userInfo").username,c=void 0;(c={})[b]={today:!1,date:void 0},store.set("bilibili_helper_doSign",c),Live.doSign.getSignInfo().done(function(a){if(0===a.code&&0===a.data.status)Live.doSign.sign(),setInterval(Live.doSign.sign,6e4);else if(0===a.code&&1===a.data.status){var b=store.get("bilibili_helper_userInfo").username,c=void 0;(c=store.get("bilibili_helper_doSign"))[b]={today:!0,date:(new Date).getDate()},store.set("bilibili_helper_doSign",c)}})}})},sign:function sign(){var date=(new Date).getDate(),username=store.get("bilibili_helper_userInfo").username;store.get("bilibili_helper_doSign")[username].today&&store.get("bilibili_helper_doSign")[username].date==date||$.get("/sign/doSign",function(data){var e=JSON.parse(data),msg=void 0;if(0===e.code){msg=new Notification("签到成功",{body:"您获得了"+e.data.text,icon:Live.protocol+"//static.hdslb.com/live-static/images/7.png"});var o;(o=store.get("bilibili_helper_doSign"))[username]={today:!0,date:date},store.set("bilibili_helper_doSign",o),setTimeout(function(){msg.close()},1e4);var spans=$(".body-container").find(".room-left-sidebar .sign-and-mission .sign-up-btn .dp-inline-block span");$(spans[0]).hide(),$(spans[1]).show()}else if(e.code===-500){msg=new Notification(eval("'"+e.msg+"'"),{body:"不能重复签到",icon:Live.protocol+"//static.hdslb.com/live-static/live-room/images/gift-section/gift-1.gif"});var o;(o=store.get("bilibili_helper_doSign"))[username]={today:!0,date:date},store.set("bilibili_helper_doSign",o),setTimeout(function(){msg.close()},1e4)}else msg=new Notification(eval("'"+e.msg+"'"),{body:"",icon:Live.protocol+"//static.hdslb.com/live-static/live-room/images/gift-section/gift-1.gif"}),setTimeout(function(){msg.close()},1e4)})}},Live.Queue=function(a){var b={};return b.id=(new Date).getTime(),b.which=a,b.total=0,b.run=[],b.wait=[],b.error=[],b.success=[],b.cancel=[],b.add=function(a,c){c=void 0===c?"wait":c,b[c].push(a)},b.empty=function(){$("#quiz_helper").find(b.which+"-box *").addClass("hide"),b.run=[],b.wait=[],b.error=[],b.cancel=[],b.success=[]},b.remove=function(a){var c=b[a.state].indexOf(a);c!=-1&&(b[a.state].splice(c,1),a.destory())},b.pushQueue=function(a,c){if(a.state!=c)if(c=void 0===c?"wait":c,b.remove(a),"run"!=c)"success"===c&&(b.total+=a.number),a.state=c,b.add(a,c),a.create_dom().updateMenu();else{if(a.state="run",b.run.length>0){var d=b.run.shift();d.wait().updateMenu(),b.wait.unshift(d)}b.run.push(a),a.create_dom(!0).updateMenu()}},b.updateTotal=function(){Live.bet[b.which+"_sum_number"].text(b.total)},b},Live.Appoint=function(a,b,c,d){var e={};return e.id=(new Date).getTime(),e.which=a,e.rate=b,e.number=c,e.state=void 0===d?"wait":d,e.emit=function(a,b){return e.state=void 0===b?e.state:b,e.create_dom(),Live.bet[a+"_box"].append(e.dom),Live.bet[a+"_queue"].pushQueue(e),Live.bet.checkQueue(),e},e.create_dom=function(c){if(void 0===e.dom){var d=$("<span>").addClass("rate").text(b),f=$("<h4>").addClass("number").text(Live.numFormat(e.number));e.menu=$("<div>").addClass("menu"),e.dom=$("<div>").addClass("count").addClass(e.state).attr({id:e.id,rate:b,number:e.number}).append(f,d,$("<a>").addClass("close"),e.menu),e.updateMenu();var g=Live.bet[a+"_box"].children(".success:last");c?0!=g.length?g.after(e.dom):Live.bet[a+"_box"].prepend(e.dom):Live.bet[a+"_box"].append(e.dom)}return e},e.updateMenu=function(){return e.menu.empty(),e.menu_delete=$('<span class="delete"></span>').off("click").click(function(){Live.bet[e.which+"_queue"].remove(e)}),e.menu_reset=$('<span class="reset"></span>').off("click").click(function(){Live.bet[e.which+"_queue"].pushQueue(e,"wait")}),e.menu_run=$('<span class="run"></span>').off("click").click(function(){Live.bet[e.which+"_queue"].pushQueue(e,"run")}),"run"===e.state||"success"===e.state||"error"===e.state||"cancel"===e.state?e.menu.append(e.menu_reset,e.menu_delete):"wait"===e.state&&e.menu.append(e.menu_run,e.menu_delete),e},e.run=function(a){if(!a)return!1;e.state="run",e.dom.removeClass("cancel wait error success"),e.dom.hasClass("run")||e.dom.addClass("run");var b="blue"===e.which?"a":"b",c=a.silver[b].id,d=a.silver[b].times;return Live.bet.stop&&clearInterval(store.get("bilibili_helper_quiz_bet")[Live.roomId]),d>=e.rate&&$.ajax({url:Live.protocol+"//live.bilibili.com/bet/addBettor",type:"POST",dataType:"json",data:{bankerId:c,amount:e.number,token:Live.getCookie("LIVE_LOGIN_DATA")},complete:function(a){var b=JSON.parse(a.responseText);b.code===-400?"手慢了,剩余可购数量不足！"===b.msg||e.error(b):"ok"===b.msg&&e.success()}}),e},e.error=function(a){return!!a&&(e.state="error",console.error(e.id+":"+a.msg),e.dom.removeClass("cancel wait run success"),e.dom.hasClass("error")||e.dom.addClass("error").attr("title",a.msg),Live.bet[e.which+"_queue"].pushQueue(Live.bet[e.which+"_queue"].run.shift(),"error"),e)},e.success=function(){return e.updateMenu(),e.dom.removeClass("cancel wait error run"),e.dom.hasClass("success")||e.dom.addClass("success"),Live.bet[e.which+"_queue"].pushQueue(Live.bet[e.which+"_queue"].run.shift(),"success"),e},e.wait=function(){return e.state="wait",e.dom.removeClass("cancel success error run"),e.dom.hasClass("wait")||e.dom.addClass("wait"),e},e.cancel=function(){return e.state="cancel",e.dom.removeClass("wait success error run"),e.dom.hasClass("cancel")||e.dom.addClass("cancel"),Live.bet[e.which+"_queue"].pushQueue(Live.bet[e.which+"_queue"].run.shift(),"cancel"),e},e.destory=function(){e.dom.remove(),e.dom=void 0},e.dealWith=function(a){switch(e.state){case"cancel":e.cancel();break;case"success":e.success();break;case"error":e.error(a);break;case"wait":e.wait();break;case"run":e.run(a)}},e},Live.currentRoom=[],Live.treasure={imgInit:!1,timer:0,stop:!1,silverSum:0,correctStr:{g:9,z:2,_:4,Z:2,o:0,l:1,B:8,O:0,S:6,s:6,i:1,I:1},silverSeed:!1,allowCtrl:!0,status:"waiting",finished:!1,boxHidden:!1,panelHidden:!0,panelOut:!1,aniStep:1,countdown:null,taskInfo:{startTime:"",endTime:"",minute:"",award:""},captcha:{img:"",userInput:"",question:"",answer:"",refresh:function(){Live.treasure.captcha.img=Live.treasure.getCaptcha(),Live.treasure.treasureTipAcquire.find("img").attr("src",Live.treasure.captcha.img),Live.treasure.treasureTipAcquire.find("input").val("")}},awardBtn:{text:"领取",bk:"",interval:null,awarding:function(){Live.treasure.awardBtn.bk=Live.treasure.awardBtn.text,Live.treasure.awardBtn.text="领取中.";var a=Live.treasure.treasureTip.find(".acquiring-panel .get-award-btn");a.text(Live.treasure.awardBtn.text),Live.treasure.awardBtn.interval=setInterval(function(){return Live.treasure.awardBtn.text.indexOf("...")>-1?(Live.treasure.awardBtn.text="领取中",void a.text(Live.treasure.awardBtn.text)):(Live.treasure.awardBtn.text+=".",void a.text(Live.treasure.awardBtn.text))},500)},restore:function(){clearInterval(Live.treasure.awardBtn.interval),Live.treasure.awardBtn.text=Live.treasure.awardBtn.bk}},waitingEmoji:Live.randomEmoji.happy(),panelEmoji:Live.randomEmoji.helpless(),init:function(){chrome.runtime.sendMessage({command:"getOption",key:"autoTreasure"},function(a){"on"===a.value&&setTimeout(function(){chrome.runtime.sendMessage({command:"getTreasure"},function(a){if(Live.treasureBtn.find("span").attr("title","正在初始化"),0===Live.mobileVerified)return void Live.helperInfo.setTreasureStatus("error","初始化失败，无法通过手机绑定检测");if(void 0===a.data.roomId){chrome.runtime.sendMessage({command:"setTreasure",data:{uid:Live.roomInfo.UID,roomId:Live.roomInfo.ROOMID,roomShortId:Live.roomInfo.roomShortId,roomTitle:Live.roomInfo.ROOMTITLE,upName:Live.roomInfo.ANCHOR_NICK_NAME,url:location.href}});var b=new Notification("辅助领瓜子功能已经启动",{body:Live.roomInfo.ANCHOR_NICK_NAME+"："+Live.roomInfo.ROOMTITLE,icon:Live.protocol+"//static.hdslb.com/live-static/images/7.png"});if(setTimeout(function(){b.close()},1e4),Live.treasure.silverSum=store.get("bilibili_helper_treasure_silver_count"),Live.treasure.treasureCtrl=$(".treasure-box-ctnr").clone(),Live.treasure.treasureCtrl.attr("id","helperTreasurePlanel"),$(".treasure-box-ctnr").after(Live.treasure.treasureCtrl).hide(),Live.treasure.treasureBox=Live.treasure.treasureCtrl.find(".box-doms"),Live.treasure.treasureTip=Live.treasure.treasureCtrl.find(".box-panel"),Live.treasure.treasureTipWait=Live.treasure.treasureCtrl.find(".box-panel .waiting-panel"),Live.treasure.treasureTipAcquire=Live.treasure.treasureCtrl.find(".box-panel .acquiring-panel"),Live.treasure.captchaInput=Live.treasure.treasureCtrl.find(".get-award-btn"),Live.treasure.canvas=document.createElement("canvas"),Live.treasure.canvas.width=120,Live.treasure.canvas.height=40,document.body.appendChild(Live.treasure.canvas),Live.treasure.context=Live.treasure.canvas.getContext("2d"),Live.treasure.context.font="40px agencyfbbold",Live.treasure.context.textBaseline="top",!window.OCRAD){var c=document.createElement("script");c.src=chrome.extension.getURL("ocrad.min.js"),document.body.appendChild(c)}Live.treasure.treasureBox.find(".hide-box").on("click",function(){Live.treasure.minBox()}),Live.treasure.treasureBox.find(".count-down").on("click",function(){Live.treasure.maxBox()}),Live.treasure.treasureBox.find(".treasure-box").on("click",function(){Live.treasure.showPanel()}),Live.treasure.treasureTip.find(".close-btn,.waiting-panel .live-btn").on("click",function(){Live.treasure.hidePanel()}),Live.treasure.treasureTip.find(".acquiring-panel .get-award-btn").on("click",function(){Live.treasure.getAward()}),Live.treasure.totalTime=1===store.get("bilibili_helper_userInfo").vip?3:5,Live.treasure.checkNewTask(),Live.treasure.treasureTip.find(".close-btn").click(),$(window).on("beforeunload",function(){chrome.runtime.sendMessage({command:"delTreasure"})}),$(document).mousemove(function(a){Live.treasure.stop=!1,Live.treasure.timer=0}),setInterval(function(){++Live.treasure.timer,Live.treasure.timer>=3600&&(Live.treasure.stop=!0,Live.helperInfo.setTreasureStatus("error","离开太久而暂停了该功能，请手动领取后恢复挂机"))},1e3);var d=chrome.runtime.connect({name:chrome.i18n.getMessage("@@extension_id")});d.onMessage.addListener(function(a){switch(a.command){case"updateCurrentTreasure":var b=a.data.time_start,c=a.data.time_end,d=a.data.minute,e=a.data.silver;Live.treasure.setNewTask(b,c,d,e)}}),Live.helperInfo.setTreasureStatus("success","功能已经启动")}else a.data.roomId!=Live.roomId?(Live.helperInfo.setTreasureStatus("wait","已在"+a.data.upName+"的直播间自动领瓜子"),$("#player-container").find(".treasure-box-ctnr").hide("middle"),Live.treasure.checkNewTask(!0)):a.data.roomId===Live.roomId?(Live.helperInfo.setTreasureStatus("wait","本直播间页面已经被打开过"),$("#player-container").find(".treasure-box-ctnr").hide("middle"),Live.treasure.checkNewTask(!0)):Live.treasure.checkNewTask(!0)})},2e3)})},showBox:function(){Live.treasure.boxHidden&&Live.treasure.allowCtrl&&(Live.treasure.boxHidden=!1)},hideBox:function(){Live.treasure.allowCtrl&&!Live.treasure.boxHidden&&(Live.treasure.boxHidden=!0)},minBox:function(){Live.treasure.treasureBox.find(".hide-box,.box-footer,.treasure-box").hide(),Live.treasure.treasureBox.find(".count-down-node").addClass("minimal")},maxBox:function(){Live.treasure.treasureBox.find(".hide-box,.box-footer,.treasure-box").show(),Live.treasure.treasureBox.find(".count-down-node").removeClass("minimal")},showPanel:function(){Live.treasure.allowCtrl&&Live.treasure.panelHidden&&(Live.liveQuickLogin(),Live.treasure.panelHidden=!1,Live.treasure.captcha.userInput="",Live.treasure.waitingEmoji=Live.randomEmoji.happy(),Live.treasure.panelEmoji=Live.randomEmoji.helpless(),Live.treasure.treasureBox.find(".hide-box").hide(),"acquirable"===Live.treasure.status?Live.treasure.makeAcquirable():Live.treasure.makeWaiting(),Live.treasure.treasureTip.show())},hidePanel:function(){Live.treasure.panelHidden||(Live.treasure.allowCtrl=!1,Live.treasure.panelOut=!0,Live.treasure.treasureBox.find(".hide-box").show(),Live.treasure.treasureTip.addClass("out"),setTimeout(function(){Live.treasure.panelHidden=!0,Live.treasure.panelOut=!1,Live.treasure.allowCtrl=!0,Live.treasure.treasureTip.hide(),Live.treasure.treasureTip.removeClass("out")},300))},makeAcquirable:function(){Live.treasure.allowCtrl=!0,Live.treasure.treasureTipAcquire.show(),Live.treasure.treasureTipWait.hide(),Live.treasure.treasureTipAcquire.find(".dp-i-block div").html('请输入计算结果领取 <span class="cyan-text">'+Live.treasure.taskInfo.award+"</span> 银瓜子 "+Live.treasure.panelEmoji),Live.treasure.showBox(),Live.treasure.treasureTip.addClass("acquire"),Live.treasure.playBoxAnimation(),Live.treasure.status="acquirable"},makeWaiting:function(){Live.treasure.treasureTipAcquire.hide(),Live.treasure.treasureTipWait.show(),Live.treasure.treasureTip.removeClass("acquire"),Live.treasure.treasureTipWait.find(".cyan-text").text(Live.treasure.taskInfo.award),Live.treasure.treasureTipWait.find(".panel-title").text("宝箱倒计时"+Live.treasure.waitingEmoji),Live.treasure.status="waiting"},makeFinished:function(){Live.treasure.finished=!0,Live.setCookie("F_S_T_"+window.UID,1),Live.treasure.treasureCtrl&&Live.treasure.treasureCtrl.hide("middle"),Live.helperInfo.setTreasureStatus("finished","今天的瓜子已经领完")},restoreBox:function(){setTimeout(function(){var a=setInterval(function(){Live.treasure.aniStep--,Live.treasure.aniStep<=1&&(clearInterval(a),Live.treasure.aniStep=1),Live.treasure.treasureBox.find(".treasure-box").addClass("animate"+Live.treasure.aniStep),Live.treasure.treasureBox.find(".treasure-box").removeClass("animate"+(Live.treasure.aniStep+1))},100)},250)},playBoxAnimation:function(a){a=a||7;var b=setInterval(function(){return Live.treasure.aniStep++,Live.treasure.aniStep>=a?void clearInterval(b):(Live.treasure.treasureBox.find(".treasure-box").addClass("animate"+Live.treasure.aniStep),void Live.treasure.treasureBox.find(".treasure-box").removeClass("animate"+(Live.treasure.aniStep-1)))},100)},checkNewTask:function(a){Live.treasure.getCurrentTask().done(function(b){return void 0===b.code?void console.error("接口数据不完整：code 丢失."):(b.code=parseInt(b.code,10),b.code===-10017?(Live.helperInfo.setTreasureStatus("finished","今天的瓜子已经领完"),void Live.treasure.makeFinished()):0!==b.code?(console.error("宝箱任务设置失败："+b.msg),b.code===-101||data.code===-99,Live.treasure.makeFinished(),void Live.helperInfo.setTreasureStatus("error",b.msg)):(chrome.runtime.sendMessage({command:"setCurrentTreasure",data:{minute:b.data.minute,silver:b.data.silver,time_end:b.data.time_end,time_start:b.data.time_start}}),void(a||Live.treasure.setNewTask(b.data.time_start,b.data.time_end,parseInt(b.data.minute,10),parseInt(b.data.silver,10)))))}).fail(function(){Live.treasure.checkNewTask()})},setNewTask:function(a,b,c,d){Live.treasure.hidePanel(),Live.treasure.restoreBox(),setTimeout(Live.treasure.makeWaiting,300),Live.treasure.taskInfo.startTime=a,Live.treasure.taskInfo.endTime=b,Live.treasure.taskInfo.minute=c,Live.treasure.taskInfo.award=d,Live.treasure.setCountdown(c)},getAward:function getAward(){function getAward(a,b,c){Live.treasure.imgInit=!1,Live.treasure.stop&&Live.helperInfo.setTreasureStatus("success","功能已经启动"),$.get(Live.protocol+"//live.bilibili.com/FreeSilver/getAward",{time_start:a,time_end:b,captcha:c},function(){},"json").promise().done(function(a){if(0!=a.code)return Live.liveToast(Live.treasure.captchaInput[0],"info",a.msg+Live.randomEmoji.helpless()),Live.treasure.allowCtrl=!0,Live.treasure.awardBtn.restore(),void Live.treasure.checkNewTask();if(1===parseInt(a.data.isEnd,10))return void Live.treasure.makeFinished();Live.liveToast(Live.treasure.captchaInput[0],"success","已成功领取 "+Live.treasure.taskInfo.award+" 银瓜子！"+Live.randomEmoji.happy()),Live.treasure.updateCurrency(),Live.console.watcher("自动领瓜子 成功领取瓜子 "+Live.treasure.taskInfo.award+" 个"),Live.treasure.silverSum+=Live.treasure.taskInfo.award,store.set("bilibili_helper_treasure_silver_count",Live.treasure.silverSum);var b=new Notification("自动领取成功",{body:"领取了"+Live.treasure.taskInfo.award+"个瓜子",icon:Live.protocol+"//static.hdslb.com/live-static/images/7.png"});setTimeout(function(){b.close()},1e4),Live.treasure.checkNewTask(),Live.treasure.awardBtn.restore(),Live.treasure.allowCtrl=!0}).fail(function(d){Live.liveToast($captchaInput[0],"error","系统错误，请稍后再试 "+Live.randomEmoji.sad()),Live.treasure.awardBtn.restore(),Live.treasure.allowCtrl=!0,Live.treasure.getAward(a,b,c)}).always(function(){Live.treasure.captcha.userInput=""})}if(Live.treasure.allowCtrl){Live.treasure.allowCtrl=!1;var img=Live.treasure.treasureTipAcquire.find(".captcha-img");img.load(function(){Live.treasure.context.clearRect(0,0,Live.treasure.canvas.width,Live.treasure.canvas.height),Live.treasure.context.drawImage(img[0],0,0),Live.treasure.captcha.question=Live.treasure.correctQuestion(OCRAD(Live.treasure.context.getImageData(0,0,120,40))),Live.treasure.captcha.answer=eval(Live.treasure.captcha.question),Live.treasure.treasureTipAcquire.find("input").val(Live.treasure.captcha.answer);var data=Live.treasure.taskInfo;Live.treasure.captcha.userInput=Live.treasure.captcha.answer;var captcha=Live.treasure.captcha.answer;!Live.treasure.stop&&getAward(data.startTime,data.endTime,captcha)}),Live.treasure.captcha.refresh(),img.error(function(){Live.treasure.captcha.refresh()})}},updateCurrency:function(){if(!isNaN(parseInt(Live.treasure.silverSeed,10))){var a=Live.treasure.silverSeed+Live.treasure.taskInfo.award;Live.treasure.silverSeed=a}},setCountdown:function(a){Live.treasure.countdown&&Live.treasure.countdown.clearCountdown();var b=new Date,c=b.getMinutes()+a;b.setMinutes(c),Live.treasure.countdown=new Live.countdown({endTime:b,element:Live.treasure.treasureCtrl.find(".count-down-node"),callback:function(){Live.treasure.makeAcquirable(),Live.treasure.treasureBox.find(".treasure-box").click(),Live.treasure.treasureTip.find(".acquiring-panel .get-award-btn").click()}}),Live.treasure.allowCtrl=!0},correctQuestion:function(a){var b="",a=a.trim();for(var c in a){var d=Live.treasure.correctStr[a[c]];b+=void 0!=d?d:a[c]}return b},getCurrentTask:function(){return $.get(Live.protocol+"//live.bilibili.com/FreeSilver/getCurrentTask",{},function(){},"json").promise()},getSurplus:function(){return $.get(Live.protocol+"//live.bilibili.com/FreeSilver/getSurplus",{},function(){},"json").promise()},getCaptcha:function(){return Live.protocol+"//live.bilibili.com/freeSilver/getCaptcha?ts="+Date.now()}},Live.chat={maxLength:20,text:"",beat:!1,colorValue:{white:"0xffffff",red:"0xff6868",blue:"0x66ccff",pink:"0xfca992",cyan:"0x00fffc",green:"0x7eff00",yellow:"0xffed4f",orange:"0xff9800"},danmuMode:{top:5,scroll:1},hideStyle:{chat:{title:"聊天内容",css:"#chat-msg-list .chat-msg{display:none;}",value:"off"},gift:{title:"礼物信息",css:"#chat-msg-list .gift-msg,.gift-msg-1000{display:none !important;}",value:"off"},vipEnterMsg:{title:"老爷进场",css:"#chat-msg-list .system-msg{padding:0 10px;height:auto;}#chat-msg-list .system-msg .live-icon,#chat-msg-list .system-msg .welcome,#chat-msg-list .system-msg .admin.square-icon,#chat-msg-list .system-msg .v-middle{display: none;}",value:"off"},liveTitleIcon:{title:"成就头衔",css:"#chat-msg-list .chat-msg .check-my-title{display:none;}",value:"off"},mediaIcon:{title:"粉丝勋章",css:"#chat-msg-list .chat-msg .fans-medal-item{display:none;}",value:"off"},userLevel:{title:"用户等级",css:"#chat-msg-list .chat-msg .user-level-icon{display:none;}",value:"off"},chatBg:{title:"聊天背景",css:"#chat-list-ctnr{background:#f8f8f8!important;}",value:"off"},superGift:{title:"礼物连击",css:".live-haruna-ctnr{display:none;}",value:"off"},announcement:{title:"系统通告",css:"#chat-msg-list .announcement-container{display:none;}",value:"off"}},displayOption:[],init:function(){Live.chat.chat_ctrl_panel=$("#chat-ctrl-panel"),Live.chat.counter=Live.chat.chat_ctrl_panel.find(".danmu-length-count"),chrome.runtime.sendMessage({command:"getOption",key:"beat"},function(a){"on"===a.value&&Live.BBQ&&Live.BBQ.level>=10&&Live.user&&"number"==typeof Live.user.user_level_rank&&Live.user.user_level_rank<=25e3&&(Live.chat.beat=!0)}),chrome.runtime.sendMessage({command:"getOption",key:"danmu"},function(a){"on"===a.value&&($("#chat-ctrl-panel").append($('<div class="room-silent-merge dp-none p-absolute p-zero help-chat-shade" style="display:block;"><p><span class="hint-text"></span>弹幕增强功能正在初始化</p></div>')),setTimeout(Live.chat.initDanmu,2e3))}),chrome.runtime.sendMessage({command:"getOption",key:"chatDisplay"},function(a){"on"===a.value&&Live.chat.initChatDisplay(!0)})},sendDamu:function(){if(Live.chat.text.length>0){$(".color-select-panel").attr("data-dd"),$(".mode-select-panel").find("a.active").attr("class").split(" ",3)[1];console.log(chrome.windows),console.log($("#player_object")[0])}},initDanmu:function(){var a=Live.chat.chat_ctrl_panel.find(".chat-ctrl-btns .btns .emoji"),b=a.clone().addClass("helper-emoji");a.before(b).remove();var c=Live.chat.chat_ctrl_panel.find(".ctrl-panels .emoji-panel"),d=c.clone().addClass("helper-emoji-list");c.before(d).remove();var e=Live.chat.chat_ctrl_panel.find(".chat-ctrl-btns .btns .hot-words"),f=e.clone().addClass("helper-hot-words");e.before(f).remove();var g=Live.chat.chat_ctrl_panel.find(".ctrl-panels .hot-words-panel"),h=g.clone().addClass("helper-hot-words-list");g.before(h).remove();var i=Live.chat.chat_ctrl_panel.find(".danmu-sender #danmu-textbox");Live.chat.maxLength=i.attr("maxlength"),Live.chat.helper_text_area=i.clone().addClass("helper-text-area").removeAttr("maxlength"),i.before(Live.chat.helper_text_area).remove();var j=Live.chat.chat_ctrl_panel.find(".danmu-sender #danmu-send-btn"),k=j.clone().addClass("helper-send-btn");j.before(k).remove(),Live.chat.maxLength=parseInt(store.get("bilibili_helper_userInfo").userLevel)>=20?30:20,Live.chat.counter.text("0 / 1 + 0"),Live.scriptOptions.chat={colorValue:Live.chat.colorValue,danmuMode:Live.chat.danmuMode,maxLength:Live.chat.maxLength},b.on("click",function(){if("none"===d.css("display")){var a=function b(a){var c=a&&(a.target||a.srcElement);c&&c.className.indexOf("emoji-panel")>-1||$(".emoji-panel").fadeOut(200,function(){$(window).off("click",b)})};d.show(),setTimeout(function(){$(window).on("click",a)},1)}}),f.on("click",function(){if("none"===h.css("display")){var a=function b(a){var c=a&&(a.target||a.srcElement);c&&c.className.indexOf("hot-words-panel")>-1||$(".hot-words-panel").fadeOut(200,function(){$(window).off("click",b)})};h.show(),setTimeout(function(){$(window).on("click",a)},1)}}),Live.chat.helper_text_area.on("keydown",function(a){var b=Live.chat.helper_text_area.val().trim();return 13===a.keyCode&&""===b?(a.preventDefault(),Live.liveToast(k,"info","请输入弹幕后再发送~"),Live.chat.helper_text_area.val(""),!1):13===a.keyCode&&""!=b?(a.preventDefault(),0===Live.chat.text.length?(Live.chat.helper_text_area.val(b.substr(0,b.length)),k.click()):(Live.chat.text+=b,Live.chat.helper_text_area.val(""),Live.chat.updateCounter("")),!1):void Live.chat.updateCounter(b)}),Live.chat.helper_text_area.on("keyup",function(){var a=Live.chat.helper_text_area.val().trim();Live.chat.updateCounter(a)}),d.on("click","a",function(){var a=Live.chat.helper_text_area.val().trim();Live.chat.helper_text_area.val(a+$(this).text()),Live.chat.helper_text_area.focus(),Live.chat.updateCounter(Live.chat.helper_text_area.val().trim())}),h.on("click","a",function(){var a=Live.chat.helper_text_area.val().trim();Live.chat.helper_text_area.val(a+$(this).text()),Live.chat.helper_text_area.focus(),Live.chat.updateCounter(Live.chat.helper_text_area.val().trim())}),Live.chat.chat_ctrl_panel.find(".help-chat-shade").hide("middle")},initChatHelper:function(){Live.chat.chat_ctrl_panel.find("#chatHelper").remove(),
Live.chat.chatHelper=$('<div id="chatHelper"></div>').css("background-image","url("+chrome.extension.getURL("imgs/jinkela.png")+")"),Live.chat.chatDisplayBlock=$('<div class="chat-display"><h2 class="panel-title">屏蔽选项</h2></div>'),Live.chat.chatHelperWindow=$('<div id="chatHelperWindow" class="chat-helper-panel ctrl-panel"></div>').hide(),Live.each(Live.chat.hideStyle,function(a){var b=$('<div class="display-option"><span class="title">'+Live.chat.hideStyle[a].title+'</span><div class="option"><div class="button '+a+("on"===Live.chat.hideStyle[a].value?" on":"")+'" option="on">屏蔽</div><div class="button '+a+("off"===Live.chat.hideStyle[a].value?" on":"")+'" option="off">显示</div></div></div>');Live.chat.chatDisplayBlock.append(b)}),Live.chat.chatHelperWindow.append(Live.chat.chatDisplayBlock),Live.chat.chat_ctrl_panel.append(Live.chat.chatHelper,Live.chat.chatHelperWindow),Live.chat.chatHelper.off("click").on("click",function(){if("none"===Live.chat.chatHelperWindow.css("display")){var a=function b(a){var c=a&&(a.target||a.srcElement);!$(c).hasClass("chat-helper-panel")&&!$(c).parents("#chatHelperWindow").length&&$(".chat-helper-panel").fadeOut(200,function(){$(window).off("click",b)})};Live.chat.chatHelperWindow.show(),setTimeout(function(){$(window).on("click",a)},1)}}),Live.chat.chatDisplayBlock.find(".display-option .option .button").off("click").on("click",function(){var a=$(this).attr("class").split(" ")[1];if($(this).hasClass("on"))return!1;$("."+a).removeClass("on"),$(this).addClass("on");var b=$(this).attr("option");if("on"===b){var c=Live.chat.displayOption.indexOf(a);c===-1&&Live.chat.displayOption.push(a)}else{var c=Live.chat.displayOption.indexOf(a);c!=-1&&Live.chat.displayOption.splice(c,1)}var d=void 0;(d=store.get("bilibili_helper_chat_display"))[Live.roomId]=Live.chat.displayOption,store.set("bilibili_helper_chat_display",d),Live.chat.initChatDisplay()})},initChatDisplay:function(a){chrome.runtime.sendMessage({command:"getOption",key:"displayOption"},function(b){var c=store.get("bilibili_helper_chat_display")[Live.roomId]||[],d=c.length?c:[],e=JSON.parse(b.value),f=void 0,g=void 0,h=0;d.length>e.length?(f=d,g=e):(f=e,g=d),h=f.length;for(var i=0;i<f.length;++i)g.indexOf(f[i])>=0&&--h;h?d.length?Live.chat.displayOption=d:Live.chat.displayOption=e:(store["delete"]("bilibili_helper_chat_display",Live.roomId),Live.chat.displayOption=e);var j=Live.chat.displayOption;Live.each(Live.chat.hideStyle,function(a){var b=j.indexOf(a);b<0?($(".chatDisplayStyle_"+a).remove(),Live.chat.hideStyle[a].value="off"):0===$(".chatDisplayStyle_"+a).length&&(Live.chat.addStylesheet(a),Live.chat.hideStyle[a].value="on")}),a&&Live.chat.initChatHelper()})},addStylesheet:function(a){var b=document.createElement("style");b.setAttribute("class","chatDisplayStyle_"+a),b.setAttribute("type","text/css"),b.appendChild(document.createTextNode(Live.chat.hideStyle[a].css)),document.head?document.head.appendChild(b):document.documentElement.appendChild(b)},updateCounter:function(a){var b=parseInt(a.length/Live.chat.maxLength),c=b>0?a.length%Live.chat.maxLength:0;Live.chat.counter.text(a.length+" / "+(0===b?1:b)+" + "+c)}},Live.notise={init:function(){var a={};Live.getRoomInfo().done(function(b){a.uid=b.data.UID,a.roomId=b.data.ROOMID,a.roomShortI=location.pathname.substr(1),a.roomTitle=b.data.ROOMTITLE,a.upName=b.data.ANCHOR_NICK_NAME,a.url=location.href;var c=$("<div>").addClass("mid-part").append('<i class="live-icon-small favourite p-relative" style="top: 1px"></i><span>特别关注</span>').click(function(){$(this).find("i").hasClass("favourited")?chrome.runtime.sendMessage({command:"setNotFavourite",id:a.roomId},function(a){a.data&&(c.find("span").html("特别关注"),c.find("i").removeClass("favourited"))}):chrome.runtime.sendMessage({command:"setFavourite",upInfo:a},function(a){a.data&&c.find("span").html("已特别关注"),c.find("i").addClass("favourited")})}).hover(function(){$(this).attr("title","关注之后再特别关注会在主播开播时进行推送哦"+Live.randomEmoji.happy())});chrome.runtime.sendMessage({command:"getFavourite"},function(a){a.data.indexOf(parseInt(Live.roomId))!=-1&&(c.find("span").html("已特别关注"),c.find("i").addClass("favourited"))}),$(".attend-button").find(".left-part").after(c)})}},Live.smallTV={tvList:{},count:0,reward:{},rewardList:{1:{title:"大号小电视"},2:{title:"蓝白胖次道具"},3:{title:"B坷垃"},4:{title:"喵娘"},5:{title:"便当"},6:{title:"银瓜子"},7:{title:"辣条"}},init:function(){Live.smallTV.reward=store.get("bilibili_helper_tvs_reward"),Live.smallTV.count=store.get("bilibili_helper_tvs_count")},getTVdata:function(a){if(Live.smallTV.tvList[a]){var b=void 0!=a?Live.smallTV.tvList[a].iter:void 0;console.log("获取第"+(b+1)+"个小电视数据");var c=void 0!=b&&Live.smallTV.tvList[a].tv[b];return c}},get:function(a){$.getJSON("/SmallTV/index",{roomid:a,_:(new Date).getTime()}).promise().done(function(b){if(0==b.code)if(b.data.unjoin.length||b.data.join.length,Live.console.watcher("监测到小电视抽奖活动 直播间【"+a+"】"),b.data.lastid)Live.console.watcher("小电视活动 直播间【"+a+"】 抽奖已经结束");else{Live.console.watcher("小电视活动 直播间【"+a+"】 成功获取抽奖信息");var c=b.data.unjoin;void 0==Live.smallTV.tvList[a]&&(Live.smallTV.tvList[a]={tv:[],iter:0});for(var d=0;d<c.length;++d){var e=c[d];e.finished=!1,e.joined=!1,e.drawIn=!1,Live.smallTV.tvList[a].tv.push(e),Live.smallTV.notify(a)}}}).fail(function(b){Live.smallTV.get(a)})},notify:function(a){$.getJSON("/SmallTV/index",{roomid:a,_:(new Date).getTime()}).promise().done(function(b){if(0==b.code)if(b.data.unjoin.length||b.data.join.length,Live.console.watcher("监测到小电视抽奖活动 直播间【"+a+"】"),b.data.lastid)Live.console.watcher("小电视活动 直播间【"+a+"】 抽奖已经结束");else{Live.console.watcher("小电视活动 直播间【"+a+"】 成功获取抽奖信息");var c=b.data.unjoin;void 0==Live.smallTV.tvList[a]&&(Live.smallTV.tvList[a]={tv:[],iter:0}),c.length>0&&chrome.runtime.sendMessage({command:"tvNotification",data:{roomId:a}},function(a){})}}).fail(function(b){Live.smallTV.notify(a)})}},Live.watcher={able:!1,options:{tv:!1},notifyStatus:!1,notifyOptions:{tv:!1},panelDOM:{ty:void 0},init:function(a){chrome.runtime.sendMessage({command:"getOption",key:"watcher"},function(b){"on"===b.value&&setTimeout(function(){chrome.runtime.sendMessage({command:"getWatcherRoom"},function(b){Live.watcherBtn.find("span").attr("title","正在初始化"),Live.mobileVerified?(void 0===b.data.roomId?(Live.getRoomInfo().done(function(a){chrome.runtime.sendMessage({command:"setWatcherRoom",data:{uid:a.data.UID,roomId:a.data.ROOMID,roomShortId:location.pathname.substr(1),roomTitle:a.data.ROOMTITLE,upName:a.data.ANCHOR_NICK_NAME,url:location.href}})}),chrome.runtime.sendMessage({command:"getOption",key:"watchList"},function(b){var c=b.value?JSON.parse(b.value):[];Live.scriptOptions.watcher=[],Live.each(c,function(a){var b=Live.watcher.options[c[a]];b===!1&&(Live.watcher.options[c[a]]=!0,Live.scriptOptions.watcher.push(c[a]),Live.console.watcher("启动:"+c[a]))}),Live.watcher.initRewardPanel(),$(window).on("beforeunload",function(a){chrome.runtime.sendMessage({command:"delWatcherRoom"})}),Live.watcher.options.tv&&(Live.smallTV.init(),Live.watcher.updateReward("tv")),document.addEventListener("sendMessage",function(a){var b=store.get("bilibili_helper_message");return!!b.cmd&&void Live.watcher.classify(b)}),Live.watcher.initData(),"function"==typeof a&&a()}),chrome.runtime.sendMessage({command:"getOption",key:"watchNotify"},function(a){Live.watcher.notifyStatus="on"===a.value}),chrome.runtime.sendMessage({command:"getOption",key:"watchNotifyList"},function(a){var b=a.value?JSON.parse(a.value):[];Live.each(b,function(a){var c=Live.watcher.notifyOptions[b[a]];c||(Live.watcher.notifyOptions[b[a]]=!0)})}),Live.helperInfo.setWatcherStatus("success","功能已经启动")):(chrome.runtime.sendMessage({command:"getOption",key:"watchList"},function(a){var b=a.value?JSON.parse(a.value):[];Live.each(b,function(a){Live.watcher.options[b[a]]=!0}),Live.watcher.initRewardPanel()}),Live.helperInfo.setWatcherStatus("wait","监控功能已在【"+b.data.upName+"】的直播间启动"),"function"==typeof a&&a()),Live.watcher.able=!0):Live.helperInfo.setWatcherStatus("error","初始化失败，无法通过手机绑定检测")})},2e3)})},initData:function(){chrome.runtime.sendMessage({command:"getOption",key:"watcherDataClean"},function(a){var b=store.get("bilibili_helper_watcher_data_date"),c=(new Date).getFullYear(),d=(new Date).getMonth()+1,e=(new Date).getDate(),f=c+"-"+d+"-"+e;"0"!==a.value&&("1"===a.value?(void 0===b?Live.watcher.cleanData():b!=f&&Live.watcher.cleanData(),store.set("bilibili_helper_watcher_data_date",f)):"2"===a.value&&(!b||Live.getDateDiff(b,f)>=7)&&(Live.watcher.cleanData(),store.set("bilibili_helper_watcher_data_date",f)))})},cleanData:function(){store.set("bilibili_helper_tvs_reward",{}),store.set("bilibili_helper_tvs_count",0),store.set("bilibili_helper_lottery_reward",{}),store.set("bilibili_helper_lottery_count",0)},classify:function(a){switch(a.cmd){case"DANMU_MSG":Live.console.info("danmu",a);break;case"SYS_MSG":Live.console.info("system",a),Live.watcher.options.tv&&Live.watcher.dealWithSysMsg(a);break;case"TV_END":break;case"SEND_GIFT":Live.console.info("gift",a);break;case"SYS_GIFT":Live.console.info("sys_gift",a),Live.watcher.options.lottery&&Live.watcher.dealWithSysGift(a)}},dealWithSysMsg:function(a){var b=a.msg;if("【"===b[0]&&""!=a.url&&1===a.rep&&2===a.styleType){var c=new RegExp("【([\\S]+)】在直播间【([\\d]+)】"),d=c.exec(b),e=d[2];Live.getRoomIdByUrl(e,function(a){Live.smallTV.notify(a)})}},dealWithSysGift:function(a){var b=a.tips;if("string"==typeof b||a.giftId)switch(a.giftId){case 39:var c=new RegExp("在直播间【([0-9]+)】"),d=c.exec(b),e=d[1];Live.getRoomIdByUrl(e,function(a){Live.beat.getBeat(a).done(function(b){if(b.data[39].id){var c=b.data[39].content;Live.beat.sendBeat(a,c);var d=Live.lottery.reward[6];void 0===d&&(d=0),Live.lottery.reward[6]=++d,store.set("bilibili_helper_lottery_reward",Live.lottery.reward),Live.watcher.updateReward("lottery")}})})}},pushNotification:function(a,b,c,d){var e=new Notification(b,{body:c,icon:d});setTimeout(function(){e.close()},5e3)},initRewardPanel:function(){if(Live.watcher.options.tv){Live.watcher.panelDOM.tv=$("<div />").addClass("tv reward-panel");var a=$("<span />").addClass("reward-counter"),b=$("<div />").addClass("reward-title").text("小电视抽奖").append(a),c=$("<div />").addClass("reward-container");Live.watcher.panelDOM.tv.append(b,c)}},updateReward:function(a){var b={},c=0,d=void 0;if(Live.watcher.able){switch(a){case"tv":b=store.get("bilibili_helper_tvs_reward"),c=store.get("bilibili_helper_tvs_count"),d=Live.smallTV.rewardList}if(d&&Live.watcher.panelDOM[a]){Live.watcher.panelDOM[a].find(".reward-container").empty();var e=0;Live.each(b,function(c){++e;var f=d[c]?d[c].title:Live.giftList[c]?Live.giftList[c].title:"神秘礼物",g=b[c],h=$("<span />").addClass("gift").text(f+"x"+Live.numFormat(g));Live.watcher.panelDOM[a].find(".reward-container").append(h)}),e||Live.watcher.panelDOM[a].find(".reward-container").append($('<span class="gift">没有获奖记录</span>'))}Live.watcher.panelDOM[a]&&Live.watcher.panelDOM[a].find(".reward-counter").text(c+" 次")}}},Live.giftpackage={giftPackageStatus:0,panelStatus:!1,giftPackageData:{},giftPackageMap:{},giftSendAll:{open:function(){Live.giftpackage.sendLineSection.empty();var a=[];Live.each(Live.giftpackage.giftPackageMap,function(b){var c=Live.giftpackage.giftPackageMap[b];Live.each(c,function(d){var e=c[d],f=$("<span />").addClass("package-item").attr({title:e.gift_name,gift_id:b,bag_id:e.id}),g=$("<div />").addClass("gift-item gift-item-package gift-"+b);e.expireat>0?g.html('<span class="expires">'+e.expireat+"天</span>"):0===e.expireat?g.html('<span class="expires">今天</span>'):g.html('<span class="expires">永久</span>');var h=$("<div />").addClass("gift-count").text("x"+e.gift_num);f.append(g,h),Live.giftpackage.sendLineSection.append(f),a.push(e)})}),a.length>0&&($(document).click(),Live.giftpackage.sendLinePanel.show(),Live.giftpackage.giftSendLinePanel.giftsData=a)}},giftSendLinePanel:{line_id:null,giftsData:{},outTimeout:null,open:function(a){$(document).click(),Live.giftpackage.giftSendLinePanel.line_id=a,Live.giftpackage.giftSendLinePanel.giftsData=Live.giftpackage.giftPackageMap[a];var b=Live.giftpackage.giftSendLinePanel.giftsData;Live.giftpackage.sendLinePanel.show(),Live.giftpackage.sendLineSection.empty(),Live.each(Live.giftpackage.giftSendLinePanel.giftsData,function(c){var d=b[c],e=$("<span />").addClass("package-item").attr({title:d.gift_name,gift_id:a,bag_id:d.id}),f=$("<div />").addClass("gift-item gift-item-package gift-"+a);d.expireat>0?f.html('<span class="expires">'+d.expireat+"天</span>"):0===d.expireat?f.html('<span class="expires">今天</span>'):f.html('<span class="expires">永久</span>');var g=$("<div />").addClass("gift-count").text("x"+d.gift_num);e.append(f,g),Live.giftpackage.sendLineSection.append(e)})},close:function(){var a=Live.giftpackage.giftSendLinePanel;Live.giftpackage.sendLinePanel.addClass("hide out"),a.outTimeout=setTimeout(function(){Live.giftpackage.sendLinePanel.removeClass("hide out").css("display","")},380)},sendLine:function(a){if("keyup"!==a.type||13===a.keyCode){var b=Live.giftpackage.giftSendLinePanel.giftsData,c={complete:0};Live.giftpackage.giftSendLinePanel.send(b,c,Live.giftpackage.giftSendLinePanel.callback)}},send:function(a,b,c){var d=a[b.complete];$.ajax({url:"/giftBag/send",type:"POST",data:{giftId:d.gift_id,roomid:Live.roomId,ruid:Live.roomInfo.MASTERID,num:d.gift_num,coinType:"silver",Bag_id:d.id,timestamp:Date.now(),rnd:store.get("bilibili_helper_live_danmu_rnd",Live.roomId),token:Live.getCookie("LIVE_LOGIN_DATA")||""},dataType:"JSON",success:function(e){0===e.code?"function"==typeof c&&c(a,b):1===e.code?(console.error("系统繁忙，正在重试"),setTimeout(function(){Live.giftpackage.giftSendLinePanel.send(d)},500)):console.error(e)}})},callback:function(a,b){++b.complete,b.complete===a.length?Live.giftpackage.giftSendLinePanel.close():Live.giftpackage.giftSendLinePanel.send(a,b,Live.giftpackage.giftSendLinePanel.callback)}},giftSendPanel:{giftData:{giftId:"",giftName:"",giftNum:0,type:"silver",count:1,bagId:0},show:!1,out:!1,outTimeout:null,toggleGiftPackage:function(a){a.stopPropagation(),Live.liveQuickLogin(),Live.giftpackage.panelStatus?Live.giftpackage.closeGiftPackagePanel():1===Live.giftpackage.giftPackageStatus?Live.giftpackage.giftPackageNewPanel.open():Live.giftpackage.openGiftPackagePanel()},open:function(a,b,c,d){var e=Live.giftpackage.giftSendPanel;e.giftData.giftId=a,e.giftData.giftName=b,e.giftData.giftNum=c,e.giftData.count=c,e.giftData.bagId=d,$(document).click(),Live.giftpackage.sendNumberGroup.empty();for(var f=["1","5","10","30","50","5%","10%","30%","50%","MAX"],g=0;g<f.length;++g){var h=$("<span />").addClass("number-btn").text(f[g]);g<5&&c<parseInt(f[g])&&h.addClass("disabled"),Live.giftpackage.sendNumberGroup.append(h),h.off("click").on("click",function(a){var b=$(this).text();switch(b){case"1":case"5":case"10":case"30":case"50":var d=parseInt(b);c<d&&(d=c),Live.giftpackage.sendGiftInput.val(d);break;case"5%":case"10%":case"30%":case"50%":var d=Math.ceil(.01*parseInt(b.substr(0,b.length-1))*c);c<d&&(d=c),Live.giftpackage.sendGiftInput.val(d);break;case"MAX":Live.giftpackage.sendGiftInput.val(c)}})}Live.giftpackage.sendGiftImg.attr("class","gift-img float-left gift-"+a),Live.giftpackage.sendGiftInfo.text("您的包裹中还剩 "+c+" 个可用"),Live.giftpackage.sendGiftInput.val(c).focus(),Live.giftpackage.sendPanel.show(),setTimeout(function(){$(document).on("click",a);var a=function b(a){var c=a&&(a.target||a.srcElement);$(c).hasClass("panel-content")||$(c).parents(".panel-content").length||($(document).off("click",b),Live.giftpackage.giftSendPanel.close())}},1)},close:function(){var a=Live.giftpackage.giftSendPanel;Live.giftpackage.sendPanel.addClass("hide out"),a.outTimeout=setTimeout(function(){Live.giftpackage.sendPanel.removeClass("hide out").css("display","")},380)},sendGift:function(a){if("keyup"!==a.type||13===a.keyCode){var b=a.target||a.srcElement,c=Live.giftpackage.giftSendPanel.giftData;c.count=Live.giftpackage.sendGiftInput.val();var d=parseInt(c.count,10),e=store.get("bilibili_helper_live_danmu_rnd",Live.roomId);return isNaN(d)?(c.count="",void Live.liveToast(Live.giftpackage.sendGiftInput,"error","请填写正确的送礼数量 "+Live.randomEmoji.helpless())):void $.ajax({url:"/giftBag/send",type:"POST",data:{giftId:c.giftId,roomid:Live.roomId,ruid:Live.roomInfo.MASTERID,num:c.count,coinType:c.type,Bag_id:c.bagId,timestamp:Date.now(),rnd:e,token:Live.getCookie("LIVE_LOGIN_DATA")||""},dataType:"JSON",success:function(a){if(0===a.code){var d=function(a){var b={uname:a.data.uname,num:a.data.num,giftName:a.data.giftName,giftId:a.data.giftId};e.innerHTML='<div class="gift-msg-item"><span class="user-name-low">'+b.uname+'</span> <span class="action">赠送'+b.giftName+'</span><div class="gift-img gift-'+b.giftId+'" role="img"></div>X <span class="gift-count">'+b.num+"</span></div>"};Live.liveToast(b,"info","Gift-sending is successful. "+Live.randomEmoji.helpless()),1===a.data.data.giftType&&$("#player_object")[0].sendGift(a.data.data.giftId,a.data.data.num);var e=document.getElementById("gift-msg-1000");parseInt(a.data.data.num,10)<10&&d(a.data),a.data.data.notice_msg&&$("#player_object")[0].noticeGift(a.data.data.notice_msg),c.giftNum=a.data.remain,Live.giftpackage.sendGiftInfo.text("您的包裹中还剩 "+c.giftNum+" 个可用"),Live.giftpackage.sendGiftInput.focus(),0===a.data.remain&&(Live.giftpackage.sendGiftInput.val(0),Live.giftpackage.giftSendPanel.close())}else 1===a.code?console.error("系统繁忙..."):a.code===-400&&"余额不足"===a.msg?Live.giftpackage.giftSendPanel.close():b&&Live.liveToast(b,"caution",a.msg+" "+Live.randomEmoji.sad())},error:function(a){b&&Live.liveToast(b,"error",Live.randomEmoji.sad()+" 送礼失败："+a.statusText+" "+Live.randomEmoji.sad())}})}}},giftPackageNewPanel:{data:[],show:!1,out:!1,outTimeout:null,open:function(){Live.giftpackage.getSendGift(function(a){0===a.code&&(Live.giftpackage.giftPackageNewPanel.data=a.data)})},close:function(){var a=Live.giftpackage.giftPackageNewPanel;a.out=!0,a.outTimeout=setTimeout(function(){a=null,Live.giftpackage.giftPackageStatus=2,Live.giftpackage.openGiftPackagePanel()},380)}},init:function(){chrome.runtime.sendMessage({command:"getOption",key:"giftpackage"},function(a){"on"===a.value&&($("#gift-panel").find(".control-panel .items-package").hide(),Live.giftpackage.controlPanel=$("#gift-panel").find(".control-panel"),Live.giftpackage["package"]=Live.giftpackage.controlPanel.find(".items-package").clone().css("display","inline-block"),Live.giftpackage.controlPanel.find(".items-package").after(Live.giftpackage["package"]),Live.giftpackage.packageBtn=Live.giftpackage["package"].find(".link"),Live.giftpackage.packagePanel=Live.giftpackage["package"].find(".gifts-package-panel"),Live.giftpackage.packageContent=Live.giftpackage["package"].find(".gifts-package-content"),Live.giftpackage.packagePanelTitle=Live.giftpackage.packagePanel.find(".gifts-package-title"),Live.giftpackage.packagePanelCleanBtn=$("<span />").addClass("gifts-package-clean").text("清空包裹"),Live.giftpackage.packagePanelTitle.append(Live.giftpackage.packagePanelCleanBtn),Live.giftpackage.sendPanel=$("#gift-package-send-panel"),Live.giftpackage.sendContent=$("#gift-package-send-panel").find(".panel-content"),Live.giftpackage.sendGiftImg=Live.giftpackage.sendPanel.find(".gift-img"),Live.giftpackage.sendGiftInfo=Live.giftpackage.sendPanel.find(".gift-info p"),Live.giftpackage.sendGiftInput=Live.giftpackage.sendPanel.find("input").clone(),Live.giftpackage.sendPanel.find("input").after(Live.giftpackage.sendGiftInput).hide(),Live.giftpackage.sendGiftBtn=Live.giftpackage.sendPanel.find("button").clone(),Live.giftpackage.sendPanel.find("button").after(Live.giftpackage.sendGiftBtn).hide(),Live.giftpackage.sendNumberGroup=$("<div />").addClass("number-group"),Live.giftpackage.sendContent.append(Live.giftpackage.sendNumberGroup),Live.giftpackage.sendLinePanel=$("#gift-package-send-panel").clone().attr("id","gift-package-send-line-panel"),Live.giftpackage.sendPanel.after(Live.giftpackage.sendLinePanel),Live.giftpackage.sendLineSection=Live.giftpackage.sendLinePanel.find(".section").empty(),Live.giftpackage.sendLinePanel.find("input").hide(),Live.giftpackage.sendLineBtn=Live.giftpackage.sendLinePanel.find("button:eq(1)"),Live.giftpackage.packageBtn.off("click").on("click",function(a){Live.giftpackage.openGiftPackagePanel()}),Live.giftpackage.sendContent.find(".close-btn").off("click").on("click",function(a){Live.giftpackage.giftSendPanel.close()}),Live.giftpackage.sendLinePanel.find(".close-btn").off("click").on("click",function(a){Live.giftpackage.giftSendLinePanel.close()}),Live.giftpackage.sendGiftInput.off("keydown").on("keydown",function(a){13===a.keyCode&&""!=Live.giftpackage.sendGiftInput.val()&&Live.giftpackage.giftSendPanel.sendGift(a)}),Live.giftpackage.sendGiftBtn.off("click").on("click",function(a){Live.giftpackage.giftSendPanel.sendGift(a)}),Live.giftpackage.sendLineBtn.off("click").on("click",function(a){Live.giftpackage.giftSendLinePanel.sendLine(a)}),Live.scriptOptions.giftpackage=!0)})},initGiftsDOM:function(a){Live.giftpackage.packageContent.empty(),Live.giftpackage.packagePanel.removeClass("big"),Live.each(a,function(b){var c=a[b],d=$("<div />").addClass("gift-item-group").attr("gift_id",b);Live.each(c,function(a){var e=c[a],f=$("<span />").addClass("package-item").attr({title:e.gift_name,gift_id:b,bag_id:e.id}),g=$("<div />").addClass("gift-item gift-item-package gift-"+b);e.expireat>0?g.html('<span class="expires">'+e.expireat+"天</span>"):0===e.expireat?g.html('<span class="expires">今天</span>'):g.html('<span class="expires">永久</span>');var h=$("<div />").addClass("gift-count").text("x"+e.gift_num);f.append(g,h),d.append(f).css("width",54*c.length+"px")});var e=$("<div />").addClass("send_line").text("清空本行"),f=$("<div />").addClass("container").append(e,d);Live.giftpackage.packageContent.append(f),c.length>10&&Live.giftpackage.packagePanel.addClass("big")}),Live.giftpackage.packagePanelCleanBtn&&Live.giftpackage.packagePanelCleanBtn.off("click").on("click",function(a){Live.giftpackage.giftSendAll.open()}),Live.giftpackage.packageContent.find(".package-item").off("click").on("click",function(a){var b=$(this).attr("bag_id"),c=Live.giftpackage.giftPackageData[b];Live.giftpackage.giftSendPanel.open(c.gift_id,c.gift_name,c.gift_num,c.id)}),Live.giftpackage.packageContent.find(".send_line").off("click").on("click",function(a){var b=$(this).parent().find(".gift-item-group").attr("gift_id");Live.giftpackage.giftSendLinePanel.open(b)})},sortGifts:function(a){var b={},c=a;return Live.giftpackage.giftPackageData={},Live.each(c,function(a){var d=c[a];Live.giftpackage.giftPackageData[d.id]=d,"今日"===d.expireat?d.expireat=0:0===d.expireat?d.expireat=-1:d.expireat=parseInt(d.expireat),void 0===b[d.gift_id]&&(b[d.gift_id]=[]);var e=0;Live.each(b[d.gift_id],function(a){d.expireat<b[d.gift_id][a].expireat&&e>=a?e=a:e>=a&&(e=a+1)}),b[d.gift_id].splice(e,0,d)}),b},getGiftPackage:function(){return $.get(Live.protocol+"//live.bilibili.com/gift/playerBag",{},function(){},"json").promise()},getSendGift:function(){return $.get(Live.protocol+"//live.bilibili.com/giftBag/getSendGift",{},function(){},"json").promise()},getGiftPackageStatus:function(){return $.get(Live.protocol+"//live.bilibili.com/giftBag/sendDaily",{},function(){},"json").promise()},openGiftPackagePanel:function(){"none"==Live.giftpackage.packagePanel.css("display")&&(Live.giftpackage.getGiftPackage().then(function(a){Live.giftpackage.giftPackageMap=Live.giftpackage.sortGifts(a.data),Live.giftpackage.initGiftsDOM(Live.giftpackage.giftPackageMap),Live.giftpackage.packagePanel.show()}),setTimeout(function(){$(document).on("click",Live.giftpackage.closeGiftPackagePanel)},1))},closeGiftPackagePanel:function(a){var b=a&&(a.target||a.srcElement);$(b).hasClass("gifts-package-panel")||$(b).parents(".gifts-package-panel").length||Live.giftpackage.packagePanel.hide(0,function(){Live.giftpackage.panelStatus=!1,$(document).off("click",Live.giftpackage.closeGiftPackagePanel)})}},Live.helperInfo={setStatus:function(a,b,c){a.hasClass(c)||a.attr("class",b).addClass(c)},setWatcherStatus:function(a,b){Live.helperInfo.setStatus(Live.watcherBtn,"watcher-info",a),Live.watcherBtn.find("span").attr("title",b),Live.watcher.updateReward("tv"),Live.watcher.updateReward("lottery")},setTreasureStatus:function(a,b){Live.helperInfo.setStatus(Live.treasureBtn,"treasure-info",a),Live.treasureBtn.find("span").attr("title",b)},initPanel:function(){var a=$("#head-info-panel"),b=a.find(".info-ctnr"),c=b.find(".room-info"),d=c.find(".room-title-row"),e=c.find(".anchor-info-row"),f=$("<span />").addClass("helper-anchor-info-btn").text("更多"),g=Live.createPanel(d,f,"click","helper-anchor-info-panel","helperAnchorInfoPanel"),h=c.find(".room-info.v-top:eq(0)"),i=c.find(".room-info.v-top:eq(1)"),j=c.find(".room-manage"),k=d.find(".report-link[href]"),l=d.find(".share-link"),m=e.find(".san-info").hide(),n=(m.attr("href"),m.find(".san-num")),o=$('<div class="row-item san-info"><span class="san">San ：</span></div>').append(n);g.append(o,h,i,j,k,l),Live.helperInfoRow=$("<div />").addClass("helper-info-panel").attr("id","helperInfoPanel"),b.find(".room-info.float-left").append(Live.helperInfoRow),chrome.runtime.sendMessage({command:"getOption",key:"watcher"},function(a){"on"===a.value&&(Live.watcherBtn=$("<div />").addClass("watcher-info").html('<i class="watcher-info-icon" style="background-image:url('+chrome.extension.getURL("imgs/icon.png")+')"></i><span class="watcher-info-text">抽奖提示功能</span>'),Live.helperInfoRow.append(Live.watcherBtn))}),chrome.runtime.sendMessage({command:"getOption",key:"autoTreasure"},function(a){"on"===a.value&&(Live.treasureBtn=$("<div />").addClass("treasure-info").html('<i class="treasure-info-icon" style="background-image:url('+chrome.extension.getURL("imgs/icon.png")+')"></i><span class="treasure-info-text">辅助领瓜子</span>'),Live.helperInfoRow.append(Live.treasureBtn))})}},Live.init={"do":function(){Live.init.localStorage(),Live.init.ad(),Live.init.userInfo(function(a){store.get("bilibili_helper_login","login")&&location.pathname.substr(1)&&!isNaN(location.pathname.substr(1))&&chrome.runtime.sendMessage({command:"getOption",key:"version"},function(a){Live.version=a.value;var b=store.get("bilibili_helper_version");b&&b==Live.version||store.set("bilibili_helper_version",Live.version),$("#gift-panel").find(".control-panel").prepend('<div class="ctrl-item version"><span title="version: '+Live.version+'">哔哩哔哩助手</span> by <a href="http://weibo.com/guguke" target="_blank">@啾咕咕www</a> <a href="http://weibo.com/ruo0037" target="_blank">@沒睡醒的肉啊</a></div>'),Live.init.style(),Live.init.medal(),Live.addScriptByText('(function(){if (location.pathname.substr(1) && !isNaN(location.pathname.substr(1))) {var a=function(f,d,c){if(!window.localStorage||!f){return}var e=window.localStorage;if(!e[f]){e[f]=JSON.stringify({})}var b=JSON.parse(e[f]);if(c==undefined){e[f]=typeof d=="string"?d.trim():JSON.stringify(d)}else{b[d]=typeof c=="string"?c.trim():JSON.stringify(c);e[f]=JSON.stringify(b)}};a("bilibili_helper_live_roomId",ROOMURL,ROOMID);a("bilibili_helper_live_danmu_rnd",ROOMURL,DANMU_RND);}})();'),Live.roomId=Live.getRoomId(),Live.getRoomInfo().done(function(a){Live.init.giftList(),Live.roomInfo=a.data,Live.roomInfo.roomShortId=location.pathname.substr(1),Live.helperInfo.initPanel(),setTimeout(function(){Live.mobileVerified&&(Live.doSign.init(),Live.chat.init(),Live.notise.init(),Live.giftpackage.init()),Live.treasure.init(),Live.watcher.init(),Live.helperInfoRow.css("opacity",1)},2500),setTimeout(function(){Live.addScriptByFile("live-content-script.min.js",Live.scriptOptions)},5e3),Notification.requestPermission()})})})},style:function(){var a=$("document").find("#bilibiliHelperLive");a.length&&a.remove(),Live.init.inject_css("bilibiliHelperLive","live.min.css")},inject_css:function(a,b){var c=document.createElement("link");c.setAttribute("id",a),c.setAttribute("type","text/css"),c.setAttribute("rel","stylesheet"),c.setAttribute("href",chrome.extension.getURL(b)),document.head?document.head.appendChild(c):document.documentElement.appendChild(c)},ad:function(){chrome.runtime.sendMessage({command:"getAd"},function(a){"on"===a.value&&Live.init.inject_css("bilibiliHelperAdStyle","bilibiliHelperAd.min.css")})},giftList:function(){var a=$(".gifts-ctnr .gift-item[role=listitem]");if(a.length>0)for(var b=0;b<a.length;++b){var c=$(a[b]),d=c.attr("data-gift-id");isNaN(parseInt(d))||(Live.giftList[d]={title:c.attr("data-title"),type:c.attr("data-type"),description:c.attr("data-desc")})}},clearLocalStorage:function(){store["delete"]("bilibili_helper_quiz_bet",Live.roomId),store["delete"]("bilibili_helper_quiz_check",Live.roomId),store["delete"]("bilibili_helper_quiz_number",Live.roomId),store["delete"]("bilibili_helper_quiz_rate",Live.roomId),store["delete"]("bilibili_helper_quiz_which",Live.roomId),store["delete"]("bilibili_helper_doSign"),store["delete"]("bilibili_helper_userInfo")},localStorage:function(){Live.init.clearLocalStorage(),store.has("bilibili_helper_init")?Live.hasInit=!0:store.set("bilibili_helper_init",!0),store.has("bilibili_helper_live_roomId")||store.set("bilibili_helper_live_roomId",{}),!store.has("bilibili_helper_doSign")&&store.set("bilibili_helper_doSign",{}),!store.has("bilibili_helper_userInfo")&&store.set("bilibili_helper_userInfo",{}),!store.has("bilibili_helper_treasure_silver_count")&&store.set("bilibili_helper_treasure_silver_count",0),!store.has("bilibili_helper_chat_display")&&store.set("bilibili_helper_chat_display",{}),!store.has("bilibili_helper_tvs_count")&&store.set("bilibili_helper_tvs_count",0),!store.has("bilibili_helper_tvs_reward")&&store.set("bilibili_helper_tvs_reward",{}),!store.has("bilibili_helper_lottery_count")&&store.set("bilibili_helper_lottery_count",0),!store.has("bilibili_helper_lottery_reward")&&store.set("bilibili_helper_lottery_reward",{}),!store.has("bilibili_helper_lottery_reward_list")&&store.set("bilibili_helper_lottery_reward_list",{}),!store.has("bilibili_helper_quiz_autoMode")&&store.set("bilibili_helper_quiz_autoMode",{}),!store.has("bilibili_helper_quiz_check")&&store.set("bilibili_helper_quiz_check",{}),!store.has("bilibili_helper_quiz_bet")&&store.set("bilibili_helper_quiz_bet",{}),!store.has("bilibili_helper_quiz_rate")&&store.set("bilibili_helper_quiz_rate",{}),!store.has("bilibili_helper_quiz_number")&&store.set("bilibili_helper_quiz_number",{}),!store.has("bilibili_helper_quiz_which")&&store.set("bilibili_helper_quiz_which",{}),!store.has("bilibili_helper_beat_roomList")&&store.set("bilibili_helper_beat_roomList",[])},userInfo:function(a){Live.getUser().done(function(b){if("REPONSE_OK"===b.code){var b=b.data;Live.user=b,store.set("bilibili_helper_userInfo",{username:b.uname,userLevel:b.user_level,silver:b.silver,gold:b.gold,face:b.face,vip:b.vip,svip:b.svip,billCoin:b.billCoin,rank:b.user_level_rank}),store.set("bilibili_helper_login",!0),$.ajax({dataType:"json",url:Live.protocol+"//space.bilibili.com/ajax/member/MyInfo"}).promise().done(function(c){c.data&&1===c.data.mobile_verified?Live.mobileVerified=1:(Live.mobileVerified=0,console.error("未绑定手机，直播间功能无法启用")),a&&"function"==typeof a&&a(b)})}else b.code===-101&&store.remove("bilibili_helper_userInfo")})},medal:function(){Live.getMedalList().done(function(a){$.get(Live.protocol+"//live.bilibili.com/i/medal").promise().done(function(b){var c=$(b),d=c.find(".my-medal-section dl dd");if(0===a.code){a=a.data,Live.medalList=a;for(var e in a){Live.medalList[e].rank=parseInt($(d[e]).find(".col-4").text());var f=a[e];4765===f.medalId?(Live.hasBBQ=!0,Live.BBQ=f):Live.hasBBQ=!1}}})})}},Live.init["do"]()}}();