Registry.registerRaw("environment.js","0",function(){Context.domContentLoaded|=0;Context.pageLoaded|=0;Context.domNodeInserted|=0;Context.props={};Context.adjustLogLevel=function(a){void 0!==a&&(logLevel=a);D|=60<=logLevel};var u=function(){var a={objs:{},push:function(b,f){0!==f&&1!==f&&(f=0);var c=Math.floor(19831206*Math.random()+1);a.objs[c]={fn:b,prio:f};return c},remove:function(b){delete a.objs[b]},get:function(b){for(var f=[],c=0;1>=c;c++)for(var l in a.objs)a.objs.hasOwnProperty(l)&&
(a.objs[l].prio!==c||void 0!==b&&l!=b||f.push(a.objs[l].fn));return void 0===b?f:f[0]},finalize:function(b){if(void 0===b){b=a.get();for(var f=0;f<b.length;f++)b[f]()}else return a.objs[b]&&(f=a.objs[b].fn(),delete a.objs[b]),f}};return a}();Context.adjustLogLevel();var O=function(a){return{}.toString.apply(a).match(/\s([a-z|A-Z]+)/)[1]},J=function(a,b){void 0==b&&(b=100);return b&&a&&(a==document||J(a.parentNode,b-1))},U=function(){var a=function(){};a.prototype={};return new a},ga=function(a){var b=
function(a,c,b,d){var k=function(b,g,e,h,k){var d=g[e];h&&"string"===typeof d?g[e]=new Function(d):k&&(g[e]=function(){return d.apply(a,arguments)});return b.apply(c,g)},h=function(b){return b==c?a:b},g=function(a,b,g,c){g||(g=a);var e=function(){var e=a[b].apply(g,arguments);c&&(e=c(e));return e};e.__proto__=a[b];e.prototype=a[b].prototype;return e},n=function(b){var g,e,h=null,h=function(h){g=h;e=function(){return h.apply(a,arguments)};c[b]=e};a.__defineGetter__(b,function(){return void 0===g||
e!==c[b]?c[b]:g});a.__defineSetter__(b,h)},s=function(b,g){var e,d=null,k=null,d="function"===typeof g.get?g.get:function(){g.opts&&g.opts.get_cb&&g.opts.get_cb.apply(this,[arguments,s]);return void 0===e?h(c[b]):e};"function"===typeof g.set?k=g.set:g.get||(k=function(a){e=a});d&&a.__defineGetter__(b,d);k&&a.__defineSetter__(b,k)},e;for(e in d)d.hasOwnProperty(e)&&(b[e]=b[e]||!1!==d[e]);var m,r;for(e in b)if(b.hasOwnProperty(e)&&!1!==d[e]){m={};try{try{(r=d[e])?r.wrap?(m.wrap=!0,m.that=r.that):r.direct?
m.direct=!0:r.enhance?m.enhance=r.enhance:r.get||r.set?(m.get=r.get,m.set=r.set,m.opts=r.opts):r.wrap_callback&&(m.enhance=function(){var a=r.wrap_callback,b=c[e];return function(){return k(b,arguments,a.cb_index,a.auto_eval,a.set_context)}}()):"function"===typeof c[e]?b[e].proto?m.wrap=!0:c[e].prototype||"eval"==c[e].name?m.direct=!0:m.bind=!0:"number"===typeof c[e]||"string"===typeof c[e]?m.get=!0:b[e].event&&b[e].proto?m.event=!0:m.direct=!0}catch(t){m.get=!0}m.direct?a[e]=h(c[e]):m.bind?a[e]=
c[e].bind(c):m.enhance?a[e]=m.enhance:m.event?n(e):m.get||m.set?s(e,m):m.wrap&&function(){var b=e;a[b]=g(c,b,m.that,h)}()}catch(P){console.warn("env: error while creating a new sandbox: "+P.message)}}return a};return function(){var f=U(),c={setTimeout:{wrap_callback:{cb_index:0,auto_eval:!0,set_context:!0}},setInterval:{wrap_callback:{cb_index:0,auto_eval:!0,set_context:!0}},close:{get:function(){return window.self==window.top?function(a){return fa(a)}:window.close}},location:{get:!0,set:function(a){window.location.href=
a}},document:{get:function(){var b=window.document;a(b);return b}},clearInterval:{get:function(){return safeWindow.clearInterval}},clearTimeout:{get:function(){return safeWindow.clearTimeout}},addEventListener:{wrap_callback:{cb_index:1,auto_eval:!0}},removeEventListener:{wrap_callback:{cb_index:1,auto_eval:!0}}};(function(){var a=Math.max(window.frames.length,7);c.length={get:!0,opts:{get_cb:function(b,c){for(var h=window.frames.length,e=a;e<h;e++)c(String(e),{get:!0});a=Math.max(h,a)}}};for(var b=
0;b<a;b++)c[String(b)]={get:!0}})();["confirm","prompt","alert"].forEach(function(a){c[a]={enhance:safeWindow[a]}});var l=b(f,window,Context.windowProps,c),d={context:l,filter:function(a){return a==window?l:a},filterEvent:function(a){var b={},g;for(g in a)if("function"===typeof a[g])b[g]=function(){var b=g;return function(){return a[b].apply(a,arguments)}}();else{var c=d.filter(a[g]);b[g]=c}return b}};return d}()},ha=function(a,b,f,c,l,d){var k=null;try{var h=c.sandboxes[a.uuid];h.__TMbackref||(h.__TMbackref=
{});var g=["context"],n=[void 0],s;for(s in c.elements[a.uuid])if(c.elements[a.uuid].hasOwnProperty(s)){var e=c.elements[a.uuid][s];e.name?e.overwrite?(g.push(e.name),n.push(e.value)):e.scriptid?(h.__TMbackref[e.name+"_"+e.scriptid]=e.value,g.push(e.name),n.push('context.__TMbackref["'+e.name+"_"+e.scriptid+'"]')):(h[e.name]=e.value,g.push(e.name),n.push("context."+e.name)):D&&console.warn("env: WARN: unexpected item in props elem: "+JSON.stringify(e))}k=['with (context) {(function(module) {"use strict";try {\nmodule.apply(context, [',
n.join(","),"]);} catch (e) {if (e.message && e.stack) {console.error(\"ERROR: Execution of script '",a.name.replace(/(['"])/g,"\\$1"),'\' failed! " + e.message);console.log(e.stack.replace(/(\\\\(eval at )?<anonymous>[: ]?)|([\\s.]*at Object.tms_[\\s\\S.]*)/g, ""));} else {console.error(e);}}\n})(function ',d,"(",g.join(","),") {",Context.enforce_strict_mode?'"use strict";\n':"",f,b,"\n})}\n"].join("");c=function(a,b){(new Function("context",k)).apply(b,[b])};l?l(c,[k,h]):c(k,h)}catch(m){chromeEmu.extension.sendMessage({method:"syntaxCheck",
code:[f,b].join("")},function(g){var e="";if(g.errors){var e=f.split("\n").length-1,c="",h;for(h in g.errors){var d=g.errors[h];if(d&&0<=d.line&&d.reason)var n=d.line,c=c+[n>e?"script:":"require:"," (",d.code,") ",d.reason.replace(/.$/,"")," on line: ",n>e?n-e:n," at character: ",d.character,"\n"].join("")}e="JSHINT output:\n"+c}else e=b;h=m.stack?m.stack.replace(/(\\(eval at )?<anonymous>[: ]?)|([\s.]*at Object.tms_[\s\S.]*)/g,""):"";D||g.errors?console.error("Syntax error @ '"+a.name+"'!\n##########################\n"+
e+"##########################\n\n"+h):console.error("Syntax error @ '"+a.name+"'!\n\n",h);safeWindow.setTimeout(function(){D&&chromeEmu.extension.sendMessage({method:"copyToClipboard",data:{content:b,type:"test"},id:"42"},function(){});throw m;},1)})}},A=[],q={events:[],done:{},running:null},F=function(a,b,f,c){var l={attrChange:0,attrName:null,bubbles:!0,cancelBubble:!1,cancelable:!1,clipboardData:void 0,currentTarget:null,defaultPrevented:!1,eventPhase:0,newValue:null,prevValue:null,relatedNode:null,
returnValue:!0,srcElement:null,target:null,timeStamp:(new Date).getTime()};f="string"===typeof f?new Function(f):f;var d=new Event,k;for(k in l)d[k]=l[k];for(k in b)d[k]=b[k];d.type=a;f.apply(c,[d])},C=function(){Context.domContentLoaded||!D||console.log("env: DOMContentLoaded Event!");Context.domContentLoaded=!0;B();safeDocument.removeEventListener("DOMContentLoaded",C,!1)},K=function(a){Context.domNodeInserted||!D||console.log("env: first DOMNodeInserted Event!");Context.domNodeInserted=!0;q&&q.events.push({event:a,
domContentLoaded:Context.domContentLoaded})},G=function(){Context.pageLoaded||!D||console.log("env: load Event!");Context.domContentLoaded=!0;Context.pageLoaded=!0;B();safeDocument.removeEventListener("DOMContentLoaded",C,!1);safeDocument.removeEventListener("load",G,!1)},L=function(){safeDocument.removeEventListener("DOMNodeInserted",K,!1);safeDocument.removeEventListener("DOMContentLoaded",C,!1);safeDocument.removeEventListener("load",G,!1);safeWindow.removeEventListener("unload",L,!1);if(null!=
u){for(var a=u.get(),b=0;b<a.length;b++)a[b]();u=null}chromeEmu.clean&&chromeEmu.clean()},B=function(){for(var a=A.length;0<A.length;)A.shift().fn();window.setTimeout(function(){q&&(q=null)},2E3);return a},M=function(a){if(document.body)a&&(a(),a=null);else{var b=["load","DOMNodeInserted","DOMContentLoaded"],f=function(){b.forEach(function(a){safeDocument.removeEventListener(a,f,!1)});M(a)};b.forEach(function(a){safeDocument.addEventListener(a,f,!1)})}},V=function(a){A.push({fn:a});Context.domContentLoaded?
B():D&&console.log("env: schedule for later events!")},ia=function(a){return V(function(){safeWindow.setTimeout(a,1)})},z=null,W=function(a){z||(z={},["write","writeln"].forEach(function(b){z[b]=a.__proto__[b];a.__proto__[b]=function(){var f=document.documentElement,c=z[b].apply(a,arguments);f!==document.documentElement&&(z=null,W(document),Context.write_listeners.forEach(function(a){a()}));return c}}))},S={},x=[],X=function(a,b,f,c){if(!a.__addEventListener){a.__addEventListener=a.addEventListener;
a.__removeEventListener=a.removeEventListener;var l=[],d=function(a){for(var b=0;b<l.length;b++)if(l[b].fn===a)return b};a.removeEventListener=function(a,b,c){c=!!c;"DOMNodeInserted"==a&&q&&q.running==b&&(q.running=null);var f,e;if(void 0!==(f=d(b))&&(e=l[f].listeners)){if(b=e[a+"-"+c])this.__removeEventListener(a,b,c),delete e[a+"-"+c];Object.getOwnPropertyNames(e).length||l.splice(f,1)}else this.__removeEventListener(a,b,c)};var k=function(a,b,c,d){if(b){var e=x.length;b=parseInt(["DOMContentLoaded"==
c?1:2,d?1:2,d?b:3-b,(new Date).getTime()].join("0"));for(c=0;c<x.length;c++)if(d=x[c],!d||!d.prio||d.prio>b){e=c;break}x.splice(e,0,{prio:b,fn:a})}else x.push({fn:a})};a.addEventListener=function(a,g,n){if("load"==a||"DOMContentLoaded"==a||"DOMNodeInserted"==a){n=!!n;var s=!0,e=this;if(!c)try{try{throw Error();}catch(m){var r=/tms_[0-9a-f_]+/;if(m.stack)for(var t=m.stack.split("\n"),P,w=0;w<t.length&&(!(P=t[w].match(r))||!(c=S[P[0]]));w++);else{var u=function(a,b){void 0===b&&(b=10);if(0==b)return null;
if(a.caller){var c,e,g;try{return g=a.caller.toString(),(e=g.match(/^function[^(]+/))&&e.length&&(c=e[0].match(r))?c[0]:u(a.caller,b-1)}catch(d){D&&console.warn("env: unable to detect caller context",d)}}return null};if(w=u(arguments.callee))c=S[w]}}}catch(ea){D&&console.error("env: Error: event "+a,ea)}c&&"document-idle"!==c.run_at&&(t=null,"load"==a?Context.pageLoaded&&(t=function(){var a=e.document||e,a=a||document;F("load",{attrName:"null",newValue:"null",prevValue:"null",eventPhase:Event.AT_TARGET,
attrChange:MutationEvent.ADDITION,target:a,relatedNode:a,srcElement:a},g,e)},s=!1,k(t,b,a,n)):"DOMContentLoaded"==a?Context.domContentLoaded&&(t=function(){var a=e.document||e,a=a||document;F("DOMContentLoaded",{attrName:"null",newValue:"null",prevValue:"null",eventPhase:Event.AT_TARGET,attrChange:MutationEvent.ADDITION,target:a,relatedNode:a,srcElement:a},g,e)},s=!1,k(t,b,a,n)):"DOMNodeInserted"==a&&q&&!q.done[c.uuid]&&(q.done[c.uuid]=!0,t=function(){var b="document-start"!==c.run_at&&"document-body"!==
c.run_at;q.running=g;if(q.running){a:if(q)for(var d=q.events.length,f=0;f<d;f++)if(b&&!q.events[f].domContentLoaded||F("DOMNodeInserted",{attrName:"",newValue:"",prevValue:"",eventPhase:Event.AT_TARGET,target:q.events[f].event.target,relatedNode:q.events[f].event.relatedNode,srcElement:q.events[f].event.srcElement},g,e),!q.running)break a;e.__addEventListener(a,g,n)}q.running=null},k(t)),t&&(safeWindow.setTimeout(function(){if(x.length){var a=x.shift();a&&a.fn&&a.fn()}},1),s=!1));s&&(s=function(a){return g.call(this,
f(a))},void 0===(w=d(g))&&(w=l.length,l.push({fn:g,listeners:{}})),l[w].listeners[a+"-"+n]=s,this.__addEventListener(a,s,n))}else this.__addEventListener(a,g,n)};u.push(function(){a.removeEventListener=a.__removeEventListener;a.addEventListener=a.__addEventListener})}},ja=function(a){a.__evaluate||(a.__evaluate=a.evaluate,a.evaluate=function(a,f,c,l,d){f||(f=this);var k;if("undefined"!=typeof XPathResult){var h=null;try{k=this.__evaluate(a,f,c,l,d)}catch(g){h=g}var n=!1;try{n|=!!k.snapshotLength}catch(s){}try{n|=
!!k.singleNodeValue}catch(e){}if(!n&&"."!=a.charAt(0)&&!J(f)){a=("/"==a.charAt(0)?".":"./")+a;try{k=this.__evaluate(a,f,c,l,d)}catch(m){}}if(!n&&h)throw h;}else k=f.selectNodes(a);return k},u.push(function(){a.evaluate=a.__evaluate}))},Y=function(a){u.finalize(a)},Z=function(a,b,f){var c=TM_context_id+"#"+a,l=null,d=chromeEmu.extension.connect("registerMenuCommand_"+c);d.postMessage({method:"registerMenuCmd",name:a,id:TM_context_id,menuId:c,accessKey:f});d.onMessage.addListener(function(a){a.run&&
null!==l&&void 0!==u.get(l)?safeWindow.setTimeout(function(){b()},1):null!==l&&(u.remove(l),l=null)});d.onDisconnect.addListener(function(){d=null});return l=u.push(function(){d&&d.disconnect()},1)},$=function(a,b){"boolean"===typeof b?b={loadInBackground:b}:b||(b={});var f=void 0===b.active?void 0===b.loadInBackground?!0:!b.loadInBackground:b.active,c=void 0===b.insert?!0:b.insert,l=null,d=!1,k=null,h,g=chromeEmu.extension.connect("openInTab_"+TM_context_id),n=function(){var a=[];return{run:function(b){b&&
a.push(b);if(l)for(;a.length;)a.pop()()}}}();a&&0==a.search(/^\/\//)&&(a=window.location.protocol+a);g.onMessage.addListener(function(a){a.tabId?d?s():(l=a.tabId,n.run()):a.name?h=a.name:a.close&&(d=!0,k&&(k(),k=void 0))});g.onDisconnect.addListener(function(){g=null});g.postMessage({method:"openInTab",details:{url:a,id:TM_context_id,options:{active:!!f,insert:!!c}},id:TM_context_id});var s=function(){g&&g.postMessage({method:"closeTab",id:TM_context_id})},f={};Object.defineProperties(f,{close:{value:function(){d?
D&&console.debug("env: attempt to close already closed tab!"):(d=!0,s())}},closed:{get:function(){return d}},onclose:{get:function(){return k},set:function(a){k=a}},name:{get:function(){return h},set:function(a){n.run(function(){g&&g.postMessage({method:"nameTab",id:TM_context_id,name:a})})}}});return f},aa=function(a,b){var f=!1,c="Object"===O(a)?a:{url:a,name:b};c.url&&"/"===c.url[0]&&(c.url=window.location.origin+c.url);var l=c.context;delete c.context;var d=chromeEmu.extension.connect("download_"+
TM_context_id);d.postMessage({method:"download",details:c,id:TM_context_id});var k=function(a,b){b=b||{};a&&!f&&safeWindow.setTimeout(function(){a.apply(b,[b])},1)};d.onMessage.addListener(function(a){try{a.data&&l&&(a.data.context=l),a.load?c.onload&&(a.data.responseXML&&(a.data.responseXML=safeWindow.unescape(a.data.responseXML)),k(c.onload,a.data)):a.progress?c.onprogress&&k(c.onprogress,a.data):a.timeout?c.ontimeout&&k(c.ontimeout,a.data):c.onerror&&k(c.onerror,a.data)}catch(b){console.log("env: Error: TM_download - ",
b,c)}});return{abort:function(){f=!0}}},ba=function(a){var b=!1;a.url&&"/"===a.url[0]&&(a.url=window.location.origin+a.url);var f=a.context;delete a.context;var c=function(){var a={};Object.getOwnPropertyNames(XMLHttpRequest.__proto__).forEach(function(b){a[b]=!0});var b=function(){};Object.getOwnPropertyNames(XMLHttpRequest).forEach(function(c){a[c]||(b[c]=XMLHttpRequest[c])});return b}(),l=function(a,d){d=d||{};a&&!b&&safeWindow.setTimeout(function(){d.__proto__=c;a.apply(d,[d])},1)};if("FormData"!==
O(a.data)){var d=chromeEmu.extension.connect("xhr_"+TM_context_id),k=[];d.postMessage({method:"xhr",details:a,callbacks:{onloadstart:!!a.onloadstart,onload:!!a.onload,onreadystatechange:!!a.onreadystatechange,onerror:!!a.onerror,ontimeout:!!a.ontimeout,onprogress:!!a.onprogress,onpartial:!0},id:TM_context_id});d.onMessage.addListener(function(b){try{if(b.data&&f&&(b.data.context=f),b.data&&b.onload){k.length&&(b.data.response_data=k.join(""),k=null);if(b.data.response_data){var c=b.data.response_data,
d=b.data.response_types;["response_data","response_types"].forEach(function(a){delete b.data[a]});if(d){var e={response:function(b){var c=a.responseType?a.responseType.toLowerCase():"",d=function(a){for(var c=new Uint8Array(a.length),d=0;d<a.length;d++)c[d]=b.charCodeAt(d);return c.buffer};return"arraybuffer"==c?d(b):"blob"==c?new Blob([d(b)]):"json"==c?JSON.parse(b):b},responseText:function(a){return a},responseXML:function(a){return(new DOMParser).parseFromString(a,"text/xml")}},h;for(h in e)if(e.hasOwnProperty(h))if(d[h])try{b.data[h]=
e[h](c)}catch(r){console.warn("GM_xmlhttpRequest: ",r)}else b.data[h]=null}else console.warn("GM_xmlhttpRequest: got unusual response!"),b.data.responseText=c}l(a.onreadystatechange,b.data);l(a.onload,b.data)}else b.onreadystatechange?4!=b.data.readyState&&l(a.onreadystatechange,b.data):b.onpartial?k.push(b.data.partial):(e=["onloadstart","onprogress","ontimeout"].filter(function(a){return!!b[a]})[0]||"onerror",l(a[e],b.data))}catch(q){console.log("env: Error: TM_xmlhttpRequest",q,a)}})}else{var h=
new XMLHttpRequest;void 0===a.async&&(a.async=!0);h.open(a.method,a.url,a.async,a.user,a.password);if(a.headers)for(d in a.headers)h.setRequestHeader(d,a.headers[d]);a.overrideMimeType&&h.overrideMimeType(a.overrideMimeType);a.responseType&&(h.responseType=a.responseType);"abort error load loadstart progress readystatechange timeout".split(" ").forEach(function(b){h["on"+b]=function(){var c="",d=a.url;if(2<h.readyState&&(c=h.getAllResponseHeaders(),4==h.readyState)){c&&(c=c.replace(/TM-finalURL[0-9a-zA-Z]*\: .*[\r\n]{1,2}/,
""));var e=h.getResponseHeader("TM-finalURL"+Context.short_id);e&&(d=e)}c={readyState:h.readyState,status:"",statusText:"",responseHeaders:c,finalUrl:d,context:f};4==h.readyState&&(h.responseType&&""!=h.responseType?c.response=h.response:(c.responseText=h.responseText,c.responseXML=h.responseXML),c.status=h.status,c.statusText=h.statusText);l(a["on"+b],c)}});h.send(a.data)}return{abort:function(){b=!0}}},ca=function(a,b){chromeEmu.extension.sendMessage({method:"installScript",url:a,id:TM_context_id},
function(a){b&&b(a)})},fa=function(a){chromeEmu.extension.sendMessage({method:"closeTab",id:TM_context_id},function(b){b.error&&console.warn(b.error);a&&a()})},ka=function(a,b){var f=[],c=a.storage,l=a.script.uuid,d=a.script,k=null;(function(){k=chromeEmu.extension.connect("storageListener_"+TM_context_id);k.onMessage.addListener(function(a){if(a.storage)for(var H in a.storage.data)if(a.storage.data.hasOwnProperty(H)){var d=c.data[H];c.data[H]=a.storage.data[H];n(H,d,c.data[H],!0)}a.removed&&(c[a.removed]=
b);a.error&&console.log("env: Error: storage listener... :(")});k.postMessage({method:"addStorageListener",uuid:l,id:TM_context_id})})();var h=function(a){k.postMessage({method:"saveStorageKey",uuid:l,key:a,value:c.data[a],id:TM_context_id,ts:c.ts})},g=function(a,c,d){d===b&&(d=function(a){return a});var e=[],f=null;if(a&&a.length){var f={GM_info:!0},g;for(g in a)if(a.hasOwnProperty(g)){var h=a[g];f[h]=!0}}for(g in c)c.hasOwnProperty(g)&&(h=c[g],f&&!f[d(h.name)]||e.push(h));return e},n=function(a,
b,c,d){if(b!=c)for(var e in f)if(f.hasOwnProperty(e)){var g=f[e];if(g&&g.key==a&&g.cb)try{g.cb(a,t(b),t(c),d)}catch(h){D&&console.warn("env: value change listener of '"+a+"' failed with: "+h.message)}}},q=function(a,b){var c=0;f.forEach(function(a){a.id>c&&(c=a.id)});c++;f.push({id:c,key:a,cb:b});return c},e=function(a){var c;f.every(function(b,d){return b.id==a?(c=d,!1):!0});if(c!==b)return f.splice(c,1),!0},m=function(a){var b=c.data[a];c.ts=(new Date).getTime();delete c.data[a];h(a);n(a,b,c.data[a],
!1)},r=function(){var a=[],b;for(b in c.data)c.data.hasOwnProperty(b)&&a.push(b);return a},t=function(a,b){if("string"===typeof a){var c=a[0];a=a.substring(1);switch(c){case "b":return"true"===a;case "n":return Number(a);case "o":try{return JSON.parse(a)}catch(d){console.log("env: parseValueFromStorage: "+d)}return b;default:return a}}else return b},x=function(a,b){return t(c.data[a],b)},w=function(a,b){var d=c.data[a],e=(typeof b)[0];switch(e){case "o":try{b=e+JSON.stringify(b)}catch(f){console.log(f);
return}break;default:b=e+b}c.ts=(new Date).getTime();c.data[a]=b;h(a);n(a,d,c.data[a],!1)},z=function(a){for(var b in d.resources){var c=d.resources[b];if(c.name==a)return c.resText}return null},A=function(a){for(var b in d.resources){var c=d.resources[b];if(c.name==a)return c.resURL}return null},B=function(a){console.log(a)},C=function(a){try{var b=safeDocument.createElement("style");b.textContent=a;(document.head||document.body||document.documentElement||document).appendChild(b);return b}catch(c){console.log("Error: env: adding style "+
c)}},F=function(b,c,d,e,f){var g=null,h={method:"notification",id:TM_context_id},k=["timeout","text","image","title","highlight"],l=null;"object"===typeof b?l=b:"object"===typeof f&&(l=f);l?(k.forEach(function(a){h[a]=l[a]}),g=l.ondone,e=l.onclick,"function"===typeof c&&(g=c)):("number"===typeof f&&(h.timeout=f),h.image=d,h.title=c,h.text=b);h.text&&(h.image=h.image||a.script.icon64||a.script.icon,h.title=h.title||a.script.name);h.text||h.highlight?chromeEmu.extension.sendMessage(h,function(a){e&&
a.clicked&&e();g&&g(!0===a.clicked)}):console.warn("TM_notification: neither a message text nor the hightlight options was given!")},G=function(a,b,c){var d=typeof b,e="text",f="text/plain";"object"===d?(b.type&&(e=b.type),b.mimetype&&(f=b.mimetype)):"string"===d&&(e=b);chromeEmu.extension.sendMessage({method:"copyToClipboard",data:{content:a,type:e,mimetype:f},id:TM_context_id},function(){c&&c()})},J=function(a){chromeEmu.extension.sendMessage({method:"getTab",id:TM_context_id,uid:d.uuid},function(b){a&&
a(b.data)})},Q=function(a,b){chromeEmu.extension.sendMessage({method:"setTab",id:TM_context_id,tab:a,uid:d.uuid},function(){b&&b()})},K=function(a){chromeEmu.extension.sendMessage({method:"getTabs",id:TM_context_id,uid:d.uuid},function(b){a&&a(b.data)})},p=function(a,b){var c=window,d="__u__"+Math.floor(19831206*Math.random()+1),e=d+"_";c[d]=a;c[e]=b;var f=Context.eval.call(window,'window["'+d+'"].apply(this, window["'+e+'"])');delete c[d];delete c[e];return f},v=[],E=null,y;for(y in d.grant)if(d.grant.hasOwnProperty(y)&&
"none"===d.grant[y]){E=p;break}var I=d.namespace+"_"+!!E;Context.props[I]===b&&(Context.props[I]={sandboxes:{},elements:{}},u.push(function(){Context.props[I]=null}));if(!E){v.push({name:"window",value:"context",overwrite:!0});var T={window:window};for(y in T)T.hasOwnProperty(y)&&function(){var a=y.replace(/^(.)/g,function(a){return a.toUpperCase()});v.push({name:"unsafe"+a,value:T[y]})}()}v.push({name:"CDATA",value:function(a){this.src=a;this.toXMLString=this.toString=function(){return this.src}}});
v.push({name:"uneval",value:function(a){try{return"\\$1 = "+JSON.stringify(a)+";"}catch(b){console.log(b)}}});Context.use_strong_mode||v.push({name:"undefined",value:b});v.push({name:"define",value:b});v.push({name:"module",value:b});v.push({name:"console",value:console});E||(v.push({name:"cloneInto",value:function(a){return a}}),v.push({name:"exportFunction",value:function(a,c,d){d&&d.defineAs!==b&&(c[d.defineAs]=a);return a}}),v.push({name:"createObjectIn",value:function(a,c){var d={};c&&c.defineAs!==
b&&(a[c.defineAs]=d);return d}}));p=[];p.push({name:"TM_addStyle",value:C});p.push({name:"TM_deleteValue",value:m});p.push({name:"TM_listValues",value:r});p.push({name:"TM_getValue",value:x});p.push({name:"TM_log",value:B});p.push({name:"TM_registerMenuCommand",value:Z});p.push({name:"TM_unregisterMenuCommand",value:Y});p.push({name:"TM_openInTab",value:$});p.push({name:"TM_setValue",value:w});p.push({name:"TM_addValueChangeListener",value:q});p.push({name:"TM_removeValueChangeListener",value:e});
p.push({name:"TM_xmlhttpRequest",value:ba});p.push({name:"TM_download",value:aa});p.push({name:"TM_setClipboard",value:G});p.push({name:"TM_getTab",value:J});p.push({name:"TM_setTab",value:Q});p.push({name:"TM_saveTab",value:Q});p.push({name:"TM_getTabs",value:K});p.push({name:"TM_installScript",value:ca});p.push({name:"TM_notification",value:F});p.push({name:"TM_getResourceText",value:z,scriptid:d.uuid});p.push({name:"TM_getResourceURL",value:A,scriptid:d.uuid});var N=[],L=new function(){this.GM_addStyle=
function(a){return C(a)};this.GM_deleteValue=function(a){return m(a)};this.GM_listValues=function(){return r()};this.GM_getValue=function(a,b){return x(a,b)};this.GM_addValueChangeListener=function(a,b){return q(a,b)};this.GM_removeValueChangeListener=function(a){return e(a)};this.GM_log=function(a){return B(a)};this.GM_registerMenuCommand=function(a,b,c){return Z(a,b,c)};this.GM_unregisterMenuCommand=function(a){return Y(a)};this.GM_openInTab=function(a,b){return $(a,b)};this.GM_setValue=function(a,
b){return w(a,b)};this.GM_xmlhttpRequest=function(a){return ba(a)};this.GM_download=function(){return aa.apply(this,arguments)};this.GM_getResourceText=function(a){return z(a)};this.GM_getResourceURL=function(a){return A(a)};this.GM_notification=function(a,b,c,d,e){return F(a,b,c,d,e)};this.GM_installScript=function(a,b){return ca(a,b)};this.GM_getTab=function(a){return J(a)};this.GM_setTab=function(a,b){return Q(a,b)};this.GM_saveTab=function(a){return Q(a)};this.GM_getTabs=function(a){return K(a)};
this.GM_setClipboard=function(a,b,c){return G(a,b,c)};Object.defineProperties(this,{GM_info:{get:function(){var b={observers:1,id:1,enabled:1,hash:1,fileURL:1},c={script:{}},e;for(e in d)d.hasOwnProperty(e)&&!b[e]&&(c.script[e]=d[e]);b=d.options.updateURL||d.options.fileURL;c.script["run-at"]=d.options.override.run_at||d.options.run_at;c.script.excludes=d.options.override.orig_excludes;c.script.includes=d.options.override.orig_includes;c.script.matches=d.options.override.orig_includes;c.script.grant=
d.grant;c.script.unwrap=!1;c.scriptMetaStr=a.header;c.scriptSource=a.code;c.scriptWillUpdate=!!b;c.scriptUpdateURL=b;c.version=Context.version;c.scriptHandler="Tampermonkey";c.isIncognito=Context.isIncognito;c.downloadMode=Context.downloadMode;return c},enumerable:!0,configurable:!0}})},M=[];for(y in L)M.push({name:y,value:L[y]});N=N.concat(g(d.grant,p,function(a){return a.replace(/^TM_/,"GM_")}));N=N.concat(g(d.grant,M));v=v.concat(N);d.options.compat_prototypes&&(D&&console.log("env: option: add toSource"),
Object.prototype.toSource||Object.defineProperties(Object.prototype,{toSource:{value:function(){var a=O(this);if("String"===a)return"(String('"+this.replace(/\'/g,"\\'")+"'))";if("Number"===a)return"(Number('"+Number(this)+"'))";if("Array"===a){for(var b="(new Array(",c=0;c<this.length;c++)a=O(this[c]),b="Null"===a?b+"null":"Undefined"===a?b+"undefined":b+this[c].toSource(),c+1<this.length&&(b+=",");return b+"))"}return"JSON.parse(unescape('"+safeWindow.escape(JSON.stringify(this))+"'))"},enumerable:!1,
writable:!0,configurable:!0}}),D&&console.log("env: option: add some array generics"),"indexOf lastIndexOf filter forEach every map some slice".split(" ").forEach(function(a){if("function"!==typeof Array[a]){var b={};b[a]={value:function(b){return Array.prototype[a].apply(b,Array.prototype.slice.call(arguments,1))},enumerable:!1,writable:!0,configurable:!0};Object.defineProperties(Array,b)}}));g="";if(E)p=U();else{var R=ga(function(a){ja(a);W(a);X(a,2,R.filterEvent)}),p={run_at:a.script.options.run_at,
uuid:a.script.uuid},g="tms_"+a.script.uuid.replace(/-/g,"_");S[g]=p;X(R.context,1,R.filterEvent,p);p=R.context}Context.props[I].sandboxes[a.script.uuid]=p;Context.props[I].elements[a.script.uuid]=v;D&&console.debug("env: execute script "+d.name+" @ the "+(E?"un":"")+"safe context now!");ha(d,a.code,a.requires,Context.props[I],E,g);u.push(function(){k.postMessage({method:"removeStorageListener",uuid:l,storage:c,id:TM_context_id});try{k.disconnect(),k=null}catch(b){}a=f=null})},da=function(a){var b=
function(){ka(a)};"document-start"==a.script.options.run_at?(D&&console.debug("env: run '"+a.script.name+"' ASAP -> document-start"),b()):"document-body"==a.script.options.run_at?(D&&console.debug("env: schedule '"+a.script.name+"' for document-body"),M(b)):"context-menu"==a.script.options.run_at?(D&&console.debug("env: run '"+a.script.name+"' ASAP -> context-menu"),b()):"document-end"==a.script.options.run_at?(D&&console.debug("env: schedule '"+a.script.name+"' for document-end"),V(b)):(D&&console.debug("env: schedule '"+
a.script.name+"' for document-idle"),ia(b))};chromeEmu.extension.onMessage.addListener(function(a,b,f){a.id&&a.id!=TM_context_id?console.warn("env: Not for me! "+TM_context_id+"!="+a.id):(b=window.self==window.top,"executeScript"==a.method?a.url&&0!==safeWindow.location.href.search(a.url)?D&&console.log("exec: URL doesn't match",safeWindow.location,a):a.topframe&&!b?D&&console.log("exec: topframe doesn't match",window.self,a):da(a):"onLoad"==a.method?(document.readyState&&"complete"!==document.readyState||
(Context.domContentLoaded=!0,B()),f({})):b&&("loadUrl"==a.method?(window.location=a.url,f({})):"reload"==a.method?(window.location.reload(),f({})):"confirm"==a.method?safeWindow.setTimeout(function(){var b=safeWindow.confirm(a.msg);f({confirm:b})},100):"showMsg"==a.method?safeWindow.setTimeout(function(){safeWindow.setTimeout(function(){safeWindow.alert(a.msg)},1);f({})},100):"setForeignAttr"==a.method?(window[a.attr]=a.value,f({})):console.log("env: unknown method "+a.method)))});Context.pageLoaded||
(safeDocument.addEventListener("load",G,!1),safeDocument.addEventListener("DOMNodeInserted",K,!1),Context.domContentLoaded||safeDocument.addEventListener("DOMContentLoaded",C,!1));safeWindow.addEventListener("unload",L,!1);D&&console.debug("env: initialized (content, id:"+TM_context_id+", "+window.location.origin+window.location.pathname+") ");Context.scripts.forEach(da)});
