!function(i,t){"use strict";function e(i,t){if(!i||!i.childNodes)return null;for(var e=i.childNodes,r=0;r<e.length;r++){var s=e[r];if(s.localName==t)return s}return null}function r(i,t){var r=e(i,t);return r?r.textContent:null}i.SubscriptionService=function(){var t=i.ClientService;this.serviceClient=new t,this.groups=[],this.filters=[]},i.SubscriptionService.prototype={init:function(i){var e=t.Log,r=this.find();if(r)this.groups=r,i();else{var s=new t.vPromise;this.serviceClient.loadYiclearSubscriptions(function(i){this.groups=i,s.resolve()}.bind(this),n),t.vPromise.all([s]).then(function(){this.setLS(JSON.stringify(this.groups)),i()}.bind(this))}var n=function(i,t){e.error("Error loading metadata, cause: {0} {1}",i.statusText,t)}},setLS:function(i){var e=t.LocalStorage;e.setItem("yiclear-groups",i)},find:function(){var i=t.LocalStorage;return JSON.parse(i.getItem("yiclear-groups"))},getUserFilterRule:function(t,e){for(var r=this.find(),s=0;s<r.length;s++)if(r[s].subscriptionUrl==t)return void e();var n=function(r){var s=i.FilterStorage,n=i.SubscriptionFilter.formTxt(r),l=this.groups.length;n.filterId=this.groups[l-1].filterId+1,n.subscriptionUrl=t,n.installed=!0,this.groups.push(n),this.setLS(JSON.stringify(this.groups)),s.saveFilterRules(n.filterId,r,function(){e(n)}.bind(this))}.bind(this);this.serviceClient.loadFilterRulesBySubscriptionUrl(t,n)},updateFilterInfo:function(i){for(var t=this.find(),e=0;e<t.length;e++)t[e].filterId==i.filterId&&(t[e]=i);this.setLS(JSON.stringify(t))},updateFilterUrl:function(t,e){for(var r=this.find(),s=null,n=null,l=0;l<r.length;l++)r[l].filterId==t&&(n=r[l].filterId,s=r[l].subscriptionUrl);var o=function(t){var r=i.FilterStorage,l=i.SubscriptionFilter.formTxt(t);l.filterId=n,l.subscriptionUrl=s;for(var o=0;o<this.groups.length;o++)l.filterId==this.groups[o].filterId&&(l.installed=!0,this.groups[o]=l);this.setLS(JSON.stringify(this.groups)),r.saveFilterRules(n,t,function(){e((new Date).getTime())}.bind(this))}.bind(this);null!==s&&(0==s.indexOf("local/")&&(s=s.replace("local/","http://tools.yiclear.com/")),this.serviceClient.loadFilterRulesBySubscriptionUrl(s,o))},getremoteFilterRule:function(e){var r=0,s=function(e,s,n){var l=new t.vPromise;return e.loadFilterRulesBySubscriptionUrl(n,function(t){var e=i.FilterStorage;r=t.length,e.saveFilterRules(s,t,null),l.resolve()},null),l}.bind(this);if(0!==this.groups.length){for(var n=[],l=0;l<this.groups.length;l++)n.push(s(this.serviceClient,this.groups[l].filterId,this.groups[l].subscriptionUrl));t.vPromise.all(n).then(function(){e(r)})}},getGroups:function(){return this.groups},getFiltersLanguages:function(){for(var i=Object.create(null),t=0;t<this.filters.length;t++){var e=this.filters[t].prefixes;e&&e.length>0&&(i[this.filters[t].filterId]=e)}return i}},i.SubscriptionFilter=function(i,t,e,r,s,n,l,o,u,a){this.filterId=i,this.title=t,this.specialization=e,this.subscriptionUrl=r,this.homepage=s,this.prefixes=n,this.author=l,this.lastUpdateTime=o,this.RuleCount=u,this.version=a},i.SubscriptionFilter.formTxt=function(t){var e=function(i){for(var t=i,e=null,r=null,s=null,n=null,l=null,o=0;o<20;o++){var u=t[o];/!\s+Version:\s+([0-9.]+)/i.test(u)?e=e||RegExp.$1:/!\s+Homepage:\s+(.+)$/i.test(u)?r=r||RegExp.$1:/!\s+Title:\s+(.+)$/i.test(u)?s=s||RegExp.$1:/!\s+Specialization:\s+(.+)$/i.test(u)?n=n||RegExp.$1:/!\s+Email:\s+(.+)$/i.test(u)&&(l=l||RegExp.$1)}return{title:s,version:e,homepage:r,Specialization:n,Email:l}},r=i.SubscriptionFilter,s=e(t),n=s.title,l=s.specialization,o=null,u=s.homepage,a=null,c=s.Email,h=s.version;return new r(0,n,l,o,u,a,c,(new Date).getTime(),t.length,h)},i.SubscriptionFilter.fromXml=function(t){var e=i.SubscriptionFilter,s=r(t,"title"),n=r(t,"specialization"),l=r(t,"url"),o=r(t,"homepage"),u=r(t,"prefixes"),a=r(t,"author"),c=r(t,"version");return new e(0,s,n,l,o,u,a,(new Date).getTime(),t.length,c)}}(yiclearAPI,vAPI);