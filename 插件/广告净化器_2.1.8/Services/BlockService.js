!function(e,t){"use strict";var i=e,r=t.EventNotifier,n=t.EventNotifierTypes,s=t.CollectionUtils,l=i.FilterLSUtils;e.BlockService=function(){this.yiclearFilters=[],this.requestFilter=new i.RequestFilter,this.ApplicationUpdateService=i.ApplicationUpdateService,this.subscriptionService=new i.SubscriptionService,this.filterClasses=i.filterClasses,this.userRules=[],this.applicationFilteringDisabled=i.userSettings.isFilteringDisabled(),this._requestFilterInitTime=0,this._processFilterEvent=null},e.FilterVersion=function(e,t,i){this.timeUpdated=e,this.version=t,this.filterId=i},e.BlockService.prototype={FILTERS_CHANGE_DEBOUCE_PERIOD:1e3,RELOAD_FILTERS_DEBOUNCE_PERIOD:1e3,contentBlockerInfo:{rulesCount:0,rulesOverLimit:!1},_addAndEnableFilters:function(e,t){t=t||function(){};var i=[];if(!e||0===e.length)return void t(i);var r=function(){if(0===e.length)t(i);else{var n=e.shift();this.addAntiBannerFilter(n,function(e){if(e){var t=this.enableAntiBannerFilter(n);t&&i.push(n)}r()}.bind(this))}}.bind(this);r()},addAntiBannerFilter:function(e,t){var i=this._getFilterById(e);if(i.installed)return void t(!0);var s=function(e){e&&(i.installed=!0,l.updateFilterStateInfo(i),r.notifyListeners(n.ADD_FILTER,i)),t(e)};return i.loaded?void s(!0):void this._loadFilterFromBackend(e,s)},_getFilterById:function(e){for(var t=0;t<this.yiclearFilters.length;t++){var i=this.yiclearFilters[t];if(i.filterId==e)return i}throw"Filter with id "+e+" not found"},_setFilterById:function(e){for(var t=0;t<this.yiclearFilters.length;t++){var i=this.yiclearFilters[t];if(i.filterId==e.filterId)return this.yiclearFilters[t]=e,!0}return!1},_loadFilterFromBackend:function(e,s){var a=t.Log,o=this._getFilterById(e);o._isDownloading=!0,r.notifyListeners(n.START_DOWNLOAD_FILTER,o);var u=function(e){a.info("Retrieved response from server for filter {0}, rules count: {1}",o.filterId,e.length),delete o._isDownloading,o.lastUpdateTime=(new Date).getTime(),o.lastCheckTime=Date.now(),o.loaded=!0,l.updateFilterStateInfo(o),l.updateFilterVersionInfo(o),r.notifyListeners(n.SUCCESS_DOWNLOAD_FILTER,o),r.notifyListeners(n.UPDATE_FILTER_RULES,o,e),s(!0)}.bind(this),F=function(e,t){a.error("Error retrieved response from server for filter {0}, cause: {1} {2}",o.filterId,e.statusText,t||""),delete o._isDownloading,r.notifyListeners(n.ERROR_DOWNLOAD_FILTER,o),s(!1)};this.subscriptionService.serviceClient.loadFilterRules(o.subscriptionUrl,i.userSettings.isUseOptimizedFiltersEnabled(),u,F)},enableAntiBannerFilter:function(e){var t=this._getFilterById(e);return!(t.enabled||!t.installed)&&(!t.enabled&&(t.enabled=!0,l.updateFilterStateInfo(t),r.notifyListeners(n.ENABLE_FILTER,t),!0))},removeAntiBannerFilter:function(e){var t=this._getFilterById(e);return"111"!=e&&(t.enabled=!1,t.installed=!1,l.updateFilterStateInfo(t),!!this._setFilterById(t)&&(r.notifyListeners(n.DISABLE_FILTER,t),r.notifyListeners(n.REMOVE_FILTER,t),!0))},disableAntiBannerFilter:function(e){var t=this._getFilterById(e);return!!t.enabled&&(t.enabled=!1,l.updateFilterStateInfo(t),r.notifyListeners(n.DISABLE_FILTER,t),!0)},initializeFiltersOnInstall:function(t){var i=function(e){this.yiclearFilters=this.filterClasses.getAllyiclearFilters(this.subscriptionService),this.yiclearFilters[2].enabled=!1,this.yiclearFilters[2].installed=!0,this.yiclearFilters[2].lastUpdateTime=(new Date).getTime(),this.yiclearFilters[2].RuleCount=e,this._addFiltersChangeEventListener(),this.enableAntiBannerFilter(this.yiclearFilters[2].filterId),t(this.yiclearFilters[2].filterId)}.bind(this),r=function(){var t=this.subscriptionService.getGroups();0===t.length||(e.userSettings.setProperty(e.userSettings.settings.DISABLE_AUTOUPDATE,!1),e.userSettings.setProperty(e.userSettings.settings.DISABLE_DEVELOPER,!1),e.userSettings.setProperty(e.userSettings.settings.DISABLE_SHOW_YOUKU_DANMU,!0),e.userSettings.setProperty(e.userSettings.settings.DISABLE_UPDATE_FIRSTRUN,!1),this.subscriptionService.getremoteFilterRule(i))}.bind(this);r()},_createRequestFilter:function(e){var r=t.Log,n=(new Date).getTime();r.info("Starting loading filter rules from the storage");var s=Object.create(null),l=function(){r.info("Finished loading filter rules from the storage in {0} ms",(new Date).getTime()-n),this._onFiltersLoadedFromStorage(s,e)}.bind(this),a=function(e,r){var n=new t.vPromise,s=i.FilterStorage;return s.loadFilterRules(e,function(t){t&&(r[e]=t),n.resolve()}),n},o=function(){for(var e=[],i=0;i<this.yiclearFilters.length;i++){var r=this.yiclearFilters[i];r.enabled&&e.push(a(r.filterId,s))}e.push(this._loadUserRulesToRequestFilter(s)),t.vPromise.all(e).then(l)}.bind(this);o()},_loadUserRulesToRequestFilter:function(e){var r=new t.vPromise,n=t.AntiBannerFiltersId.USER_FILTER_ID;return i.FilterStorage.loadFilterRules(n,function(t){return this.userRules=t||[],t?(e[n]=t,void r.resolve()):void r.resolve()}.bind(this)),r},_onFiltersLoadedFromStorage:function(e,s){var l=t.Log,a=(new Date).getTime(),o=i.Prefs.speedupStartup(),u=1e3;l.info("Starting request filter initialization. Async={0}",o);var F=new i.RequestFilter,c=Object.create(null),d=function(){this.requestFilter=F,s&&"function"==typeof s&&s(),r.notifyListeners(n.REQUEST_FILTER_UPDATED,this.getRequestFilterInfo()),l.info("Finished request filter initialization in {0} ms. Rules count: {1}",(new Date).getTime()-a,F.rulesCount),0!==F.rulesCount||this.reloadedRules?F.rulesCount>0&&this.reloadedRules&&(l.info("Filters reloaded, deleting reloadRules flag"),delete this.reloadedRules):(l.info("No rules have been found - checking filter updates"),this._reloadAntiBannerFilters(),this.reloadedRules=!0)}.bind(this),h=function(e,t,r,n){var s=i.FilterRuleBuilder;if(t)for(var l=r;l<t.length&&l<n;l++){var a=t[l];if(!(a in c)){c[a]=!0;var o=s.createRule(a,e);null!==o&&F.addRule(o)}}},f=function(e,i,r,n,s){var l=new t.vPromise;return s.then(function(){setTimeout(function(){h(e,i,r,n),l.resolve()},1)}),l},E=function(){var i=new t.vPromise,r=null,n=[];for(var s in e)if(s-=0,s!=t.AntiBannerFiltersId.USER_FILTER_ID)for(var l=e[s],a=0;a<l.length;a+=u)r=f(s,l,a,a+u,r||i),n.push(r);var o=e[t.AntiBannerFiltersId.USER_FILTER_ID];f(t.AntiBannerFiltersId.USER_FILTER_ID,o,0,o.length,r||i),t.vPromise.all(n).then(function(){d()}),i.resolve()},R=function(){for(var i in e)if(i-=0,i!=t.AntiBannerFiltersId.USER_FILTER_ID){var r=e[i];h(i,r,0,r.length)}var n=e[t.AntiBannerFiltersId.USER_FILTER_ID];h(t.AntiBannerFiltersId.USER_FILTER_ID,n,0,n.length),d()};o?E():R()},getRequestFilterInfo:function(){for(var e=0,t=0,i=0,r=[],n=0;n<this.yiclearFilters.length;n++)this.yiclearFilters[n].enabled&&r.push(this.yiclearFilters[n]);return this.requestFilter&&(e=this.requestFilter.rulesCount,t=this.requestFilter.cssFilter.commonRules.length+this.requestFilter.cssFilter.exceptionRules.length+this.requestFilter.cssFilter.domainSensitiveRules.length,i=e-t),{enabledFilters:r,rulesCount:e,cssCount:t,urlCount:i}},updateContentBlockerInfo:function(e){this.contentBlockerInfo.rulesCount=e.rulesCount,this.contentBlockerInfo.rulesOverLimit=e.rulesOverLimit},isAntiBannerFilterEnabled:function(e){return this._getFilterById(e).enabled},getContentBlockerInfo:function(){return this.contentBlockerInfo},getFiltersMetadata:function(){for(var e=[],t=2;t<this.yiclearFilters.length;t++)e.push(this.yiclearFilters[t]);return e},_getUserFilterRule:function(e,t){for(var i=2;i<this.yiclearFilters.length;i++)if(this.yiclearFilters[i].subscriptionUrl==e){var s=this.yiclearFilters[i];return this.yiclearFilters[i].enabled=!1,this.yiclearFilters[i].installed=!0,s=this.yiclearFilters[i],r.notifyListeners(n.DISABLE_FILTER,s),this.enableAntiBannerFilter(s.filterId),void t(s)}this.subscriptionService.getUserFilterRule(e,function(e){e&&(t(e),this.yiclearFilters.push(e),this.enableAntiBannerFilter(e.filterId))}.bind(this))},_autoUpdateFilterUrl:function(e,t){this.subscriptionService.updateFilterInfo(e),this._updateFilterUrl(e.filterId,function(){e.version=t,this.subscriptionService.updateFilterInfo(e)}.bind(this))},_updateFilterUrl:function(e,t){this.subscriptionService.updateFilterUrl(e,function(i){for(var s=0;s<this.yiclearFilters.length;s++)if(this.yiclearFilters[s].filterId==Number(e)){this.yiclearFilters[s].lastUpdateTime=i;for(var l=this.subscriptionService.getGroups(),a=0;a<l.length;a++)l[a].filterId==Number(this.yiclearFilters[s].filterId)&&(this.yiclearFilters[s].RuleCount=l[a].RuleCount,this.yiclearFilters[s].name=l[a].name||l[a].title)}var o=this._getFilterById(e);o.enabled=!1,r.notifyListeners(n.DISABLE_FILTER,o),o.enabled=!0,r.notifyListeners(n.ENABLE_FILTER,o),t(i)}.bind(this))},getEnabledAntiBannerFilters:function(){return this.yiclearFilters.filter(function(e){return e.installed&&e.enabled&&e.filterId!=t.AntiBannerFiltersId.USER_FILTER_ID&&e.filterId!=t.AntiBannerFiltersId.WHITE_LIST_FILTER_ID})},addAndEnableFilter:function(e){this._addAndEnableFilters([e])},addUserFilterRule:function(e){var s=i.FilterRuleBuilder,l=s.createRule(e,t.AntiBannerFiltersId.USER_FILTER_ID);null!==l&&(this._addRuleToFilter(t.AntiBannerFiltersId.USER_FILTER_ID,l),this.userRules.push(l.ruleText)),r.notifyListeners(n.UPDATE_USER_FILTER_RULES,this.getRequestFilterInfo())},addUserFilterRules:function(e){for(var s=i.FilterRuleBuilder,l=[],a=0;a<e.length;a++){var o=s.createRule(e[a],t.AntiBannerFiltersId.USER_FILTER_ID);null!==o&&(l.push(o),this.userRules.push(o.ruleText))}return this._addRulesToFilter(t.AntiBannerFiltersId.USER_FILTER_ID,l),r.notifyListeners(n.UPDATE_USER_FILTER_RULES,this.getRequestFilterInfo()),l},_addRuleToFilter:function(e,t){var i=this._getFilterById(e);this.requestFilter.addRule(t),r.notifyListeners(n.ADD_RULE,i,[t])},_addRulesToFilter:function(e,t){var i=this._getFilterById(e);this.requestFilter.addRules(t),r.notifyListeners(n.ADD_RULES,i,t)},removeUserFilter:function(e){var l=i.FilterRuleBuilder,a=l.createRule(e,t.AntiBannerFiltersId.USER_FILTER_ID);if(null!==a){var o=this._getFilterById(t.AntiBannerFiltersId.USER_FILTER_ID);this.requestFilter.removeRule(a),r.notifyListeners(n.REMOVE_RULE,o,[a])}s.removeAll(this.userRules,e),r.notifyListeners(n.UPDATE_USER_FILTER_RULES,this.getRequestFilterInfo())},init:function(e){var t=this,r=this.ApplicationUpdateService.getRunInfo(),n=function(t){0===this._requestFilterInitTime&&(this._requestFilterInitTime=(new Date).getTime()),e.runCallback&&e.runCallback(t)}.bind(this),s=function(){i.whiteListService.initWhiteListFilters(),t._createRequestFilter(function(){this._addFiltersChangeEventListener(),n(r)}.bind(this))}.bind(this),l=function(){this._subscribeToFiltersChangeEvents(),r.isFirstRun?n(r):(this.yiclearFilters=this.filterClasses.getAllyiclearFilters(this.subscriptionService),s())}.bind(this);this.subscriptionService.init(l)},_subscribeToFiltersChangeEvents:function(){var e=t.platformUtils.debounce(this._reloadAntiBannerFilters.bind(this),this.RELOAD_FILTERS_DEBOUNCE_PERIOD);r.addListener(function(t,r){return t===n.CHANGE_USER_SETTINGS&&r===i.userSettings.settings.USE_OPTIMIZED_FILTERS?void e():void((t==n.CHANGE_USER_SETTINGS&&r==i.userSettings.settings.DISABLE_COLLECT_HITS||t==n.CHANGE_PREFS&&"use_global_style_sheet"==r)&&(this.getRequestFilter().cssFilter.dirty=!0))}.bind(this))},_reloadAntiBannerFilters:function(){this._resetFiltersVersion()},_resetFiltersVersion:function(){},isApplicationFilteringDisabled:function(){return this.applicationFilteringDisabled},isRequestFilterReady:function(){return this._requestFilterInitTime>0},shouldCollapseAllElements:function(){return this._requestFilterInitTime>0&&this._requestFilterInitTime+3e3>(new Date).getTime()},getRequestFilter:function(){return this.requestFilter},getUserFilters:function(e,i,r){for(var n=t.StringUtils,s=this.userRules,l=[],a=0;a<s.length;a++){var o=s[a];r&&!n.containsIgnoreCase(o,r)||l.push(o)}return i?l.slice(e,e+i):l},clearUserFilter:function(){this.userRules=[];var e=this._getFilterById(t.AntiBannerFiltersId.USER_FILTER_ID);r.notifyListeners(n.UPDATE_FILTER_RULES,e,[]),r.notifyListeners(n.UPDATE_USER_FILTER_RULES,this.getRequestFilterInfo())},whiteListFrame:function(e){i.whiteListService.whiteListUrl(e.url),r.notifyListeners(n.UPDATE_WHITELIST_FILTER_RULES)},unWhiteListFrame:function(e){e.frameRule&&(i.whiteListService.unWhiteListUrl(e.url),r.notifyListeners(n.UPDATE_WHITELIST_FILTER_RULES))},getWhiteListDomains:function(e,r,n){for(var s=t.StringUtils,l=i.whiteListService.getWhiteList(),a=[],o=0;o<l.length;o++){var u=l[o];n&&!s.containsIgnoreCase(u,n)||a.push(u)}return r?a.slice(e,e+r):a},addWhiteListDomain:function(e){i.whiteListService.addToWhiteList(e),r.notifyListeners(n.UPDATE_WHITELIST_FILTER_RULES)},addWhiteListDomains:function(e){i.whiteListService.addToWhiteListArray(e),r.notifyListeners(n.UPDATE_WHITELIST_FILTER_RULES)},removeWhiteListDomain:function(e){i.whiteListService.removeFromWhiteList(e),r.notifyListeners(n.UPDATE_WHITELIST_FILTER_RULES)},clearWhiteListFilter:function(){i.whiteListService.clearWhiteList(),r.notifyListeners(n.UPDATE_WHITELIST_FILTER_RULES)},_addFiltersChangeEventListener:function(){var e=[],i=null,s=function(s,l,u){e.push({event:s,filter:l,rules:u}),null!==i&&clearTimeout(i),i=setTimeout(function(){var s=e.slice(0);e=[],i=null;for(var l=s.some(function(e){return a.indexOf(e.event)>=0}),u=Object.create(null),F=0;F<s.length;F++){var c=s[F];c.filter.filterId in u||(u[c.filter.filterId]=[]),u[c.filter.filterId].push(c)}var d=[],h=function(e){return o.indexOf(e.event)>=0};for(var f in u){var E=u[f].some(h);if(E){var R=this._processSaveFilterRulesToFSEvents(f,u[f]);d.push(R)}}l?t.vPromise.all(d).then(this._createRequestFilter.bind(this)):r.notifyListeners(n.REQUEST_FILTER_UPDATED,this.getRequestFilterInfo())}.bind(this),this.FILTERS_CHANGE_DEBOUCE_PERIOD)}.bind(this);r.addListener(function(e,t,i){switch(e){case n.ADD_RULE:case n.ADD_RULES:case n.REMOVE_RULE:case n.UPDATE_FILTER_RULES:case n.ENABLE_FILTER:case n.DISABLE_FILTER:s(e,t,i)}})},_processSaveFilterRulesToFSEvents:function(e,r){var l=new t.vPromise;return i.FilterStorage.loadFilterRules(e,function(t){for(var a=0;a<r.length;a++){t||(t=[]);var o=r[a],u=o.event,F=o.rules;switch(u){case n.ADD_RULE:case n.ADD_RULES:t=t.concat(s.getRulesText(F));break;case n.REMOVE_RULE:var c=F[0];s.removeAll(t,c.ruleText);break;case n.UPDATE_FILTER_RULES:t=s.getRulesText(F)}}i.FilterStorage.saveFilterRules(e,t,l.resolve)}.bind(this)),l}};var a=[n.UPDATE_FILTER_RULES,n.ENABLE_FILTER,n.DISABLE_FILTER],o=[n.UPDATE_FILTER_RULES,n.ADD_RULE,n.ADD_RULES,n.REMOVE_RULE]}(yiclearAPI,vAPI);