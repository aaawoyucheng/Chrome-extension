!function(e,t){e.ClientService=function(){this.ServerUrl="http://tools.yiclear.com",this.yiclearAppUrl=this.ServerUrl+"",this.loadingSubscriptions=Object.create(null)},e.ClientService.prototype={loadYiclearSubscriptions:function(t,i){var n=e.SubscriptionFilter,s=function(e){var s=e.responseXML;if(s&&s.getElementsByTagName){for(var r=[],o=s.getElementsByTagName("subscription"),l=0;l<o.length;l++){var a=n.fromXml(o[l]);a.filterId=o.length+110+l,a.lastUpdateTime=(new Date).getTime(),r.push(a)}t(r)}else i(e,"empty response")},r=e.Prefs.localSubscriptionsPath;this._executeRequestAsync(r,"text/xml",s,i)},loadFilterRules:function(e,t,i,n){this.loadFilterRulesBySubscriptionUrl(e,i,n)},loadFilterRulesBySubscriptionUrl:function(e,i,n){if(!(e in this.loadingSubscriptions)){this.loadingSubscriptions[e]=!0;var s=this,r=function(t){if(delete s.loadingSubscriptions[e],200!==t.status)return void n(t,"wrong status code: "+t.status);var r=(t.responseText||"").trim();if(0===r.length)return void n(t,"filter rules missing");var o=r.split(/[\r\n]+/);0===o[0].indexOf("[")&&o.shift(),i(o)},o=function(t,i){delete s.loadingSubscriptions[e],n(t,i)};t.StringUtils.startWith(e,"local/")&&(e=t.ext.getURL("ChinaList2.0.txt")),this._executeRequestAsync(e,"text/plain",r,o)}},_executeRequestAsync:function(e,i,n,s){var r=t.Cc["@mozilla.org/xmlextras/xmlhttprequest;1"],o=r.createInstance(t.Ci.nsIXMLHttpRequest),l=e;t.StringUtils.contains(e,"://")||(l="http://"+e);try{if(o.open("GET",l),o.setRequestHeader("Content-type",i),o.setRequestHeader("Pragma","no-cache"),o.overrideMimeType(i),o.mozBackgroundRequest=!0,n&&(o.onload=function(){n(o)}),s){var a=function(){s(o)};o.onerror=a,o.onabort=a,o.ontimeout=a}o.send(null)}catch(e){s&&s(o,e)}},yiclearAppAddRule:function(e,t,i){this._executeRequestAsync(this.yiclearAppUrl+"type=add&rule="+encodeURIComponent(e),"text/plain",t,i)},yiclearFilterUpdate:function(e){var t=function(t){var i=t.responseText,n=JSON.parse(i);e(n)}.bind(this),i=function(e){};this._executeRequestAsync(this.yiclearAppUrl+"/FiltersInfo.json","text/plain",t,i)}}}(yiclearAPI,vAPI);