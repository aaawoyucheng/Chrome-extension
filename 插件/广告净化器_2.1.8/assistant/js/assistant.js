var YiclearAssistant=function(e){var t=this,n={iframeId:"yiclear-assistant-dialog",path:null,selectedElement:null,lastPreview:null,cssRuleIndex:null,urlBlockAttributes:["src","data"],urlInfo:null,croppedDomain:null},i={phishing:"phishing",wrongRender:"wrongRender",adMissing:"adMissing",another:"another",minComplaintMessageLength:8,maxComplaintCommentLength:500,iframe:{baseWidth:668,extendDetailedSettingsHeight:503,detailedMenuHeight:340,selectorMenuHeight:213,topOffset:25}},l={getAllChilds:function(e){for(var t=[],n=e;n=l.getChildren(n);)t.push(n);return t},getChildren:function(e){var t=e.childNodes;if(t){var n,i,l=0;for(i=0;i<t.length;i++)1==t[i].nodeType&&(n=t[i],l++)}return 1==l?n:null},getParentsLevel:function(e){for(var t=e,n=[];(t=t.parentNode)&&"BODY"!=l.getNodeName(t);)n.push(t);return n},getNodeName:function(e){return e&&e.nodeName?e.nodeName.toUpperCase():""},getUrl:function(e){var t="^(([^:/\\?#]+):)?(//(([^:/\\?#]*)(?::([^/\\?#]*))?))?([^\\?#]*)(\\?([^#]*))?(#(.*))?$",n=new RegExp(t),i=n.exec(e);return{host:i[4]||"",path:i[7]||""}},cropDomain:function(e){return e.replace("www.","").replace(/:\d+/,"")}},o=function(){return n.croppedDomain||(n.croppedDomain=l.cropDomain(c().host)),n.croppedDomain},c=function(){return n.urlInfo||(n.urlInfo=l.getUrl(document.location)),n.urlInfo},s=function(e){return t.localization[e]},a=function(t){var n=m(),i=h("#drag-handle"),l=e(t.contentDocument),o=Object.create(null),c=function(e){return e||(e=window.event),{x:e.screenX,y:e.screenY}},s=function(e,t){var i=e,l=t;i<0&&(i=0),l<0&&(l=0),n.css("left",i+"px"),n.css("top",l+"px")},a=function(e){e.preventDefault(),e.stopPropagation()},r=function(e){var t=c(e);s(t.x+o.x,t.y+o.y)},d=function(e){var t=c(e),s=i.get(0),d=n.get(0).getBoundingClientRect();o.x=d.left+s.offsetLeft-t.x,o.y=d.top+s.offsetTop-t.y,l.on("mousemove",r),l.on("selectstart",a)},u=function(){l.off("mousemove",r),l.off("selectstart",a)};i.on("mousedown",d),l.on("mouseup",u)},r=function(){return{width:window.innerWidth,height:window.innerHeight}},d=function(e,t,n,i){return{left:t.width-i-e,top:e}},u=function(t,l,o){var c=r(),s=d(i.iframe.topOffset,c,l,t),a=document.createElement("iframe");return a.setAttribute("id",n.iframeId),a.setAttribute("class","sg_ignore yi-view-important"),a.setAttribute("frameBorder","0"),a.setAttribute("allowTransparency","true"),a.style.width=t+"px",a.style.height=l+"px",a.style.position="fixed",a.style.left=s.left+"px",a.style.top=s.top+"px",a.style.zIndex=9999,e(a).on("load",f.bind(null,a,o)),document.body.appendChild(a),a},f=function(e,i){try{var l=e.contentDocument;l.open(),l.write("<html><head></head></html>"),l.close()}catch(e){}contentPage.sendMessage({type:"loadAssistant"},function(e){e.localization&&(t.localization=e.localization);var l=e.cssContent,o=e.cssLink,c=document.getElementById(n.iframeId),s=c.contentDocument.getElementsByTagName("head")[0];if(l){var a=document.createElement("style");a.type="text/css",a.textContent=l,s.appendChild(a)}if(o){var r=document.createElement("link");r.type="text/css",r.rel="stylesheet",r.href=o,s.appendChild(r)}i.resolve()})},m=function(){return e("#"+n.iframeId)},h=function(t){return e(m().get(0).contentDocument.querySelectorAll(t))},v=function(e,t,n){t&&t(e),a(e),h("body").removeClass("yi-hide"),n&&n(e)},b=function(e,t,n,i,l){var o=function(){k(a,e),v(a,i,l),Y()},c=m();if(c.length>0)return a=c.get(0),p(t,n,a),void o();var s=new Deferred;s.done(o);var a=u(t,n,s)},p=function(e,t,n){n.style.width=e+"px",n.style.height=t+"px"},k=function(e,t){for(var n=e.contentDocument.body,i=0;i<n.children.length;i++)n.removeChild(n.children[i]);n.appendChild(t.get(0)),h("body").addClass("yi-hide")},x=function(t,n){for(var i in n)e(t.contentDocument.querySelectorAll(i)).on("click",n[i])},g=function(e){e.preventDefault();var t=new Deferred;t.done(function(){B(),V(),E()}),N(t)},y=function(e){e.preventDefault(),V(),_(),C()},_=function(){YiclearSelectorLib.close()},w=function(e){n.selectedElement=e;var t=D(e),i=S(e);I(e,t,i)},C=function(){_(),m().remove()},E=function(){YiclearSelectorLib.reset(),YiclearSelectorLib.init(w)},D=function(e){var t=q(e);return t&&""!=t},S=function(e){var t=e.className;return t&&""!=t.trim()},A=function(e){h("#filter-rule").get(0).value=e},B=function(){for(var e=h("[i18n]"),t=0;t<e.length;t++){var n=s(e[t].getAttribute("i18n"));I18nHelper.translateElement(e[t],n)}h("#blockClass").hide(),h("#blockSimilar").hide(),h("#blockByUrl").hide(),h("#oneDomainRadio").hide()},M=function(){return e('<div class="main"><div class="close yi-close"></div><div class="head" id="drag-handle">\t<div i18n="assistant_block_element" class="head_title" id="head_title"></div>\t<div i18n="assistant_block_element_explain" class="head_text" id="head_text"></div></div><div class="content">\t<div class="element-rule">\t\t<div i18n="assistant_slider_explain" class="element-rule_text"></div>\t\t<div class="element-rule_slider">\t\t\t<div class="yi-slide" id="slider">\t\t\t\t<div class="yi-slide-clue-max">MAX</div>\t\t\t\t<div class="yi-slide-clue-min">MIN</div>\t\t\t</div>\t\t</div>\t\t<div class="element-rule_more">\t\t\t<span class="element-rule_expand-link" id="ExtendedSettingsText">\t\t\t\t<span i18n="assistant_extended_settings" class="element-rule_expand-link_txt"></span>\t\t\t\t<span class="element-rule_expand-link_arr"></span>\t\t\t</span>\t\t</div>\t\t<div class="element-rule_form" id="adv-settings">\t\t\t<div class="element-rule_form-cont">\t\t\t\t<div class="element-rule_fieldset" id="one-domain-checkbox-block">\t\t\t\t\t<input class="form-ui-control" id="one-domain-checkbox" type="checkbox"/>\t\t\t\t\t<label for="one-domain-checkbox" class="form-ui">\t\t\t\t\t\t<span i18n="assistant_apply_rule_to_all_sites" class="form-ui-txt"></span>\t\t\t\t\t</label>\t\t\t\t</div>\t\t\t\t<div style="display: none;" class="element-rule_fieldset" id="block-by-url-checkbox-block">\t\t\t\t\t<input class="form-ui-control" id="block-by-url-checkbox" type="checkbox"/>\t\t\t\t\t<label for="block-by-url-checkbox" class="form-ui">\t\t\t\t\t\t<span i18n="assistant_block_by_reference" class="form-ui-txt"></span>\t\t\t\t\t</label>\t\t\t\t</div>\t\t\t\t<div style="display: none;" class="element-rule_fieldset" id="block-similar-checkbox-block">\t\t\t\t\t<input class="form-ui-control" id="block-similar-checkbox" type="checkbox"/>\t\t\t\t\t<label for="block-similar-checkbox" class="form-ui">\t\t\t\t\t\t<span i18n="assistant_block_similar" class="form-ui-txt"></span>\t\t\t\t\t</label>\t\t\t\t</div>\t\t\t\t<div style="display: none;" class="element-rule_fieldset" id="block-class-checkbox-block">\t\t\t\t\t<input class="form-ui-control" id="block-class-checkbox" type="checkbox"/>\t\t\t\t\t<label for="block-class-checkbox" class="form-ui">\t\t\t\t\t\t<span i18n="assistant_block_class" class="form-ui-txt"></span>\t\t\t\t\t</label>\t\t\t\t</div>\t\t\t\t<div class="element-rule_fieldset">\t\t\t\t\t<input class="form-control" id="filter-rule" type="text"/>\t\t\t\t</div>\t\t\t</div>\t\t</div>\t</div></div><div class="foot">\t<button i18n="assistant_another_element" type="button" class="btn btn-default" id="yi-cancel"></button>\t<div class="foot_action">\t\t<div class="foot_action_btn">\t\t\t<button i18n="assistant_preview" type="button" class="btn btn-primary" id="yi-preview"></button>\t\t\t<button i18n="assistant_block" type="button" class="btn btn-cancel" id="yi-accept"></button>\t\t</div>\t</div></div></div>')},L=function(){return e('<div class="main sg_ignore"><div class="close yi-close" id="close-button"></div><div class="head" id="drag-handle">\t<div i18n="assistant_select_element" class="head_title"></div>\t<div i18n="assistant_select_element_ext" class="head_text"></div></div><div class="foot">\t<button i18n="assistant_select_element_cancel" type="button" class="btn btn-default" id="cancel-select-mode"></button></div></div>')},T=function(e){var t=M();b(t,i.iframe.baseWidth,i.iframe.detailedMenuHeight,function(t){x(t,{"#close-button":y,".yi-close":y,"#adv-settings":$,"#yi-cancel":g,"#yi-preview":X,"#yi-accept":F,"#ExtendedSettingsText":H}),e.resolve()},function(){B()})},N=function(e){var t=L();b(t,i.iframe.baseWidth,i.iframe.selectorMenuHeight,function(t){x(t,{"#cancel-select-mode":y,".yi-close":y}),e.resolve()},null)},I=function(e,t,n){var i=new Deferred;i.done(function(){z(e),YiclearSelectorLib.selectElement(e),$(),R(),O(t,n)}),T(i)},P=function(e,t){var n=m().get(0);t&&(n.style.height=t+"px"),e&&(n.style.width=e+"px"),Y()},Y=function(){var e=window.innerHeight,t=document.body.scrollTop+e,n=m().get(0),l=n.getBoundingClientRect().top+document.body.scrollTop,o=n.offsetHeight;if(l+o>t){var c=e-o-i.iframe.topOffset;c<0&&(c=i.iframe.topOffset),n.style.top=c+"px"}},H=function(){var e=!h("#adv-settings").hasClass("open");e?(P(null,i.iframe.extendDetailedSettingsHeight),h("#adv-settings").addClass("open"),h("#ExtendedSettingsText").addClass("active")):(P(null,i.iframe.detailedMenuHeight),h("#adv-settings").removeClass("open"),h("#ExtendedSettingsText").removeClass("active"))},R=function(){var e=o();h("#oneDomainText").text(e)},z=function(e){var t=l.getParentsLevel(e),n=l.getAllChilds(e),i=Math.abs(t.length+1),o=t.length+n.length+1,c=1,a={value:i,min:c,max:o};c==o&&(h("#slider").hide(),h(".element-rule_text").text(s("assistant_slider_if_hide"))),a.onSliderMove=function(i){var l;i>0&&(l=t[i-1]),0==i&&(l=e),i<0&&(l=n[Math.abs(i+1)]),U(l)},SliderWidget.init(h("#slider").get(0),{min:a.min,max:a.max,value:a.value,onValueChanged:function(e){var t=a.value-e;a.onSliderMove(t)}})},O=function(e,t){e?h("#block-by-url-checkbox-block").show():(h("#block-by-url-checkbox").get(0).checked=!1,h("#block-by-url-checkbox-block").hide()),t?(h("#block-similar-checkbox-block").show(),h("#block-class-checkbox-block").show()):(h("#block-similar-checkbox").get(0).checked=!1,h("#block-similar-checkbox-block").hide(),h("#block-class-checkbox").get(0).checked=!1,h("#block-class-checkbox-block").hide())},U=function(e){V(),n.selectedElement=e,YiclearSelectorLib.selectElement(e),W(),$(),O(D(e),S(e))},W=function(){h("#block-by-url-checkbox").get(0).checked=!1,h("#block-similar-checkbox").get(0).checked=!1,h("#block-class-checkbox").get(0).checked=!1,h("#one-domain-checkbox").get(0).checked=!1},q=function(e){for(var t=0;t<n.urlBlockAttributes.length;t++){var i=n.urlBlockAttributes[t],l=e.getAttribute(i);if(l)return l}return null},X=function(e){return e&&e.preventDefault(),n.lastPreview?(V(),h("#head_title").text(s("assistant_block_element")),h("#head_text").text(s("assistant_block_element_explain")),h("#yi-preview").text(s("assistant_preview_start")),YiclearSelectorLib.selectElement(n.selectedElement),void h(".content").show()):(j(),h("#head_title").text(s("assistant_preview_header")),h("#head_text").text(s("assistant_preview_header_info")),h("#yi-preview").text(s("assistant_preview_end")),void h(".content").hide())},j=function(){YiclearSelectorLib.reset();var e=h("#block-similar-checkbox").get(0).checked,t=YiclearRulesConstructorLib.constructCssSelector(n.selectedElement,e),i=document.createElement("style");i.setAttribute("type","text/css"),n.lastPreview=i;var l=document.getElementsByTagName("head")[0];l&&(i.appendChild(document.createTextNode(t+" {display: none !important;}")),l.appendChild(i))},V=function(){if(null!=n.lastPreview){var e=document.getElementsByTagName("head")[0];e&&e.removeChild(n.lastPreview),n.lastPreview=null}},$=function(){var e=h("#block-by-url-checkbox").get(0).checked,t=h("#block-similar-checkbox").get(0).checked,i=h("#block-class-checkbox").get(0).checked,l=h("#one-domain-checkbox").get(0).checked;O(D(n.selectedElement)&&!t,S(n.selectedElement)&&!e);var c={isBlockByUrl:e,urlMask:q(n.selectedElement),isBlockSimilar:t,isBlockClass:i,isBlockOneDomain:l,domain:o()},s=YiclearRulesConstructorLib.constructRuleText(n.selectedElement,c);A(s)},F=function(){V(),X(),n.lastPreview=null;var e=h("#filter-rule").get(0).value;contentPage.sendMessage({type:"addUserRule",ruleText:e},function(){C()})},G=function(){var t=function(){n.selectedElement&&!n.lastPreview&&YiclearSelectorLib.selectElement(n.selectedElement)};e(window).on("resize",t),e(window).on("scroll",t)};G(),this.init=function(e){t.localization=e.localization;var n=new Deferred;n.done(function(){B(),V(),E(),e.selectedElement&&e.selectedElement.click()}),N(n)},this.destroy=function(){V(),_(),C()}};