!function(e,s){"use strict";var t=e.BaseFilterRule,i=s.ext.app.getBrowserVersion()>34,n=s.platformUtils.isFirefoxBrowser(),l=s.platformUtils.isShadowDomSupported();e.CssFilter=function(e){if(this.commonCss=null,this.commonCssHits=null,this.commonRules=[],this.domainSensitiveRules=[],this.exceptionRules=[],this.extendedCssRules=[],this.dirty=!1,this.interceptPrefix="yi-intercept",this.ruleByKeyMap=Object.create(null),this.keyByRuleMap=Object.create(null),e)for(var s=0;s<e.length;s++)this.addRule(e[s])},e.CssFilter.prototype={addRule:function(e){e.whiteListRule?this.exceptionRules.push(e):e.extendedCss?this.extendedCssRules.push(e):e.isDomainSensitive()?this.domainSensitiveRules.push(e):this.commonRules.push(e),this._addRuleToMap(e),this.dirty=!0},removeRule:function(e){var s=e.ruleText;this.exceptionRules=this.exceptionRules.filter(function(e){return e.ruleText!=s}),this.extendedCssRules=this.extendedCssRules.filter(function(e){return e.ruleText!=s}),this.domainSensitiveRules=this.domainSensitiveRules.filter(function(e){return e.ruleText!=s}),this.commonRules=this.commonRules.filter(function(e){return e.ruleText!=s}),this._rollbackExceptionRule(e),this._deleteRuleFromMap(e),this.dirty=!0},clearRules:function(){this.commonRules=[],this.domainSensitiveRules=[],this.exceptionRules=[],this.extendedCssRules=[],this.commonCss=null,this.ruleByKeyMap=Object.create(null),this.keyByRuleMap=Object.create(null),this.dirty=!0},getRules:function(){var e=[];return e.concat(this.commonRules).concat(this.domainSensitiveRules).concat(this.exceptionRules).concat(this.extendedCssRules)},buildCss:function(e,s){this._rebuild();var t=this._filterRules(e,s),i=this._createCssStylesheets(t);return s||(i.css=this._getCommonCss().concat(i.css)),i},buildInjectCss:function(e,s){this._rebuildBinding();var t=this._filterDomainSensitiveRules(e),i=[];null!==t&&(i=t.filter(function(e){return(e.isInjectRule||e.extendedCss)&&(!s||!e.isGeneric())}));var n;if(s)n=i;else{var l=this.commonRules.filter(function(e){return e.isInjectRule});n=i.concat(l)}return this._createCssStylesheets(n)},buildCssHits:function(e,s,t){this._rebuildHits(s);var i=this._filterRules(e,t),n=this._createCssStylesheetsHits(i,s);return t||(n.css=this._getCommonCssHits(s).concat(n.css)),n},_filterRules:function(e,s){var t,i=this._filterDomainSensitiveRules(e);if(s){var n=[];null!==i&&(n=i.filter(function(e){return!e.isGeneric()})),t=n}else t=i;return t},_createCssStylesheets:function(e){var s=e.filter(function(e){return e.extendedCss}),t=e.filter(function(e){return!e.extendedCss});return{css:this._buildCssByRules(t),extendedCss:this._buildCssByRules(s)}},_createCssStylesheetsHits:function(s,t){var i=s.filter(function(e){return e.extendedCss}),n=s.filter(function(e){return!e.extendedCss});return{css:this._buildCssByRulesHits(n,e.Prefs.csspath+t),extendedCss:this._buildCssByRulesHits(i,e.Prefs.csspath+t)}},getRuleForKey:function(e){return e in this.ruleByKeyMap?this.ruleByKeyMap[e]:null},_deleteRuleFromMap:function(e){if(n){var s=this.keyByRuleMap[e.ruleText];delete this.ruleByKeyMap[s],delete this.keyByRuleMap[e.ruleText]}},_addRuleToMap:function(e){if(n){if(e.ruleText in this.keyByRuleMap)return;var s;do s=Math.random().toFixed(15).substr(5);while(s in this.ruleByKeyMap);this.ruleByKeyMap[s]=e,this.keyByRuleMap[e.ruleText]=s}},_rebuild:function(){this.dirty&&(this._applyExceptionRules(),this.commonCss=this._buildCssByRules(this.commonRules),this.commonCssHits=null,this.dirty=!1)},_rebuildHits:function(s){this.dirty&&(this._applyExceptionRules(),this.commonCssHits=this._buildCssByRulesHits(this.commonRules,e.Prefs.csspath+s),this.commonCss=null,this.dirty=!1)},_rebuildBinding:function(){this.dirty&&(this._applyExceptionRules(),this.commonCss=null,this.commonCssHits=null,this.dirty=!1)},_applyExceptionRules:function(){var e,s,t,i,n=this._arrayToMap(this.exceptionRules,"cssSelector");for(e=0;e<this.domainSensitiveRules.length;e++)if(t=this.domainSensitiveRules[e],i=n[t.cssSelector])for(s=0;s<i.length;s++)this._applyExceptionRule(t,i[s]);var l=[];for(e=0;e<this.commonRules.length;e++)if(t=this.commonRules[e],i=n[t.cssSelector]){for(s=0;s<i.length;s++)this._applyExceptionRule(t,i[s]);t.isDomainSensitive()&&l.push(t)}var u=this._arrayToMap(l,"ruleText");this.domainSensitiveRules=this.domainSensitiveRules.concat(l),this.commonRules=this.commonRules.filter(function(e){return!(e.ruleText in u)})},_applyExceptionRule:function(e,s){e.cssSelector==s.cssSelector&&e.addRestrictedDomains(s.getPermittedDomains())},_getCommonCss:function(){return null!=this.commonCss&&0!=this.commonCss.length||(this.commonCss=this._buildCssByRules(this.commonRules)),this.commonCss},_getCommonCssHits:function(s){return null!=this.commonCssHits&&0!=this.commonCssHits.length||(this.commonCssHits=this._buildCssByRulesHits(this.commonRules,e.Prefs.csspath+s)),this.commonCssHits},_rollbackExceptionRule:function(e){if(e.whiteListRule){var s,t,i=[];for(s=0;s<this.domainSensitiveRules.length;s++)t=this.domainSensitiveRules[s],t.cssSelector==e.cssSelector&&(t.removeRestrictedDomains(e.getPermittedDomains()),t.isDomainSensitive()||i.push(t));this.commonRules=this.commonRules.concat(i);var n=this._arrayToMap(i,"ruleText");this.domainSensitiveRules=this.domainSensitiveRules.filter(function(e){return!(e.ruleText in n)})}},_filterDomainSensitiveRules:function(e){var s,t=[];if(e){if(null!==this.domainSensitiveRules)for(var i=this.domainSensitiveRules.length;i--;)s=this.domainSensitiveRules[i],s.isPermitted(e)&&t.push(s);if(null!==this.extendedCssRules)for(var n=this.extendedCssRules.length;n--;)s=this.extendedCssRules[n],s.isPermitted(e)&&t.push(s)}return t},_buildCssByRules:function(e){for(var s=50,t=" { display: none!important; }\r\n",i=[],n=0,l=[],u=0;u<e.length;u++){var r=e[u];r.isInjectRule?l.push(this._getRuleCssSelector(r)):(i.push(this._getRuleCssSelector(r)),++n,n%s===0||r.extendedCss?i.push(t):i.push(", "))}i.length>0&&(i[i.length-1]=t);var o=[],h=i.join(""),c=l.join("\r\n");return h&&o.push(h),c&&o.push(c),o},_buildCssByRulesHits:function(t,i){for(var n=" { display: none!important; }\r\n",l=" { display: none!important; background-image: url('"+i+"/elemhidehit.png#",u=encodeURIComponent(";"),r="') !important;}\r\n",o=[],h=[],c=0;c<t.length;c++){var a=t[c];a.isInjectRule?h.push(this._getRuleCssSelector(a)):(o.push(this._getRuleCssSelector(a)),s.FilterUtils.isUserFilterRule(a)?o.push(n):(o.push(l),o.push(a.filterId),o.push(u),o.push(e.BaseFilterRule.escapeRule(a.ruleText)),o.push(r)))}var m=[],d=o.join(""),R=h.join("\r\n");return d&&m.push(d),R&&m.push(R),m},_getRuleCssSelector:function(e){return l&&!e.extendedCss&&i?"::content "+e.cssSelector:n?":root "+e.cssSelector:e.cssSelector},_getDomainsSource:function(e){var s;s=e.isInjectRule?e.whiteListRule?t.MASK_CSS_EXCEPTION_INJECT_RULE:t.MASK_CSS_INJECT_RULE:e.whiteListRule?t.MASK_CSS_EXCEPTION_RULE:t.MASK_CSS_RULE;var i=e.ruleText.indexOf(s);return i<0?null:e.ruleText.substring(0,i).replace(/,~[^,]+/g,"").replace(/^~[^,]+,?/,"").toLowerCase()},_arrayToMap:function(e,s){for(var t=Object.create(null),i=0;i<e.length;i++){var n=e[i],l=n[s];l in t||(t[l]=[]),t[l].push(n)}return t}}}(yiclearAPI,vAPI);