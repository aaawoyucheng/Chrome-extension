!function(t,e){"use strict";t.FilteringLog=function(i,n,s){var a=e.EventNotifier,r=e.UrlUtils,o=e.LogEvents;this.tabsInfo=new i,this.framesMap=n,this.UI=s,this.lastTabId=1,this.openedFilteringLogsPage=0,this.REQUESTS_SIZE_PER_TAB=1e3,this.synchronizeOpenTabs=function(e){var i=function(t){for(var i=this.tabsInfo.collection().slice(0),n=0;n<t.length;n++){var s=t[n],a=this.tabsInfo.get(s);a?this.updateTab(s):this.addTab(s);var r=i.indexOf(a);r>=0&&i.splice(r,1)}for(var o=0;o<i.length;o++)this.removeTab(i[o].tab);if("function"==typeof e){var f=[];for(var l in this.tabsInfo.tabsById)f.push(this.tabsInfo.tabsById[l].value);e(f)}}.bind(this);t.UI.getAllOpenedTabs(i)},this.clearEventsForTab=function(t){var i=this.tabsInfo.get(t);i&&(delete i.filteringEvents,a.notifyListeners(e.LogEvents.TAB_RESET,this.serializeTabInfo(i)))},this.addTab=function(t){var i=this._updateTabInfo(t);i&&a.notifyListeners(e.LogEvents.TAB_ADDED,this.serializeTabInfo(i))},this.removeTab=function(t){var i=this.tabsInfo.get(t);i&&a.notifyListeners(e.LogEvents.TAB_CLOSE,this.serializeTabInfo(i)),this.tabsInfo.remove(t)},this.updateTab=function(t){var i=this._updateTabInfo(t);i&&a.notifyListeners(e.LogEvents.TAB_UPDATE,this.serializeTabInfo(i))},this._updateTabInfo=function(t){var e=this.tabsInfo.get(t)||Object.create(null);return e.tabId||(e.tabId=this.lastTabId++),e.tab=t,e.isHttp=r.isHttpRequest(t.url),this.tabsInfo.set(t,e),e},this.reloadTabById=function(t){var e=this.getTabInfoById(t);e&&e.tab.reload()},this.getTabInfoById=function(t){for(var e=this.tabsInfo.collection(),i=0;i<e.length;i++)if(e[i].tabId==t)return e[i];return null},this.getTabFrameInfoById=function(t){var e=this.getTabInfoById(t);return e?this.framesMap.getFrameInfo(e.tab):null},this.getTabInfo=function(t){var e=this.tabsInfo.get(t);return this.serializeTabInfo(e)},this.clearEventsForTab=function(t){var e=this.tabsInfo.get(t);e&&(delete e.filteringEvents,a.notifyListeners(o.TAB_RESET,this.serializeTabInfo(e)))},this.addEvent=function(e,i,n,s,f){if(0!=this.openedFilteringLogsPage){var l=this.tabsInfo.get(e);if(l){l.filteringEvents||(l.filteringEvents=[]);var h=r.getDomainName(i),g=r.getDomainName(n),b={requestUrl:i,requestDomain:h,frameUrl:n,frameDomain:g,requestType:s,requestThirdParty:r.isThirdPartyRequest(i,n),requestRule:f};f&&(b.requestRule=Object.create(null),b.requestRule.filterId=f.filterId,b.requestRule.ruleText=f.ruleText,b.requestRule.whiteListRule=f.whiteListRule),l.filteringEvents.push(b),l.filteringEvents.length>t.FilteringLog.REQUESTS_SIZE_PER_TAB&&l.filteringEvents.splice(1,1),a.notifyListeners(o.EVENT_ADDED,this.serializeTabInfo(l),b)}}},this.updateEvent=function(t,e,i){var n={requestUrl:e,loadTime:i};if(null!=t){var s=this.tabsInfo.get(t);s&&a.notifyListeners(o.EVENT_UPDATE,this.serializeTabInfo(s),n)}},this.clearEventsByTabId=function(t){var e=this.getTabInfoById(t);e&&(delete e.filteringEvents,a.notifyListeners(o.TAB_RESET,this.serializeTabInfo(e)))},this.onOpenFilteringLogPage=function(){this.openedFilteringLogsPage++},this.onCloseFilteringLogPage=function(){if(this.openedFilteringLogsPage=Math.max(this.openedFilteringLogsPage-1,0),0==this.openedFilteringLogsPage)for(var t=this.tabsInfo.collection(),e=0;e<t.length;e++)delete t[e].filteringEvents},this.serializeTabInfo=function(t){return t?{tabId:t.tabId,isHttp:t.isHttp,filteringEvents:t.filteringEvents,tab:{title:t.tab.title}}:null}}}(yiclearAPI,vAPI);