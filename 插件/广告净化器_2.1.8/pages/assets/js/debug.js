var PageController=function(){this.requestWizard=new RequestWizard},Messages={OPTIONS_USERFILTER:i18n.getMessage("options_userfilter"),OPTIONS_WHITELIST:i18n.getMessage("options_whitelist"),IN_WHITELIST:i18n.getMessage("filtering_log_in_whitelist")},StringUtils={startWith:function(e,t){return e&&0===e.indexOf(t)},containsIgnoreCase:function(e,t){return e&&t&&e.toUpperCase().indexOf(t.toUpperCase())>=0},substringAfter:function(e,t){if(!e)return e;var n=e.indexOf(t);return n<0?"":e.substring(n+t.length)},substringBefore:function(e,t){if(!e||!t)return e;var n=e.indexOf(t);return n<0?e:e.substring(0,n)}},UrlUtils={getDomainName:function(e){return e?(e=this.getUrlWithoutScheme(e),this.linkHelper||(this.linkHelper=document.createElement("a")),this.linkHelper.href="http://"+e,this.linkHelper.hostname):null},getUrlWithoutScheme:function(e){var t=e.indexOf("//");return t>=0?e=e.substring(t+2):(t=e.indexOf(":"),t>=0&&(e=e.substring(t+1))),StringUtils.startWith(e,"www.")?e.substring(4):e},isHierarchicUrl:function(e){return e.indexOf("//")!==-1}},FilterRule={MASK_WHITE_LIST:"@@"},UrlFilterRule={MASK_START_URL:"||",MASK_ANY_SYMBOL:"*",MASK_SEPARATOR:"^",DOMAIN_OPTION:"domain",MATCH_CASE_OPTION:"match-case",THIRD_PARTY_OPTION:"third-party",OPTIONS_DELIMITER:"$"};PageController.prototype={init:function(){this.logTable=$("#logTable"),this.logTableEmpty=$("#logTableEmpty"),this.logTableHidden=!0,this.tabSelector=$("#tabSelector"),this.tabSelectorValue=this.tabSelector.find(".task-manager-header-dropdown-select-text"),this.tabSelectorList=this.tabSelector.find(".task-manager-header-dropdown-select-list"),this.logoIcon=$("#logoIcon"),this.tabSelectorValue.dropdown(),this.tabSelector.on("show.bs.dropdown",function(){this.tabSelector.addClass("opened")}.bind(this)),this.tabSelector.on("hide.bs.dropdown",function(){this.tabSelector.removeClass("opened")}.bind(this)),this.tabSelectorList.on("click","div",function(e){var t=$(e.currentTarget);document.location.hash="#"+t.attr("data-tab-id")}.bind(this)),$(window).on("hashchange",function(){this._updateTabIdFromHash(),this.onSelectedTabChange()}.bind(this)),this.searchRequest=null,this.searchTypes=[],this.searchThirdParty=!1,this.searchBlocked=!1,this.searchWhitelisted=!1,$(".task-manager").on("click",".reloadTab",function(e){e.preventDefault(),contentPage.sendMessage({type:"reloadTabById",tabId:this.currentTabId})}.bind(this)),$("#clearTabLog").on("click",function(e){e.preventDefault(),contentPage.sendMessage({type:"clearEventsByTabId",tabId:this.currentTabId})}.bind(this));var e=this;this.logTable.on("click",".task-manager-content-header-body-row",function(){var t=$(this).data();contentPage.sendMessage({type:"getTabFrameInfoById",tabId:e.currentTabId},function(n){var a=n.frameInfo;a&&e.requestWizard.showRequestInfoModal(a,t)})}),this._bindSearchFilters(),this._updateTabIdFromHash(),contentPage.sendMessage({type:"synchronizeOpenTabs"},function(e){for(var t=e.tabs,n=0;n<t.length;n++)this.onTabUpdated(t[n]);this.onSelectedTabChange()}.bind(this))},_updateTabIdFromHash:function(){if(document.location.hash){var e=document.location.hash.substring(1);e&&(this.currentTabId=e)}},onTabAdded:function(e){e.isHttp&&(this.tabSelectorList.append($("<div>",{class:"task-manager-header-dropdown-select-list-item",text:e.tab.title,"data-tab-id":e.tabId})),this.currentTabId||this.onSelectedTabChange())},onTabUpdated:function(e){var t=this.tabSelectorList.find("[data-tab-id="+e.tabId+"]");return e.isHttp?void(t&&t.length>0?(t.text(e.tab.title),e.tabId==this.currentTabId&&(this.tabSelectorValue.text(e.tab.title),this._updateLogoIcon())):this.onTabAdded(e)):void this.onTabClose(e)},onTabClose:function(e){this.tabSelectorList.find("[data-tab-id="+e.tabId+"]").remove(),this.currentTabId==e.tabId&&(this.currentTabId=null,this.onSelectedTabChange())},onTabReset:function(e){this.currentTabId==e.tabId&&(this.logTable.empty(),this._onEmptyTable())},onEventAdded:function(e,t){this.currentTabId==e.tabId&&this._renderEvents([t])},onEventUpdate:function(e,t){this.currentTabId==e.tabId&&this._UpdateTime([t])},_UpdateTime:function(e){if(!e||0==e.length)return void this._onEmptyTable();for(var t=this.logTable.find(".task-manager-content-header-body-row"),n=!1,a=0;a<t.length;a++){for(var r=$(t[a]).find(".task-manager-content-item-url").text(),i=0;i<e.length;i++)if(r==e[i].requestUrl){$(t[a]).find(".task-manager-content-item-time").text(e[i].loadTime+"ms"),n=!0;break}if(n)break}},onSelectedTabChange:function(){var e=this.tabSelectorList.find('[data-tab-id="'+this.currentTabId+'"]');0==e.length&&(e=this.tabSelectorList.find(":first"));var t="",n=null;e.length>0&&(t=e.text(),n=e.attr("data-tab-id")),this.currentTabId=n,this.tabSelectorValue.text(t),this._updateLogoIcon(),this._renderEventsForTab(this.currentTabId)},_updateLogoIcon:function(){contentPage.sendMessage({type:"getTabFrameInfoById",tabId:this.currentTabId},function(e){var t=e.frameInfo,n="../icons/new-26.png";t&&(n="../icons/new-26.png"),this.logoIcon.attr("src",n)}.bind(this))},_bindSearchFilters:function(){var e=this;$('[name="searchEventRequest"]').on("keyup",function(){e.searchRequest=this.value.trim(),e._filterEvents()});var t=$(".searchEventType");t.on("click",function(n){n.preventDefault(),t.parent().removeClass("active");var a=$(n.currentTarget);a.parent().addClass("active");var r=a.attr("attr-type");e.searchTypes=r?r.split(","):[],e._filterEvents()}),$('[name="searchEventThirdParty"]').on("change",function(){e.searchThirdParty=this.checked,e._filterEvents()}),$('[name="searchEventBlocked"]').on("change",function(){e.searchBlocked=this.checked,e._filterEvents()}),$('[name="searchEventWhitelisted"]').on("change",function(){e.searchWhitelisted=this.checked,e._filterEvents()})},_filterEvents:function(){var e=this.logTable.children();if(!(this.searchRequest||0!=this.searchTypes.length||this.searchThirdParty||this.searchBlocked||this.searchWhitelisted))return void e.removeClass("hidden");var t=this;$.each(e,function(){t._handleEventShow($(this))})},_onEmptyTable:function(){this.logTableHidden=!0,this.logTable.addClass("hidden"),this.logTableEmpty.removeClass("hidden")},_onNotEmptyTable:function(){this.logTableHidden&&(this.logTableHidden=!1,this.logTableEmpty.addClass("hidden"),this.logTable.removeClass("hidden"))},_renderEventsForTab:function(e){this.logTable.empty(),contentPage.sendMessage({type:"getTabInfoById",tabId:e},function(e){var t=e.tabInfo,n=[];t&&(n=t.filteringEvents||[]),this._renderEvents(n)}.bind(this))},_renderEvents:function(e){if(!e||0==e.length)return void this._onEmptyTable();for(var t=[],n=0;n<e.length;n++){var a=this._renderTemplate(e[n]);this._handleEventShow(a),t.push(a)}this._onNotEmptyTable(),this.logTable.append(t)},_renderTemplate:function(e){var t={data:e,class:"task-manager-content-header-body-row cf"};e.requestRule&&(t.class+=e.requestRule.whiteListRule?" green":" red");var n="";e.requestRule&&(n=e.requestRule.filterId===AntiBannerFiltersId.WHITE_LIST_FILTER_ID?Messages.IN_WHITELIST:e.requestRule.ruleText);var a="task-manager-content-header-body-col task-manager-content-item-type";e.requestThirdParty&&(a+=" third-party");var r=$("<div>",t);r.append($("<div>",{text:e.requestUrl,class:"task-manager-content-header-body-col task-manager-content-item-url"})),r.append($("<div>",{text:RequestWizard.getRequestType(e.requestType),class:a})),r.append($("<div>",{text:n,class:"task-manager-content-header-body-col task-manager-content-item-rule"})),r.append($("<div>",{text:RequestWizard.getSource(e.frameDomain),class:"task-manager-content-header-body-col task-manager-content-item-source"}));var i=e.loadTime||"0";return r.append($("<div>",{text:i+"ms",class:"task-manager-content-header-body-col task-manager-content-item-time"})),r},_handleEventShow:function(e){var t=e.data(),n=!this.searchRequest||StringUtils.containsIgnoreCase(t.requestUrl,this.searchRequest);n&=0==this.searchTypes.length||this.searchTypes.indexOf(t.requestType)>=0;var a=!(this.searchWhitelisted||this.searchBlocked||this.searchThirdParty);a|=this.searchWhitelisted&&t.requestRule&&t.requestRule.whiteListRule,a|=this.searchBlocked&&t.requestRule&&!t.requestRule.whiteListRule,a|=this.searchThirdParty&&t.requestThirdParty,n&=a,n?e.removeClass("hidden"):e.addClass("hidden")}};var RequestWizard=function(){this.requestInfoTemplate=$("#modal-request-info"),this.createBlockRuleTemplate=$("#modal-create-block-rule"),this.createExceptionRuleTemplate=$("#modal-create-exception-rule")};RequestWizard.getFilterName=function(e){if(e==AntiBannerFiltersId.USER_FILTER_ID)return Messages.OPTIONS_USERFILTER;if(e==AntiBannerFiltersId.WHITE_LIST_FILTER_ID)return Messages.OPTIONS_WHITELIST;var t=filtersMetadata.filter(function(t){return t.filterId==e})[0];return t.title=t.title||t.name,t?t.title:""},RequestWizard.prototype.showModal=function(e){$(document.body).append(e),e.show(),e.modal(),e.on("hidden.bs.modal",function(){$(this).remove()}),this.currentModal=e},RequestWizard.prototype.closeModal=function(){this.currentModal&&(this.currentModal.modal("hide"),this.currentModal=null)},RequestWizard.prototype.showRequestInfoModal=function(e,t){var n=this.requestInfoTemplate.clone(),a=t.requestRule;if(n.find('[attr-text="requestUrl"]').text(t.requestUrl),n.find('[attr-text="requestType"]').text(RequestWizard.getRequestType(t.requestType)),n.find('[attr-text="frameDomain"]').text(RequestWizard.getSource(t.frameDomain)),t.frameDomain&&null!=t.frameDomain||n.find('[attr-text="frameDomain"]').closest(".adg-modal-window-locking-info-left-row").hide(),a?(a.filterId!=AntiBannerFiltersId.WHITE_LIST_FILTER_ID?n.find('[attr-text="requestRule"]').text(a.ruleText):n.find('[attr-text="requestRule"]').closest(".adg-modal-window-locking-info-left-row").hide(),n.find('[attr-text="requestRuleFilter"]').text(RequestWizard.getFilterName(a.filterId))):(n.find('[attr-text="requestRule"]').closest(".adg-modal-window-locking-info-left-row").hide(),n.find('[attr-text="requestRuleFilter"]').closest(".adg-modal-window-locking-info-left-row").hide()),"IMAGE"==t.requestType){n.removeClass("compact-view");var r=n.find('[attr-src="requestUrl"]'),i=new Image;i.src=t.requestUrl,i.onload=function(){var e=this.width,n=this.height;e>1&&n>1&&(r.attr("src",t.requestUrl),r.parent().show())}}n.find("#openRequestNewTab").on("click",function(e){e.preventDefault(),contentPage.sendMessage({type:"openTab",url:t.requestUrl,options:{inNewWindow:!0}})});var s=n.find("#blockRequest"),o=n.find("#unblockRequest"),l=n.find("#removeWhiteListDomain"),d=n.find("#removeUserFilterRule");s.on("click",function(n){n.preventDefault(),this.closeModal(),this.showCreateBlockRuleModal(e,t)}.bind(this)),o.on("click",function(n){n.preventDefault(),this.closeModal(),this.showCreateExceptionRuleModal(e,t)}.bind(this)),l.on("click",function(t){t.preventDefault(),contentPage.sendMessage({type:"unWhiteListFrame",frameInfo:e}),this.closeModal()}.bind(this)),d.on("click",function(e){e.preventDefault(),contentPage.sendMessage({type:"removeUserFilter",text:a.ruleText}),this.closeModal()}.bind(this)),a?a.filterId==AntiBannerFiltersId.USER_FILTER_ID?d.removeClass("hidden"):a.filterId==AntiBannerFiltersId.WHITE_LIST_FILTER_ID?l.removeClass("hidden"):a.whiteListRule||o.removeClass("hidden"):s.removeClass("hidden"),this.showModal(n)},RequestWizard.prototype.showCreateBlockRuleModal=function(e,t){var n=this.createBlockRuleTemplate.clone(),a=RequestWizard.splitToPatterns(t.requestUrl,UrlFilterRule.MASK_START_URL).reverse();this._initCreateRuleDialog(e,n,a,t.frameDomain,t.requestThirdParty)},RequestWizard.prototype.showCreateExceptionRuleModal=function(e,t){var n=this.createExceptionRuleTemplate.clone(),a=FilterRule.MASK_WHITE_LIST+UrlFilterRule.MASK_START_URL,r=RequestWizard.splitToPatterns(t.requestUrl,a).reverse();this._initCreateRuleDialog(e,n,r,t.frameDomain,t.requestThirdParty)},RequestWizard.prototype._initCreateRuleDialog=function(e,t,n,a,r){function i(){var e=u.filter(":checked").val(),t=!h.is(":checked"),n=T.is(":checked"),r=f.is(":checked"),i=RequestWizard.createRuleFromParams(e,a,t,n,r);g.val(i)}for(var s=t.find("#rulePatterns"),o=0;o<n.length;o++){var l=$("<div>",{class:"radio radio-patterns"}),d=$("<input>",{class:"radio-input",type:"radio",name:"rulePattern",id:"pattern"+o,value:n[o]}),c=$("<label>",{class:"radio-label",for:"pattern"+o}).append($("<span>",{class:"radio-icon"})).append($("<span>",{class:"radio-label-text",text:n[o]}));l.append(d),l.append(c),s.append(l),0==o&&d.attr("checked","checked")}var u=t.find('[name="rulePattern"]'),h=t.find('[name="ruleDomain"]'),T=t.find('[name="ruleMatchCase"]'),f=t.find('[name="ruleThirdParty"]'),g=t.find('[name="ruleText"]');h.attr("id","ruleDomain"),h.parent().find("label").attr("for","ruleDomain"),a&&null!=a||h.closest(".checkbox").hide(),T.attr("id","ruleMatchCase"),T.parent().find("label").attr("for","ruleMatchCase"),f.attr("id","ruleThirdParty"),f.parent().find("label").attr("for","ruleThirdParty"),r&&f.attr("checked","checked"),h.on("change",i),T.on("change",i),f.on("change",i),u.on("change",i),t.find("#createRule").on("click",function(e){e.preventDefault();var t=g.val();t&&(contentPage.sendMessage({type:"addUserFilterRule",text:t}),this.closeModal())}.bind(this)),i(),this.showModal(t)},RequestWizard.PATTERNS_COUNT=2,RequestWizard.splitToPatterns=function(e,t){var n=UrlUtils.getDomainName(e),a=[],r=StringUtils.substringAfter(e,n+"/"),i=StringUtils.substringBefore(r,"?");if(i){for(var s=i.split("/"),o=n+"/",l=0;l<Math.min(s.length-1,RequestWizard.PATTERNS_COUNT);l++)o+=s[l]+"/",a.push(t+o+UrlFilterRule.MASK_ANY_SYMBOL);var d=s[s.length-1];d&&a.length<RequestWizard.PATTERNS_COUNT&&(o+=d,a.push(t+o))}a.unshift(t+n+UrlFilterRule.MASK_SEPARATOR);var c=StringUtils.substringAfter(e,"//");return StringUtils.startWith(c,"www.")&&(c=c.substring(4)),a.indexOf(t+c)<0&&a.push(t+c),a},RequestWizard.createRuleFromParams=function(e,t,n,a,r){var i=e,s=[];return n&&t&&s.push(UrlFilterRule.DOMAIN_OPTION+"="+t),a&&s.push(UrlFilterRule.MATCH_CASE_OPTION),r&&s.push(UrlFilterRule.THIRD_PARTY_OPTION),s.length>0&&(i+=UrlFilterRule.OPTIONS_DELIMITER+s.join(",")),i},RequestWizard.getRequestType=function(e){switch(e){case"DOCUMENT":case"SUBDOCUMENT":return"HTML";case"STYLESHEET":return"CSS";case"SCRIPT":return"JavaScript";case"XMLHTTPREQUEST":return"Ajax";case"IMAGE":return"Image";case"OBJECT":case"OBJECT-SUBREQUEST":case"MEDIA":return"Media";case"FONT":return"Font";case"WEBSOCKET":return"WebSocket";case"WEBRTC":return"WebRTC";case"OTHER":return"Other"}return""},RequestWizard.getSource=function(e){return e||""};var userSettings,enabledFilters,environmentOptions,AntiBannerFiltersId,EventNotifierTypes,LogEvents,filtersMetadata;contentPage.sendMessage({type:"initializeFrameScript"},function(e){userSettings=e.userSettings,enabledFilters=e.enabledFilters,filtersMetadata=e.filtersMetadata,environmentOptions=e.environmentOptions,AntiBannerFiltersId=e.constants.AntiBannerFiltersId,EventNotifierTypes=e.constants.EventNotifierTypes,LogEvents=e.constants.LogEvents,$(document).ready(function(){function e(e,n,a){switch(e){case LogEvents.TAB_ADDED:t.onTabAdded(n);break;case LogEvents.TAB_UPDATE:t.onTabUpdated(n);break;case LogEvents.TAB_CLOSE:t.onTabClose(n);break;case LogEvents.TAB_RESET:t.onTabReset(n);break;case LogEvents.EVENT_ADDED:t.onEventAdded(n,a);break;case LogEvents.EVENT_UPDATE:t.onEventUpdate(n,a)}}var t=new PageController,n=[LogEvents.TAB_ADDED,LogEvents.TAB_UPDATE,LogEvents.TAB_CLOSE,LogEvents.TAB_RESET,LogEvents.EVENT_ADDED,LogEvents.EVENT_UPDATE];contentPage.sendMessage({type:"onOpenFilteringLogPage"});var a;contentPage.sendMessage({type:"addEventListener",events:n},function(e){a=e.listenerId}),contentPage.onMessage.addListener(function(t){"notifyListeners"==t.type&&e.apply(this,t.args)});var r=function(){a&&(contentPage.sendMessage({type:"removeListener",listenerId:a}),contentPage.sendMessage({type:"onCloseFilteringLogPage"}),a=null)};$(window).on("beforeunload",r),$(window).on("unload",r),t.init()})});