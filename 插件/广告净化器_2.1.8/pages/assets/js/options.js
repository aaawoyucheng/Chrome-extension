var yiclearPage=self.yiclearPage=self.yiclearPage||{};yiclearPage.optionsController=function(){},yiclearPage.defaultID=111,yiclearPage.optionsController.prototype={DEFAULT_LIMIT:20,omitRenderEventsCount:0,linkHelper:null,SUBSCRIPTIONS_LIMIT:9,init:function(){this.linkHelper=document.createElement("a"),this._bindEvents();setTimeout(function(){},100)},showPageStatisticsChange:function(){contentPage.sendMessage({type:"changeUserSetting",key:userSettings.names.DISABLE_SHOW_PAGE_STATS,value:!this.checked})},_bindEvents:function(){this.block_body_filters=$("#options-filters"),this.block_body_userRules=$("#options-userRules"),this.block_body_passDomain=$("#options-passDomain"),this.block_body_settings=$("#options-settings"),this.importUserFilterInput=$("#importUserFilterInput"),this.importWhiteListFilterInput=$("#importWhiteListFilterInput"),this.importConfigInput=$("#importConfigInput"),this.block_body_filters_input=$("#user-filter-search"),this.block_body_filters_list=$("#options-userRules select"),this.block_body_filters_clear=$("#clearUserFilter"),this._renderUserFilters(),this._renderWhiteDomains(),this._renderBlockFilters(),this._rebderSettings(),$("#importUserFilter").on("click",this.onImportUserFilterClicked.bind(this)),this.importUserFilterInput.on("change",this.onImportUserFilterInputChange.bind(this)),$("#importWhiteListFilter").on("click",this.onImportWhiteListFilterClicked.bind(this)),this.importWhiteListFilterInput.on("change",this.onImportWhiteListFilterInputChange.bind(this)),$("#importConfig").on("click",this.onImportConfigClicked.bind(this)),this.importConfigInput.on("change",this.onImportConfigInputChange.bind(this)),this._onbind(),this._initSearch(this.block_body_filters_input,this.block_body_filters_list,this._renderUserFilters)},_onbind:function(){$("#user-filter-search").bind("keypress",this._onuserfilterInput),$("#user-pass-search").bind("keypress",this._onpassdomainInput),$("#options-userRules  .button-options").bind("click",function(){var e=$(this).text();if("删除选中项"==e){var t=$("#options-userRules select").find("option:selected");if(t.length>0){for(var n=0;n<t.length;n++)""!=t[n].text&&contentPage.sendMessage({type:"removeUserFilter",text:t[n].text},function(e){});$("#user-filter-search").val("")}}}),$("#addfilterModal .button-small").bind("click",function(){var e=$("#addfilterModal input").val().replace(/[\r\n]/g,"");"http://"!=e&&"http://"!=e&&""!=e&&contentPage.sendMessage({type:"addfilterUrl",url:e},function(e){$("#addfilterModal").modal("hide"),$("#filterupdate").modal({keyboard:!1}),$("#filterupdate").modal("show"),$("#filterupdate h4").text("订阅组添加中...")}.bind(this))}),$("#addfilterModal a").bind("click",function(e){var t=e.target,n=t.text,i=$("#addfilterModal input");"国内网站规则"==n?i.val("https://easylist-downloads.adblockplus.org/easylistchina.txt"):"国外网站规则"==n?i.val("https://easylist.to/easylist/easylist.txt"):"恶意软件规则"==n?i.val("https://easylist-downloads.adblockplus.org/malwaredomains_full.txt"):"baidu美化规则"==n?i.val("http://tools.yiclear.com/baidu-lite.txt"):"卡饭论坛{乘风}规则"==n?i.val("https://raw.githubusercontent.com/xinggsf/Adblock-Plus-Rule/master/ABP-FX.txt"):"Fanboy's规则"==n&&i.val("https://fanboy.co.nz/r/fanboy-ultimate.txt")}),$("#addfilterModal").on("show.bs.modal",function(e){var t=$(this);t.find(".modal-body input").val("http://")});var e=[],t=-1;$(".row.tableHeader").on("click","a",function(){for(var n=$("#options-filters .tablebody").find("a"),i=0;i<n.length;i++)"更新"==$(n[i]).text()&&e.push($(n[i]).attr("aria-controls"));e.length>0&&(t=0,$("#filterupdate").modal({keyboard:!1}),$("#filterupdate").modal("show"),$("#filterupdate h4").text("规则更新中..."),contentPage.sendMessage({type:"updatefilterUrl",filterId:e[t]})),$("#filterupdate").on("hidden.bs.modal",function(){t!==-1&&t<e.length-1?(t+=1,$("#filterupdate").modal({keyboard:!1}),$("#filterupdate").modal("show"),$("#filterupdate h4").text("规则更新中..."),contentPage.sendMessage({type:"updatefilterUrl",filterId:e[t]})):(t=-1,e=[])})}),$("#options-filters .tablebody").on("click","a",function(){var e=$(this).attr("aria-controls"),t=$(this).text();"删除"==t?Number(e)!=yiclearPage.defaultID?($("#filterupdate").modal({keyboard:!1}),$("#filterupdate").modal("show"),$("#filterupdate h4").text("规则删除中..."),contentPage.sendMessage({type:"removeBlockFilter",filterId:e})):($("#filterupdate").modal({keyboard:!1}),$("#filterupdate").modal("show"),$("#filterupdate h4").text("默认规则不能删除！")):"启动"==t?($("#filterupdate").modal({keyboard:!1}),$("#filterupdate").modal("show"),$("#filterupdate h4").text("规则启动中..."),contentPage.sendMessage({type:"enableBlockFilter",filterId:e})):"停止"==t?($("#filterupdate").modal({keyboard:!1}),$("#filterupdate").modal("show"),$("#filterupdate h4").text("规则停止中..."),contentPage.sendMessage({type:"disableBlockFilter",filterId:e})):"更新"==t&&($("#filterupdate").modal({keyboard:!1}),$("#filterupdate").modal("show"),$("#filterupdate h4").text("规则更新中..."),contentPage.sendMessage({type:"updatefilterUrl",filterId:e}))}),$("#options-userRules .button-link").bind("click",function(){var e=$(this).text();"清空"==e?contentPage.sendMessage({type:"clearUserFilter"}):"导出"==e&&contentPage.sendMessage({type:"openExportRulesTab",filename:"rules.txt"})}),$("#options-userRules select").bind("click",function(){var e=$("#options-userRules select").find("option:selected").text();$("#user-filter-search").val(e)}),$("#options-passDomain select").bind("click",function(){var e=$("#options-passDomain select").find("option:selected").text();$("#user-pass-search").val(e)}),$("#options-passDomain  .button-options").bind("click",function(){var e=$(this).text();if("删除选中项"==e){var t=$("#options-passDomain select").find("option:selected");if(t.length>0)for(var n=0;n<t.length;n++)""!=t[n].text&&contentPage.sendMessage({type:"removeWhiteListDomain",text:t[n].text})}}),$("#options-passDomain .button-link").bind("click",function(){var e=$(this).text();"清空"==e?contentPage.sendMessage({type:"clearWhiteListFilter"}):"导出"==e&&contentPage.sendMessage({type:"openExportRulesTab",filename:"whitelist.txt"})}),$(".options-css-checkbox-input").bind("change",function(){var e=$(this).is(":checked"),t=$(this).attr("id");"autoupdate"==t?contentPage.sendMessage({type:"changeUserSetting",key:userSettings.names.DISABLE_AUTOUPDATE,value:!e}):"shouldShowBlockElementMenu"==t?contentPage.sendMessage({type:"changeUserSetting",key:userSettings.names.DISABLE_SHOW_CONTEXT_MENU,value:!e}):"shouldShowIcon"==t?contentPage.sendMessage({type:"changeUserSetting",key:userSettings.names.DISABLE_SHOW_ICON,value:!e}):"Developer"==t?contentPage.sendMessage({type:"changeUserSetting",key:userSettings.names.DISABLE_DEVELOPER,value:!e}):"YoukuDanmu"==t?contentPage.sendMessage({type:"changeUserSetting",key:userSettings.names.DISABLE_SHOW_YOUKU_DANMU,value:!e}):"UpdateFirstRun"==t&&contentPage.sendMessage({type:"changeUserSetting",key:userSettings.names.DISABLE_UPDATE_FIRSTRUN,value:!e}),console.log(t)}),$("#options-settings .button").bind("click",function(){var e=$(this).text();"清空"==e?(contentPage.sendMessage({type:"resetBlockedAdsCount"}),contentPage.sendMessage({type:"getBlockedCount"},function(e){$("#options-block-count").text("广告过滤数："+e.BlockedCount)})):"备份"==e&&contentPage.sendMessage({type:"openExportRulesTab",filename:"config.txt"})}),$("#options-help a").bind("click",function(){var e=$(this).text();"查看"==e?contentPage.sendMessage({type:"openissue"}):"反馈"==e&&contentPage.sendMessage({type:"openfeedback"})})},_importWhiteListFilterRules:function(e){var t=e?e.split(/[\r\n]+/):[];contentPage.sendMessage({type:"addWhiteListDomains",domains:t})},onImportWhiteListFilterInputChange:function(){var e=this.importWhiteListFilterInput[0],t=new FileReader;t.onload=function(t){try{this._importWhiteListFilterRules(t.target.result)}catch(e){Log.error("Error while loading whitelist rules {0}",e)}e.value=""}.bind(this),t.onerror=function(){Log.error("Error load whitelist rules"),e.value=""};var n=e.files[0];n&&t.readAsText(n,"utf-8")},onImportWhiteListFilterClicked:function(e){this.importWhiteListFilterInput.trigger("click")},onImportConfigClicked:function(e){this.importConfigInput.trigger("click")},_importConfigsRules:function(e){contentPage.sendMessage({type:"setConfigs",configs:e})},onImportConfigInputChange:function(){var e=this.importConfigInput[0],t=new FileReader;t.onload=function(t){try{this._importConfigsRules(t.target.result)}catch(e){Log.error("Error while loading whitelist rules {0}",e)}e.value=""}.bind(this),t.onerror=function(){Log.error("Error load whitelist rules"),e.value=""};var n=e.files[0];n&&t.readAsText(n,"utf-8")},onImportUserFilterClicked:function(e){this.importUserFilterInput.trigger("click")},_importUserFilterRules:function(e){var t=e?e.split(/[\r\n]+/):[];contentPage.sendMessage({type:"addUserFilterRules",rules:t})},onImportUserFilterInputChange:function(){var e=this.importUserFilterInput[0],t=new FileReader;t.onload=function(t){try{this._importUserFilterRules(t.target.result)}catch(e){Log.error("Error while loading user rules {0}",e)}e.value=""}.bind(this),t.onerror=function(){Log.error("Error load user rules"),e.value=""};var n=e.files[0];n&&t.readAsText(n,"utf-8")},_onBlockFilterStateChange:function(e){},_onpassdomainInput:function(e){if("13"==e.keyCode){var t=$("#user-pass-search").val().trim().replace(/[\r\n\t]/g,"");contentPage.sendMessage({type:"addWhiteListDomain",text:t})}},_onuserfilterInput:function(e){if("13"==e.keyCode){var t=$("#user-filter-search").val().trim().replace(/[\r\n\t]/g,"");contentPage.sendMessage({type:"addUserFilterRule",text:t}),$("#user-filter-search").val("")}},_renderWhiteDomains:function(){var e=this.block_body_passDomain.find("select");e.empty(),contentPage.sendMessage({type:"getWhiteListDomains"},function(t){for(var n=0;n<t.rules.length;n++){var i=$("<option>").val(1).text(t.rules[n]);e.append(i)}}.bind(this))},_initSearch:function(e,t,n){e.on("keyup",this._debounce(n.bind(this),300)),t.scroll(function(){var e=t.height(),i=t.get(0).scrollHeight,s=t.scrollTop();s/(i-e)>=.95&&n.call(this,!0)}.bind(this))},_renderSearchFilters:function(e,t,n,i,s,r,o){if(o=o===!0,o||(i.offset=0,i.allLoaded=!1),!this._isLoading&&!i.allLoaded){var a=e.val().trim();i.searchMode=a.length>0,contentPage.sendMessage({type:r,offset:i.offset,limit:i.limit,text:a},function(e){var n=e.rules;n.length<i.limit&&(i.allLoaded=!0),i.offset+=n.length,i._isLoading=!1,o||t.empty();for(var r=0;r<n.length;r++)s.call(this,n[r])}.bind(this))}},_renderUserFilter:function(e){var t=$("<option>").val(1).text(e);this.block_body_filters_list.append(t)},_renderUserFilters:function(e){this.userSearchResult||(this.userSearchResult={offset:0,limit:this.DEFAULT_LIMIT,allLoaded:!1}),this._renderSearchFilters(this.block_body_filters_input,this.block_body_filters_list,this.block_body_filters_clear,this.userSearchResult,this._renderUserFilter,"getUserFilters",e)},_renderBlockFilters:function(){$("#filterupdate").modal("hide");var e=this.block_body_filters.find(".tablebody");e.empty();for(var t=0;t<filtersMetadata.length;t++)filtersMetadata[t].installed&&(filtersMetadata[t].name=filtersMetadata[t].name||filtersMetadata[t].title,e.append(filters_template(filtersMetadata[t].filterId,filtersMetadata[t].name,filtersMetadata[t].lastUpdateTime,filtersMetadata[t].RuleCount,enabledFilters)))},_rebderSettings:function(){var e=userSettings.values[userSettings.names.DISABLE_AUTOUPDATE],t=userSettings.values[userSettings.names.DISABLE_SHOW_CONTEXT_MENU],n=userSettings.values[userSettings.names.DISABLE_SHOW_ICON],i=userSettings.values[userSettings.names.DISABLE_DEVELOPER],s=userSettings.values[userSettings.names.DISABLE_SHOW_YOUKU_DANMU],r=userSettings.values[userSettings.names.DISABLE_PROXY],o=userSettings.values[userSettings.names.DISABLE_UPDATE_FIRSTRUN];$("#shouldShowBlockElementMenu").attr("checked",!t),$("#autoupdate").attr("checked",!e),$("#shouldShowIcon").attr("checked",!n),$("#Developer").attr("checked",!i),$("#YoukuDanmu").attr("checked",!s),$("#Proxy").attr("checked",!r),$("#UpdateFirstRun").attr("checked",!o),$("#options-block-count").text("广告过滤数："+blockCount)},renderFilterRulesInfo:function(e){enabledFilters=[];for(var t=0;t<e.enabledFilters.length;t++)enabledFilters[e.enabledFilters[t].filterId]=!0,filtersMetadata.enabled=!0;contentPage.sendMessage({type:"getfiltersmetadata"},function(e){filtersMetadata=e.metadata,this._renderBlockFilters()}.bind(this))},_debounce:function(e,t){var n;return function(){var i=this,s=arguments,r=function(){n=null,e.apply(i,s)};clearTimeout(n),n=setTimeout(r,t)}}};var listenerId=null,onUnload=function(){listenerId&&(contentPage.sendMessage({type:"removeListener",listenerId:listenerId}),listenerId=null)},blockCount,userSettings,enabledFilters,environmentOptions,AntiBannerFiltersId,EventNotifierTypes,requestFilterInfo,contentBlockerInfo,filtersMetadata;contentPage.sendMessage({type:"initializeFrameScript"},function(e){blockCount=e.BlockedCount,userSettings=e.userSettings,enabledFilters=e.enabledFilters,environmentOptions=e.environmentOptions,requestFilterInfo=e.requestFilterInfo,contentBlockerInfo=e.contentBlockerInfo,filtersMetadata=e.filtersMetadata,AntiBannerFiltersId=e.constants.AntiBannerFiltersId,EventNotifierTypes=e.constants.EventNotifierTypes,$(document).ready(function(){function e(e,n){switch(e){case EventNotifierTypes.ENABLE_FILTER:case EventNotifierTypes.DISABLE_FILTER:t._onBlockFilterStateChange(n);break;case EventNotifierTypes.ADD_FILTER:case EventNotifierTypes.REMOVE_FILTER:t._renderBlockFilters();break;case EventNotifierTypes.START_DOWNLOAD_FILTER:break;case EventNotifierTypes.SUCCESS_DOWNLOAD_FILTER:case EventNotifierTypes.ERROR_DOWNLOAD_FILTER:break;case EventNotifierTypes.UPDATE_USER_FILTER_RULES:if(t.omitRenderEventsCount>0){t.omitRenderEventsCount--;break}t._renderUserFilters(),!environmentOptions.isContentBlockerEnabled;break;case EventNotifierTypes.UPDATE_WHITELIST_FILTER_RULES:if(t.omitRenderEventsCount>0){t.omitRenderEventsCount--;break}t._renderWhiteDomains();break;case EventNotifierTypes.REQUEST_FILTER_UPDATED:if(environmentOptions.isContentBlockerEnabled)break;t.renderFilterRulesInfo(n);break;case EventNotifierTypes.CONTENT_BLOCKER_UPDATED:t.renderFilterRulesInfo(n)}}var t=new yiclearPage.optionsController;t.init();var n,i=[EventNotifierTypes.ENABLE_FILTER,EventNotifierTypes.DISABLE_FILTER,EventNotifierTypes.ADD_FILTER,EventNotifierTypes.REMOVE_FILTER,EventNotifierTypes.START_DOWNLOAD_FILTER,EventNotifierTypes.SUCCESS_DOWNLOAD_FILTER,EventNotifierTypes.ERROR_DOWNLOAD_FILTER,EventNotifierTypes.UPDATE_USER_FILTER_RULES,EventNotifierTypes.UPDATE_WHITELIST_FILTER_RULES,EventNotifierTypes.CONTENT_BLOCKER_UPDATED,EventNotifierTypes.REQUEST_FILTER_UPDATED];contentPage.sendMessage({type:"addEventListener",events:i},function(e){n=e.listenerId}),contentPage.onMessage.addListener(function(t){"notifyListeners"==t.type&&e.apply(this,t.args)});var s=function(){n&&(contentPage.sendMessage({type:"removeListener",listenerId:n}),n=null)};$(window).on("beforeunload",s),$(window).on("unload",s)})});